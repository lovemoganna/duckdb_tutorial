import { CodeBlock } from './CodeBlock';
import { InfoBox } from './InfoBox';
import { Paragraph } from './Paragraph';
import { SQLExplainer } from './SQLExplainer';
import { SQLFlowDiagram } from './SQLFlowDiagram';
import { DataFlowAnimation } from './DataFlowAnimation';
import type { Note } from '../types';

interface SectionProps {
  sectionId: string;
  addNote: (sectionId: string, blockId: string, content: string) => void;
  updateNote: (id: string, content: string) => void;
  deleteNote: (id: string) => void;
  getNotesForBlock: (sectionId: string, blockId: string) => Note[];
}

// ============================================
// 鍒嗘瀽鍑芥暟杩涢樁绔犺妭
// ============================================

export function AdvancedAnalyticsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍒嗘瀽鍑芥暟杩涢樁</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"绐楀彛鍑芥暟鐨勯珮绾у簲鐢紝澶嶆潅鍒嗘瀽鐨勮В鍐虫柟妗?</p>

      <Paragraph {...noteProps('p1')}>
        闄や簡鍩烘湰鐨勬帓鍚嶅拰鑱氬悎绐楀彛鍑芥暟锛孌uckDB 杩樻敮鎸佹洿楂樼骇鐨勫垎鏋愬嚱鏁帮紝鍖呮嫭鍒嗗竷鍑芥暟銆佺嚎鎬у洖褰掋€佺粺璁℃楠岀瓑銆傝繖浜涘嚱鏁板彲浠ュ府鍔╂垜浠繘琛屾洿娣卞叆鐨勬暟鎹垎鏋愬拰缁熻寤烘ā銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒嗗竷鍒嗘瀽鍑芥暟</h3>

      <CodeBlock
        title="鐧惧垎浣嶆暟鍜屽垎浣嶆暟鍒嗘瀽"
        code={`-- PERCENTILE_CONT: 杩炵画鐧惧垎浣嶆暟
SELECT
    department,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY salary) AS q1_salary,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY salary) AS median_salary,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY salary) AS q3_salary,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY salary) -
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY salary) AS iqr
FROM employees
GROUP BY department;

-- PERCENTILE_DISC: 绂绘暎鐧惧垎浣嶆暟
SELECT
    PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY response_time) AS median_response,
    PERCENTILE_DISC(0.95) WITHIN GROUP (ORDER BY response_time) AS p95_response
FROM api_logs
WHERE created_at >= CURRENT_DATE - INTERVAL 7 DAY;

-- 鍒嗕綅鏁板洖褰掞紙鍥涘垎浣嶆暟鏂滅巼锛?
SELECT
    REGR_SLOPE(y, x) AS slope,
    REGR_INTERCEPT(y, x) AS intercept,
    REGR_R2(y, x) AS r_squared
FROM (
    SELECT
        NTILE(4) OVER (ORDER BY x) AS quartile,
        AVG(y) AS y,
        AVG(x) AS x
    FROM data_points
    GROUP BY NTILE(4) OVER (ORDER BY x)
) AS quartiles;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">绾挎€у洖褰掑垎鏋?/h3>

      <SQLExplainer
        sql={`-- 绠€鍗曠嚎鎬у洖褰?
SELECT
    'Salary vs Experience' AS analysis,
    REGR_COUNT(experience, salary) AS data_points,
    REGR_SLOPE(experience, salary) AS slope,
    REGR_INTERCEPT(experience, salary) AS intercept,
    REGR_R2(experience, salary) AS r_squared,
    REGR_AVGX(experience, salary) AS avg_experience,
    REGR_AVGY(experience, salary) AS avg_salary
FROM employees
WHERE salary IS NOT NULL AND experience IS NOT NULL;`}
        explanations={[
          { code: 'REGR_COUNT(x, y)', explanation: '鍥炲綊鍒嗘瀽涓娇鐢ㄧ殑鏈夋晥鏁版嵁鐐规暟閲?, tip: '鑷姩鎺掗櫎 NULL 鍊? },
          { code: 'REGR_SLOPE(x, y)', explanation: '鍥炲綊绾跨殑鏂滅巼锛岃〃绀?x 姣忓鍔?1 鍗曚綅 y 鐨勫彉鍖?, tip: '姝ｅ€艰〃绀烘鐩稿叧锛岃礋鍊艰〃绀鸿礋鐩稿叧' },
          { code: 'REGR_INTERCEPT(x, y)', explanation: '鍥炲綊绾跨殑鎴窛锛寈=0 鏃剁殑 y 鍊?, tip: '涓嶄竴瀹氭湁瀹為檯鎰忎箟' },
          { code: 'REGR_R2(x, y)', explanation: '鍐冲畾绯绘暟锛?-1 涔嬮棿锛岃秺鎺ヨ繎 1 鎷熷悎瓒婂ソ', tip: '瑙ｉ噴鍙橀噺瀵瑰洜鍙橀噺鐨勮В閲婄▼搴? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">缁熻妫€楠屽嚱鏁?/h3>

      <CodeBlock
        title="鐩稿叧鎬у垎鏋?
        code={`-- 鐨皵閫婄浉鍏崇郴鏁?
SELECT
    CORR(height, weight) AS height_weight_corr,
    CORR(age, income) AS age_income_corr,
    CORR(experience, performance) AS exp_perf_corr
FROM employees;

-- 鍗忔柟宸?
SELECT
    COVAR_POP(height, weight) AS pop_covariance,
    COVAR_SAMP(height, weight) AS sample_covariance
FROM measurements;

-- 鏂毊灏旀浖绛夌骇鐩稿叧绯绘暟锛堝鏋滄敮鎸侊級
-- 閫傜敤浜巓rdinal鏁版嵁鎴栭潪姝ｆ€佸垎甯冩暟鎹?
SELECT
    CORR(height, weight) AS pearson_corr,
    -- Spearman would need custom implementation
    CASE WHEN CORR(height, weight) > 0.7 THEN 'Strong correlation'
         WHEN CORR(height, weight) > 0.3 THEN 'Moderate correlation'
         ELSE 'Weak correlation' END AS interpretation
FROM data_pairs;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">绉诲姩缁熻涓庤秼鍔垮垎鏋?/h3>

      <CodeBlock
        title="鏃堕棿搴忓垪绉诲姩缁熻"
        code={`-- 绉诲姩骞冲潎鍜屾爣鍑嗗樊
SELECT
    date,
    sales,
    AVG(sales) OVER (
        ORDER BY date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_avg_7day,

    STDDEV(sales) OVER (
        ORDER BY date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_std_7day,

    -- 绉诲姩涓綅鏁帮紙鏇寸ǔ鍋ワ級
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY sales) OVER (
        ORDER BY date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_median_7day

FROM daily_sales
ORDER BY date;

-- 瓒嬪娍鍒嗘瀽锛氬勾鍚屾瘮澧為暱鐜?
SELECT
    year,
    total_sales,
    LAG(total_sales) OVER (ORDER BY year) AS prev_year_sales,
    (total_sales - LAG(total_sales) OVER (ORDER BY year)) /
    NULLIF(LAG(total_sales) OVER (ORDER BY year), 0) * 100 AS yoy_growth
FROM annual_sales
ORDER BY year;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">寮傚父鍊兼娴?/h3>

      <CodeBlock
        title="鍩轰簬缁熻鐨勫紓甯稿€兼娴?
        code={`-- 浣跨敤IQR鏂规硶妫€娴嬪紓甯稿€?
WITH stats AS (
    SELECT
        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY value) AS q1,
        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY value) AS q3,
        AVG(value) AS mean_val,
        STDDEV(value) AS std_val
    FROM measurements
),
outlier_bounds AS (
    SELECT
        q1 - 1.5 * (q3 - q1) AS lower_bound,
        q3 + 1.5 * (q3 - q1) AS upper_bound,
        mean_val - 3 * std_val AS lower_3sigma,
        mean_val + 3 * std_val AS upper_3sigma
    FROM stats
)
SELECT
    m.id,
    m.value,
    CASE
        WHEN m.value < ob.lower_bound OR m.value > ob.upper_bound THEN 'IQR Outlier'
        WHEN m.value < ob.lower_3sigma OR m.value > ob.upper_3sigma THEN '3-Sigma Outlier'
        ELSE 'Normal'
    END AS outlier_type,
    ob.*
FROM measurements m
CROSS JOIN outlier_bounds ob
ORDER BY ABS(m.value - ob.mean_val) DESC;`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鑱氱被鍒嗘瀽鍩虹</h3>

      <CodeBlock
        title="绠€鍗曡仛绫伙細鍩轰簬璺濈鐨勫垎绫?
        code={`-- K-means 鑱氱被棰勫鐞?
WITH normalized_data AS (
    SELECT
        id,
        (x - AVG(x) OVER ()) / NULLIF(STDDEV(x) OVER (), 0) AS x_norm,
        (y - AVG(y) OVER ()) / NULLIF(STDDEV(y) OVER (), 0) AS y_norm
    FROM data_points
),
-- 璁＄畻璺濈鐭╅樀锛堢畝鍖栫増锛氬彧璁＄畻鍒伴瀹氫箟涓績鐐圭殑璺濈锛?
distances AS (
    SELECT
        nd.id,
        nd.x_norm, nd.y_norm,
        -- 璁＄畻鍒颁腑蹇冪偣 (0,0) 鐨勮窛绂?
        SQRT(POWER(nd.x_norm - 0, 2) + POWER(nd.y_norm - 0, 2)) AS dist_to_center,
        -- 璁＄畻鍒颁腑蹇冪偣 (2,2) 鐨勮窛绂?
        SQRT(POWER(nd.x_norm - 2, 2) + POWER(nd.y_norm - 2, 2)) AS dist_to_cluster2
    FROM normalized_data nd
)
SELECT
    id,
    x_norm, y_norm,
    CASE WHEN dist_to_center <= dist_to_cluster2 THEN 1 ELSE 2 END AS cluster,
    LEAST(dist_to_center, dist_to_cluster2) AS min_distance
FROM distances
ORDER BY min_distance;`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="鍒嗘瀽鍑芥暟鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鏁版嵁璐ㄩ噺锛?/strong> 鍒嗘瀽鍓嶆鏌ユ暟鎹垎甯冨拰寮傚父鍊?/li>
          <li><strong>鏍锋湰澶у皬锛?/strong> 缁熻鍒嗘瀽闇€瑕佽冻澶熺殑鏍锋湰閲?/li>
          <li><strong>鐩稿叧鎬р墵鍥犳灉鎬э細</strong> 鐩稿叧绯绘暟涓嶈兘璇佹槑鍥犳灉鍏崇郴</li>
          <li><strong>鍙鍖栭獙璇侊細</strong> 鐢ㄥ浘琛ㄩ獙璇佺粺璁＄粨鏋滅殑鍚堢悊鎬?/li>
          <li><strong>鍋囪妫€楠岋細</strong> 閲嶈鐨勭粨璁洪渶瑕佺粺璁℃楠岄獙璇?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搱 涓氬姟鍒嗘瀽</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">閿€鍞秼鍔裤€佸鎴风粏鍒嗐€佸競鍦哄垎鏋愩€丷OI 璁＄畻</p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃敩 绉戝璁＄畻</h4>
          <p className="text-sm text-green-600 dark:text-green-400">瀹為獙鏁版嵁鍒嗘瀽銆佸洖褰掑缓妯°€佸亣璁炬楠?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搳 璐ㄩ噺鎺у埗</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">杩囩▼鎺у埗銆佸紓甯告娴嬨€佽川閲忔敼杩?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃 鏈哄櫒瀛︿範棰勫鐞?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鐗瑰緛宸ョ▼銆佹暟鎹爣鍑嗗寲銆佸紓甯稿€煎鐞?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 璁＄畻閿€鍞鐨勬椂闂村簭鍒楄秼鍔垮拰瀛ｈ妭鎬у垎鏋?/p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇鍩轰簬IQR鏂规硶鐨勫紓甯稿€兼娴嬬畻娉?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒嗘瀽涓嶅悓鍙橀噺涔嬮棿鐨勭浉鍏虫€у拰鏋勫缓澶氬厓鍥炲綊妯″瀷</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// LATERAL JOIN 绔犺妭
// ============================================

export function LateralJoinSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">LATERAL JOIN</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鍏宠仈鏌ヨ鐨勯珮绾ф妧宸э紝姣忎釜琛岄兘鏈夎嚜宸辩殑瀛愭煡璇?</p>

      <Paragraph {...noteProps('p1')}>
        LATERAL JOIN 鍏佽鍦?JOIN 瀛愬彞涓紩鐢ㄥ乏渚ц〃鐨勫垪锛岃繖浣垮緱鎴戜滑鍙互涓烘瘡涓€琛屾暟鎹墽琛屼笉鍚岀殑瀛愭煡璇€傜壒鍒€傜敤浜?TOP-N 鏌ヨ銆佺浉鍏冲瓙鏌ヨ浼樺寲銆佸姩鎬佹暟鎹叧鑱旂瓑澶嶆潅鍦烘櫙銆?
      </Paragraph>

      <DataFlowAnimation type="join" />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩烘湰璇硶</h3>

      <SQLExplainer
        sql={`-- LATERAL JOIN 鍩烘湰璇硶
SELECT
    u.user_id,
    u.user_name,
    p.product_name,
    p.purchase_date
FROM users u
LEFT JOIN LATERAL (
    SELECT product_name, purchase_date
    FROM purchases p
    WHERE p.user_id = u.user_id
    ORDER BY p.purchase_date DESC
    LIMIT 3
) p ON true;`}
        explanations={[
          { code: 'LATERAL (subquery)', explanation: '鍏佽瀛愭煡璇㈠紩鐢ㄥ乏渚ц〃鐨勫垪', tip: '瀛愭煡璇㈠彲浠ヨ闂?u.user_id' },
          { code: 'LEFT JOIN ... ON true', explanation: '浣跨敤 true 浣滀负杩炴帴鏉′欢锛屽洜涓?LATERAL 宸茬粡澶勭悊浜嗗叧鑱?, tip: '纭繚鍗充娇娌℃湁鍖归厤涔熻繑鍥炵敤鎴疯褰? },
          { code: 'ORDER BY ... LIMIT 3', explanation: '涓烘瘡涓敤鎴疯幏鍙栨渶杩?娆¤喘涔拌褰?, tip: 'LATERAL 浣胯繖涓搷浣滄垚涓哄彲鑳? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">TOP-N 鏌ヨ浼樺寲</h3>

      <CodeBlock
        title="姣忎釜缁勭殑 TOP-N 璁板綍"
        code={`-- 浼犵粺鏂规硶锛氫娇鐢ㄧ獥鍙ｅ嚱鏁?+ 瀛愭煡璇?
SELECT * FROM (
    SELECT
        department,
        employee_name,
        salary,
        ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn
    FROM employees
) ranked
WHERE rn <= 3;

-- 浣跨敤 LATERAL JOIN 鐨勬柟娉?
SELECT
    d.department_name,
    e.employee_name,
    e.salary
FROM departments d
LEFT JOIN LATERAL (
    SELECT employee_name, salary
    FROM employees e
    WHERE e.department_id = d.id
    ORDER BY e.salary DESC
    LIMIT 3
) e ON true
ORDER BY d.department_name, e.salary DESC;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍔ㄦ€佹暟鎹睍寮€</h3>

      <CodeBlock
        title="JSON 鏁版嵁灞曞紑"
        code={`-- 灞曞紑鐢ㄦ埛鍋忓ソ璁剧疆
SELECT
    u.user_id,
    u.user_name,
    prefs.key,
    prefs.value
FROM users u
LEFT JOIN LATERAL (
    SELECT
        UNNEST(ARRAY['theme', 'language', 'notifications']) AS key,
        UNNEST(ARRAY[
            u.theme_preference,
            u.language_preference,
            u.notification_settings
        ]) AS value
) prefs ON true;

-- 灞曞紑澶氬€煎睘鎬?
SELECT
    p.product_id,
    p.product_name,
    tags.tag_name
FROM products p
LEFT JOIN LATERAL (
    SELECT UNNEST(p.tags_array) AS tag_name
) tags ON true
WHERE tags.tag_name IS NOT NULL;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">澶嶆潅鍏宠仈鏌ヨ</h3>

      <CodeBlock
        title="鏈€杩戦偦鏌ヨ"
        code={`-- 涓烘瘡涓敤鎴锋壘鍒版渶杩戠殑3涓棬搴?
SELECT
    u.user_id,
    u.user_name,
    u.location_lat,
    u.location_lng,
    nearby_stores.store_name,
    nearby_stores.distance_km
FROM users u
LEFT JOIN LATERAL (
    SELECT
        s.store_name,
        -- 璁＄畻璺濈锛堢畝鍖栫増锛?
        SQRT(POWER(u.location_lat - s.lat, 2) +
             POWER(u.location_lng - s.lng, 2)) * 111 AS distance_km
    FROM stores s
    ORDER BY distance_km
    LIMIT 3
) nearby_stores ON true
ORDER BY u.user_id, nearby_stores.distance_km;`}
        {...noteProps('code3')}
      />

      <CodeBlock
        title="鏃堕棿搴忓垪鍏宠仈"
        code={`-- 涓烘瘡涓簨浠舵壘鍒板墠鍚庣殑涓婁笅鏂?
SELECT
    e.event_id,
    e.event_time,
    e.event_type,
    context.before_event,
    context.after_event
FROM events e
LEFT JOIN LATERAL (
    SELECT
        (SELECT event_type FROM events
         WHERE user_id = e.user_id
         AND event_time < e.event_time
         ORDER BY event_time DESC LIMIT 1) AS before_event,
        (SELECT event_type FROM events
         WHERE user_id = e.user_id
         AND event_time > e.event_time
         ORDER BY event_time ASC LIMIT 1) AS after_event
) context ON true
ORDER BY e.event_time;`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鎬ц兘瀵规瘮</h3>

      <CodeBlock
        title="LATERAL vs 浼犵粺鏂规硶"
        code={`-- 浼犵粺鏂规硶锛氱浉鍏冲瓙鏌ヨ锛堝彲鑳戒綆鏁堬級
SELECT
    u.user_id,
    u.user_name,
    (SELECT COUNT(*) FROM orders o WHERE o.user_id = u.user_id) AS order_count,
    (SELECT SUM(amount) FROM orders o WHERE o.user_id = u.user_id) AS total_amount,
    (SELECT MAX(order_date) FROM orders o WHERE o.user_id = u.user_id) AS last_order
FROM users u;

-- LATERAL 鏂规硶锛氭洿楂樻晥
SELECT
    u.user_id,
    u.user_name,
    stats.order_count,
    stats.total_amount,
    stats.last_order
FROM users u
LEFT JOIN LATERAL (
    SELECT
        COUNT(*) AS order_count,
        SUM(amount) AS total_amount,
        MAX(order_date) AS last_order
    FROM orders o
    WHERE o.user_id = u.user_id
) stats ON true;

-- 鑱氬悎鍚?JOIN 鏂规硶锛氬彟涓€绉嶄紭鍖栨柟寮?
SELECT
    u.user_id,
    u.user_name,
    COALESCE(stats.order_count, 0) AS order_count,
    COALESCE(stats.total_amount, 0) AS total_amount,
    stats.last_order
FROM users u
LEFT JOIN (
    SELECT
        user_id,
        COUNT(*) AS order_count,
        SUM(amount) AS total_amount,
        MAX(order_date) AS last_order
    FROM orders
    GROUP BY user_id
) stats ON u.user_id = stats.user_id;`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="LATERAL JOIN 浣跨敤寤鸿" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>閫傜敤鍦烘櫙锛?/strong> 宸︿晶琛ㄧ殑姣忎竴琛岄渶瑕佷笉鍚岀殑瀛愭煡璇㈢粨鏋?/li>
          <li><strong>鎬ц兘鑰冭檻锛?/strong> 瀵逛簬澶ф暟鎹泦锛岃€冭檻棰勮仛鍚堝悗 JOIN</li>
          <li><strong>鏇夸唬鏂规锛?/strong> 绐楀彛鍑芥暟鏈夋椂鍙互鏇夸唬 LATERAL</li>
          <li><strong>LEFT JOIN锛?/strong> 閫氬父涓?LEFT JOIN 閰嶅悎锛岀‘淇濇墍鏈夎閮借淇濈暀</li>
          <li><strong>绱㈠紩浼樺寲锛?/strong> 纭繚瀛愭煡璇腑鐨勮繛鎺ユ潯浠舵湁閫傚綋绱㈠紩</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃懃 鐢ㄦ埛琛屼负鍒嗘瀽</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鐢ㄦ埛鏈€杩戞椿鍔ㄣ€佽喘涔板亸濂姐€佽涓烘ā寮忓垎鏋?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搷 鍦扮悊浣嶇疆鍒嗘瀽</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鏈€杩戦偦鏌ユ壘銆佸湴鐞嗗洿鏍忋€佽窛绂昏绠?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">鈴?鏃堕棿搴忓垪澶勭悊</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">浜嬩欢涓婁笅鏂囥€佸墠鍚庡叧鑱斻€佹椂闂寸獥鍙ｅ垎鏋?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃搳 鍔ㄦ€佹姤琛?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">涓€у寲缁熻銆乀op-N 鍒嗘瀽銆佷氦鍙夐€忚</p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 涓烘瘡涓敤鎴风敓鎴愪釜鎬у寲鎺ㄨ崘鍒楄〃锛堝熀浜庣敤鎴峰巻鍙茶涓猴級</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇鍦扮悊浣嶇疆鏈€杩戦偦鏌ヨ绯荤粺</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓鍔ㄦ€佺殑Top-N 鍒嗘瀽鎶ュ憡锛屾敮鎸佷笉鍚岀淮搴﹀拰鏃堕棿鑼冨洿</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// QUALIFY 瀛愬彞绔犺妭
// ============================================

export function QualifySection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">QUALIFY 瀛愬彞</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"绐楀彛鍑芥暟鐨勮繃婊ゅ櫒锛岃澶嶆潅鍒嗘瀽鏇寸畝娲?</p>

      <Paragraph {...noteProps('p1')}>
        QUALIFY 瀛愬彞涓撻棬鐢ㄤ簬杩囨护绐楀彛鍑芥暟鐨勭粨鏋溿€傚畠鍦?HAVING 瀛愬彞涔嬪悗鎵ц锛屽厑璁告垜浠牴鎹獥鍙ｅ嚱鏁扮殑璁＄畻缁撴灉鏉ヨ繃婊ゆ暟鎹銆傝繖鍦ㄨ繘琛?Top-N 鏌ヨ銆佸垎缁勭瓫閫夌瓑鍦烘櫙涓壒鍒湁鐢ㄣ€?
      </Paragraph>

      <SQLFlowDiagram type="filter" />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩烘湰璇硶</h3>

      <SQLExplainer
        sql={`SELECT column1, column2, window_function()
FROM table_name
WHERE condition1          -- 鍏堣繃婊ゅ師濮嬫暟鎹?
GROUP BY grouping_columns -- 鐒跺悗鍒嗙粍鑱氬悎
HAVING condition2         -- 杩囨护鍒嗙粍缁撴灉
QUALIFY condition3        -- 鏈€鍚庤繃婊ょ獥鍙ｅ嚱鏁扮粨鏋?
ORDER BY sort_columns;`}
        explanations={[
          { code: 'WHERE condition1', explanation: '绗竴姝ワ細杩囨护鍘熷琛屾暟鎹?, tip: '鍦ㄥ垎缁勫拰鑱氬悎涔嬪墠鎵ц' },
          { code: 'GROUP BY ... HAVING condition2', explanation: '绗簩姝ワ細鍒嗙粍鑱氬悎骞惰繃婊ゅ垎缁勭粨鏋?, tip: 'HAVING 杩囨护鑱氬悎鍚庣殑缁撴灉' },
          { code: 'QUALIFY condition3', explanation: '绗笁姝ワ細鏍规嵁绐楀彛鍑芥暟缁撴灉杩囨护', tip: '鍦?ORDER BY 涔嬪墠鎵ц' },
          { code: 'ORDER BY sort_columns', explanation: '鏈€鍚庯細瀵规渶缁堢粨鏋滄帓搴?, tip: 'QUALIFY 鍚庣殑鏁版嵁杩涜鎺掑簭' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">Top-N 鏌ヨ</h3>

      <CodeBlock
        title="鍚勯儴闂ㄨ柂璧勬渶楂樼殑3鍚嶅憳宸?
        code={`-- 浼犵粺鏂规硶锛氫娇鐢ㄥ瓙鏌ヨ
SELECT * FROM (
    SELECT
        department,
        employee_name,
        salary,
        ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn
    FROM employees
) ranked
WHERE rn <= 3;

-- 浣跨敤 QUALIFY锛氭洿绠€娲?
SELECT
    department,
    employee_name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn
FROM employees
QUALIFY ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) <= 3;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">澶嶆潅绛涢€夋潯浠?/h3>

      <CodeBlock
        title="澶氭潯浠剁獥鍙ｇ瓫閫?
        code={`-- 鎵惧嚭鍚勯儴闂ㄨ柂璧勯珮浜庨儴闂ㄥ钩鍧囨按骞充笖鎺掑悕鍓?鐨勫憳宸?
SELECT
    department,
    employee_name,
    salary,
    dept_avg_salary,
    salary_rank
FROM (
    SELECT
        department,
        employee_name,
        salary,
        AVG(salary) OVER (PARTITION BY department) AS dept_avg_salary,
        ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS salary_rank
    FROM employees
)
QUALIFY salary > dept_avg_salary AND salary_rank <= 5;

-- 鎴栬€呯洿鎺ュ湪 QUALIFY 涓绠?
SELECT
    department,
    employee_name,
    salary
FROM employees
QUALIFY salary > AVG(salary) OVER (PARTITION BY department)
   AND ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) <= 5;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍘婚噸涓庡幓閲嶇瓫閫?/h3>

      <CodeBlock
        title="鍒犻櫎閲嶅璁板綍"
        code={`-- 淇濈暀姣忎釜鍒嗙粍涓殑绗竴鏉¤褰?
SELECT *
FROM user_events
QUALIFY ROW_NUMBER() OVER (
    PARTITION BY user_id, event_type
    ORDER BY event_time
) = 1;

-- 鍒犻櫎瀹屽叏閲嶅鐨勮
SELECT DISTINCT *
FROM table_with_duplicates;

-- 鎴栬€呬娇鐢?QUALIFY 鑷畾涔夊幓閲嶉€昏緫
SELECT *
FROM user_sessions
QUALIFY ROW_NUMBER() OVER (
    PARTITION BY user_id, session_start
    ORDER BY session_duration DESC  -- 淇濈暀鏈€闀跨殑浼氳瘽
) = 1;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏃堕棿搴忓垪鍒嗘瀽</h3>

      <CodeBlock
        title="绉诲姩骞冲潎绛涢€?
        code={`-- 鎵惧嚭閿€鍞寮傚父楂樼殑鏃ユ湡锛堥珮浜?澶╃Щ鍔ㄥ钩鍧囩殑2鍊嶆爣鍑嗗樊锛?
SELECT
    sale_date,
    daily_sales,
    moving_avg_7d,
    moving_std_7d
FROM (
    SELECT
        sale_date,
        daily_sales,
        AVG(daily_sales) OVER (
            ORDER BY sale_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS moving_avg_7d,
        STDDEV(daily_sales) OVER (
            ORDER BY sale_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS moving_std_7d
    FROM sales_data
)
QUALIFY daily_sales > moving_avg_7d + 2 * moving_std_7d;

-- 瓒嬪娍鍙樺寲鐐规娴?
SELECT
    date,
    value,
    lag_value,
    trend_change
FROM (
    SELECT
        date,
        value,
        LAG(value) OVER (ORDER BY date) AS lag_value,
        CASE
            WHEN LAG(value) OVER (ORDER BY date) < value THEN 'increasing'
            WHEN LAG(value) OVER (ORDER BY date) > value THEN 'decreasing'
            ELSE 'stable'
        END AS trend
    FROM time_series
)
QUALIFY trend != LAG(trend) OVER (ORDER BY date);`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">涓?HAVING 鐨勫尯鍒?/h3>

      <CodeBlock
        title="QUALIFY vs HAVING"
        code={`-- HAVING锛氳繃婊ゅ垎缁勮仛鍚堢粨鏋?
SELECT department, AVG(salary) AS avg_salary
FROM employees
GROUP BY department
HAVING AVG(salary) > 50000;  -- 閮ㄩ棬骞冲潎钖祫 > 50000

-- QUALIFY锛氳繃婊ょ獥鍙ｅ嚱鏁扮粨鏋?
SELECT department, employee_name, salary
FROM employees
QUALIFY salary > AVG(salary) OVER (PARTITION BY department);  -- 鍛樺伐钖祫 > 閮ㄩ棬骞冲潎

-- 缁撳悎浣跨敤
SELECT department, employee_name, salary, dept_avg
FROM (
    SELECT
        department,
        employee_name,
        salary,
        AVG(salary) OVER (PARTITION BY department) AS dept_avg
    FROM employees
)
QUALIFY salary > dept_avg                    -- QUALIFY 杩囨护绐楀彛缁撴灉
GROUP BY department, employee_name, salary, dept_avg
HAVING COUNT(*) OVER (PARTITION BY department) > 5;  -- HAVING 杩囨护鍒嗙粍缁撴灉`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="QUALIFY 浣跨敤鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鎵ц椤哄簭锛?/strong> WHERE 鈫?GROUP BY 鈫?HAVING 鈫?QUALIFY 鈫?ORDER BY 鈫?LIMIT</li>
          <li><strong>鎬ц兘鑰冭檻锛?/strong> QUALIFY 鍦ㄦ渶鍚庢墽琛岋紝鍙兘褰卞搷鎬ц兘</li>
          <li><strong>鍙鎬э細</strong> 瀵逛簬澶嶆潅绐楀彛绛涢€夛紝QUALIFY 姣斿瓙鏌ヨ鏇存竻鏅?/li>
          <li><strong>鍏煎鎬э細</strong> QUALIFY 鏄緝鏂扮殑鏍囧噯锛屼笉鏄墍鏈夋暟鎹簱閮芥敮鎸?/li>
          <li><strong>鏇夸唬鏂规锛?/strong> 涓嶆敮鎸?QUALIFY 鐨勬暟鎹簱鍙互鐢ㄥ瓙鏌ヨ鎴?CTE 鏇夸唬</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃弳 鎺掑悕绛涢€?/h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">Top-N 鏌ヨ銆佸悇缁勫墠鍑犲悕銆佹窐姹扮瓫閫?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搳 鏁版嵁璐ㄩ噺</h4>
          <p className="text-sm text-green-600 dark:text-green-400">寮傚父鍊兼娴嬨€侀噸澶嶆暟鎹竻鐞嗐€佹暟鎹獙璇?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搱 瓒嬪娍鍒嗘瀽</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鎷愮偣妫€娴嬨€佽秼鍔垮彉鍖栥€佹ā寮忚瘑鍒?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃幆 鏉′欢绛涢€?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鍔ㄦ€侀槇鍊笺€佸鏉′欢缁勫悎銆佷笂涓嬫枃鐩稿叧绛涢€?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鎵惧嚭閿€鍞杩炵画3澶╀笂娑ㄧ殑浜у搧</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇鍩轰簬缁熻鍒嗗竷鐨勫紓甯稿€兼娴?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓伒娲荤殑Top-N 绛涢€夊櫒锛屾敮鎸佸姩鎬佸垎缁勫拰鎺掑簭鏉′欢</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// SAMPLE 閲囨牱绔犺妭
// ============================================

export function SamplingSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">SAMPLE 閲囨牱</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"澶ф暟鎹鐞嗙殑绗竴姝ワ紝浠庢牱鏈紑濮嬫帰绱?</p>

      <Paragraph {...noteProps('p1')}>
        鍦ㄥ鐞嗘捣閲忔暟鎹椂锛屾垜浠粡甯镐笉闇€瑕佸垎鏋愬叏閮ㄦ暟鎹紝鑰屾槸閫氳繃閲囨牱鑾峰彇鏈変唬琛ㄦ€х殑瀛愰泦銆侱uckDB 鐨?SAMPLE 瀛愬彞鎻愪緵浜嗗绉嶉噰鏍锋柟娉曪紝甯姪鎴戜滑鍦ㄤ繚璇佺粺璁℃剰涔夌殑鍚屾椂澶у箙鎻愬崌鏌ヨ鎬ц兘銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩烘湰璇硶</h3>

      <SQLExplainer
        sql={`SELECT * FROM large_table
USING SAMPLE 10%              -- 閲囨牱 10% 鐨勬暟鎹?
-- USING SAMPLE 1000 ROWS    -- 閲囨牱 1000 琛?
-- USING SAMPLE SYSTEM(5%)   -- 绯荤粺閲囨牱锛堟洿蹇絾涓嶅畬鍏ㄩ殢鏈猴級
-- USING SAMPLE BERNOULLI(1%) -- 浼姫鍒╅噰鏍凤紙瀹屽叏闅忔満锛塦}
        explanations={[
          { code: 'USING SAMPLE 10%', explanation: '鎸夌櫨鍒嗘瘮閲囨牱锛岄噰鏍风害 10% 鐨勬暟鎹?, tip: '鏈€甯哥敤鐨勯噰鏍锋柟寮? },
          { code: 'USING SAMPLE 1000 ROWS', explanation: '閲囨牱鍥哄畾鏁伴噺鐨勮', tip: '褰撻渶瑕佺簿纭鏁版椂浣跨敤' },
          { code: 'SYSTEM(5%)', explanation: '绯荤粺閲囨牱锛岄€熷害蹇絾涓嶅畬鍏ㄩ殢鏈?, tip: '鐗虹壊闅忔満鎬ф崲鍙栨€ц兘' },
          { code: 'BERNOULLI(1%)', explanation: '浼姫鍒╅噰鏍凤紝瀹屽叏闅忔満浣嗚緝鎱?, tip: '缁熻鎰忎箟鏈€濂界殑閲囨牱鏂规硶' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">閲囨牱鏂规硶瀵规瘮</h3>

      <div className="overflow-x-auto my-6">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="bg-slate-100 dark:bg-slate-700">
              <th className="border border-slate-200 dark:border-slate-600 px-4 py-2 text-left text-slate-800 dark:text-slate-200">鏂规硶</th>
              <th className="border border-slate-200 dark:border-slate-600 px-4 py-2 text-left text-slate-800 dark:text-slate-200">闅忔満鎬?/th>
              <th className="border border-slate-200 dark:border-slate-600 px-4 py-2 text-left text-slate-800 dark:text-slate-200">鎬ц兘</th>
              <th className="border border-slate-200 dark:border-slate-600 px-4 py-2 text-left text-slate-800 dark:text-slate-200">閫傜敤鍦烘櫙</th>
            </tr>
          </thead>
          <tbody className="text-slate-600 dark:text-slate-300">
            <tr>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2 font-mono">SYSTEM</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">涓瓑</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">寰堝揩</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">蹇€熼瑙堛€佽秼鍔垮垎鏋?/td>
            </tr>
            <tr className="bg-slate-50 dark:bg-slate-800">
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2 font-mono">BERNOULLI</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">寰堥珮</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">杈冩參</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">缁熻鍒嗘瀽銆佺簿纭爺绌?/td>
            </tr>
            <tr>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2 font-mono">鐧惧垎姣?/td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">鑹ソ</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">蹇?/td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">鏁版嵁鎺㈢储銆佸師鍨嬪紑鍙?/td>
            </tr>
            <tr className="bg-slate-50 dark:bg-slate-800">
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2 font-mono">鍥哄畾琛屾暟</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">鑹ソ</td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">蹇?/td>
              <td className="border border-slate-200 dark:border-slate-600 px-4 py-2">鍥哄畾鏍锋湰澶у皬鐨勭爺绌?/td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <CodeBlock
        title="鏁版嵁鎺㈢储涓庡垎鏋?
        code={`-- 蹇€熼瑙堝ぇ鏁版嵁闆?
SELECT
    COUNT(*) AS total_rows,
    AVG(sale_amount) AS avg_sale,
    COUNT(DISTINCT customer_id) AS unique_customers
FROM huge_sales_table
USING SAMPLE 1%;  -- 鍙垎鏋?1% 鐨勬暟鎹?

-- 鍒嗗眰閲囨牱锛氫笉鍚岀被鍒垎鍒噰鏍?
SELECT category, COUNT(*) AS sample_size
FROM products
USING SAMPLE 5%  -- 姣忕被浜у搧閮介噰鏍?5%
GROUP BY category;

-- 鏃堕棿搴忓垪閲囨牱
SELECT
    DATE_TRUNC('day', order_date) AS day,
    COUNT(*) AS daily_orders,
    SUM(order_amount) AS daily_revenue
FROM orders
WHERE order_date >= '2024-01-01'
USING SAMPLE BERNOULLI(10%)  -- 瀹屽叏闅忔満鐨?10% 鏍锋湰
GROUP BY DATE_TRUNC('day', order_date)
ORDER BY day;`}
        {...noteProps('code1')}
      />

      <CodeBlock
        title="鏈哄櫒瀛︿範鏁版嵁鍑嗗"
        code={`-- 鍒涘缓璁粌鏁版嵁闆?
CREATE TABLE training_sample AS
SELECT * FROM user_behavior_data
USING SAMPLE 70% (SEED 42);  -- 鍙噸鐜扮殑 70% 鏍锋湰

-- 鍒涘缓娴嬭瘯鏁版嵁闆嗭紙鎺掗櫎璁粌鏁版嵁锛?
CREATE TABLE test_sample AS
SELECT * FROM user_behavior_data
WHERE user_id NOT IN (SELECT user_id FROM training_sample);

-- 骞宠　閲囨牱锛氬鐞嗙被鍒笉骞宠　
WITH category_counts AS (
    SELECT category, COUNT(*) AS total_count
    FROM products
    GROUP BY category
),
min_category AS (
    SELECT MIN(total_count) AS min_count FROM category_counts
)
SELECT p.*
FROM products p
JOIN category_counts cc ON p.category = cc.category
USING SAMPLE (SELECT min_count * 100.0 / total_count FROM min_category) PERCENT
WHERE cc.total_count > (SELECT min_count FROM min_category);`}
        {...noteProps('code2')}
      />

      <InfoBox type="tip" title="閲囨牱鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>纭畾鎬ч噰鏍凤細</strong> 浣跨敤 SEED 鍙傛暟纭繚缁撴灉鍙噸鐜?/li>
          <li><strong>鏍锋湰澶у皬锛?/strong> 鏍规嵁鍒嗘瀽闇€姹傞€夋嫨鍚堥€傜殑鏍锋湰姣斾緥</li>
          <li><strong>鍒嗗眰閲囨牱锛?/strong> 閲嶈绫诲埆瑕佺‘淇濇湁瓒冲鏍锋湰</li>
          <li><strong>鎬ц兘鏉冭　锛?/strong> SYSTEM 閲囨牱蹇絾闅忔満鎬у樊锛孊ERNOULLI 鐩稿弽</li>
          <li><strong>缁熻鎰忎箟锛?/strong> 灏忔牱鏈紙&lt;1%锛夊彲鑳藉け鍘荤粺璁℃剰涔?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇閲囨牱鎶€宸?/h3>

      <CodeBlock
        title="鏉′欢閲囨牱鍜岀粍鍚堜娇鐢?
        code={`-- 鏉′欢閲囨牱锛氫笉鍚屾潯浠朵笉鍚岄噰鏍风巼
SELECT *
FROM (
    SELECT *,
           CASE
               WHEN priority = 'high' THEN 0.5    -- 楂樹紭鍏堢骇閲囨牱 50%
               WHEN priority = 'medium' THEN 0.2  -- 涓紭鍏堢骇閲囨牱 20%
               ELSE 0.05                          -- 鍏朵粬閲囨牱 5%
           END AS sample_rate
    FROM support_tickets
) t
WHERE RANDOM() < t.sample_rate;

-- 鍒嗙粍閲囨牱锛氭瘡涓粍鍗曠嫭閲囨牱
SELECT *
FROM (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY category ORDER BY RANDOM()) AS rn,
           COUNT(*) OVER (PARTITION BY category) AS category_size
    FROM products
) t
WHERE rn <= GREATEST(10, category_size * 0.1);  -- 姣忕被鑷冲皯10涓垨10%`}
        {...noteProps('code3')}
      />

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓钩琛￠噰鏍风殑鐢ㄦ埛璋冩煡绯荤粺</p>
          <p><strong>鎸戞垬 2锛?/strong> 鍒涘缓鏃堕棿搴忓垪鏁版嵁鐨勫鑺傛€ч噰鏍峰垎鏋?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鏋勫缓涓€涓嚜閫傚簲鐨勯噰鏍风郴缁燂紝鏍规嵁鏁版嵁鐗瑰緛鍔ㄦ€佽皟鏁撮噰鏍风巼</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍏ㄦ枃鎼滅储绔犺妭
// ============================================

export function FulltextSearchSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍏ㄦ枃鎼滅储</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鍦ㄦ枃鏈捣娲嬩腑瀵绘壘閽堝皷"</p>

      <Paragraph {...noteProps('p1')}>
        鍏ㄦ枃鎼滅储涓嶅悓浜庢櫘閫氱殑 LIKE 鍖归厤锛屽畠浣跨敤涓撻棬鐨勭储寮曟妧鏈拰绠楁硶鏉ュ揩閫熸悳绱㈠ぇ閲忔枃鏈暟鎹€侱uckDB 鏀寔鍏ㄦ枃鎼滅储鍔熻兘锛屽彲浠ュ鏂囨。銆佹枃绔犮€佹棩蹇楃瓑鏂囨湰鍐呭杩涜楂樻晥鐨勫叧閿瘝鎼滅储鍜岀浉鍏虫€ф帓搴忋€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩烘湰鍏ㄦ枃鎼滅储</h3>

      <CodeBlock
        title="鍒涘缓鍜屼娇鐢ㄥ叏鏂囩储寮?
        code={`-- 鍒涘缓鍖呭惈鏂囨湰鍐呭鐨勮〃
CREATE TABLE documents (
    id INTEGER PRIMARY KEY,
    title VARCHAR,
    content TEXT,
    author VARCHAR,
    created_date DATE
);

-- 鎻掑叆绀轰緥鏁版嵁
INSERT INTO documents VALUES
    (1, 'SQL 鍏ラ棬鎸囧崡', 'SQL 鏄粨鏋勫寲鏌ヨ璇█锛岀敤浜庣鐞嗗叧绯诲瀷鏁版嵁搴?..', '寮犱笁', '2024-01-01'),
    (2, 'Python 鏁版嵁鍒嗘瀽', 'Python 鎻愪緵浜嗕赴瀵岀殑鏁版嵁鍒嗘瀽搴擄紝濡?pandas 鍜?numpy...', '鏉庡洓', '2024-01-02'),
    (3, '鏈哄櫒瀛︿範鍩虹', '鏈哄櫒瀛︿範鏄汉宸ユ櫤鑳界殑閲嶈鍒嗘敮...', '鐜嬩簲', '2024-01-03');

-- 鍩烘湰鍏ㄦ枃鎼滅储锛堝鏋滄敮鎸侊級
SELECT * FROM documents
WHERE content MATCH 'SQL 鏁版嵁';`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇鎼滅储鎶€宸?/h3>

      <CodeBlock
        title="澶嶆潅鎼滅储鏌ヨ"
        code={`-- 澶氬叧閿瘝鎼滅储
SELECT title, content,
       -- 璁＄畻鐩稿叧鎬у垎鏁帮紙妯℃嫙锛?
       (CASE WHEN title LIKE '%SQL%' THEN 10 ELSE 0 END +
        CASE WHEN content LIKE '%SQL%' THEN 5 ELSE 0 END +
        CASE WHEN title LIKE '%鏁版嵁%' THEN 8 ELSE 0 END +
        CASE WHEN content LIKE '%鏁版嵁%' THEN 4 ELSE 0 END) AS relevance_score
FROM documents
WHERE (title LIKE '%SQL%' OR content LIKE '%SQL%')
   OR (title LIKE '%鏁版嵁%' OR content LIKE '%鏁版嵁%')
ORDER BY relevance_score DESC;

-- 鐭鎼滅储
SELECT * FROM documents
WHERE content LIKE '%缁撴瀯鍖栨煡璇㈣瑷€%'
   OR content LIKE '%鍏崇郴鍨嬫暟鎹簱%';

-- 鎺掗櫎鎼滅储
SELECT * FROM documents
WHERE content LIKE '%Python%'
  AND content NOT LIKE '%Java%'
  AND content NOT LIKE '%JavaScript%';`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鎼滅储缁撴灉鎺掑悕</h3>

      <CodeBlock
        title="鐩稿叧鎬ф帓搴?
        code={`-- 鍩轰簬澶氫釜鍥犵礌鐨勭患鍚堣瘎鍒?
SELECT
    title,
    author,
    created_date,
    -- 鏍囬鍖归厤鏉冮噸鏇撮珮
    CASE WHEN LOWER(title) LIKE LOWER('%SQL%') THEN 20 ELSE 0 END +
    CASE WHEN LOWER(content) LIKE LOWER('%SQL%') THEN 10 ELSE 0 END +
    -- 鍐呭鍏抽敭璇嶅尮閰?
    CASE WHEN LOWER(content) LIKE LOWER('%鏌ヨ%') THEN 5 ELSE 0 END +
    CASE WHEN LOWER(content) LIKE LOWER('%鏁版嵁搴?') THEN 5 ELSE 0 END +
    -- 鏈€杩戞枃绔犳潈閲?
    CASE WHEN created_date > CURRENT_DATE - INTERVAL 30 DAY THEN 3 ELSE 0 END
    AS relevance_score
FROM documents
WHERE (title LIKE '%SQL%' OR content LIKE '%SQL%')
   OR (title LIKE '%鏌ヨ%' OR content LIKE '%鏌ヨ%')
   OR (title LIKE '%鏁版嵁搴?' OR content LIKE '%鏁版嵁搴?')
ORDER BY relevance_score DESC, created_date DESC;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">妯＄硦鎼滅储鍜屽閿?/h3>

      <CodeBlock
        title="澶勭悊鎷煎啓閿欒鍜岃繎浼煎尮閰?
        code={`-- 绠€鍗曠殑缂栬緫璺濈鎼滅储锛圠evenshtein璺濈锛?
SELECT title, content
FROM documents
WHERE LEVENSHTEIN(LOWER(title), LOWER('SQL')) <= 2  -- 鍏佽2涓瓧绗︾殑宸紓
   OR LEVENSHTEIN(LOWER(content), LOWER('database')) <= 3;

-- 鍩轰簬N-gram鐨勬ā绯婂尮閰?
WITH ngrams AS (
    SELECT id, title, content,
           -- 鍒涘缓2-gram
           UNNEST(STRING_TO_ARRAY(LOWER(content), ' ')) AS word
    FROM documents
)
SELECT d.title,
       COUNT(*) AS matching_ngrams
FROM documents d
JOIN ngrams n ON d.id = n.id
WHERE n.word LIKE 'dat%'  -- 鍖归厤浠?dat"寮€澶寸殑璇?
   OR n.word LIKE '%base%' -- 鍖归厤鍖呭惈"base"鐨勮瘝
GROUP BY d.id, d.title
HAVING COUNT(*) > 0
ORDER BY matching_ngrams DESC;`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="鍏ㄦ枃鎼滅储浼樺寲寤鸿" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>绱㈠紩绛栫暐锛?/strong> 瀵规枃鏈瓧娈靛垱寤洪€傚綋鐨勭储寮?/li>
          <li><strong>鍒嗚瘝澶勭悊锛?/strong> 鑰冭檻涓枃鍒嗚瘝瀵规悳绱㈢粨鏋滅殑褰卞搷</li>
          <li><strong>鍋滅敤璇嶏細</strong> 杩囨护甯歌鐨勬棤鎰忎箟璇嶏紙濡?鐨?銆?鏄?绛夛級</li>
          <li><strong>鐩稿叧鎬э細</strong> 缁撳悎澶氱鍥犵礌璁＄畻鐩稿叧鎬у垎鏁?/li>
          <li><strong>鎬ц兘鐩戞帶锛?/strong> 澶ф暟鎹泦鏃舵敞鎰忔悳绱㈡€ц兘</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃摎 鏂囨。绠＄悊绯荤粺</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鍦ㄥぇ閲忔枃妗ｄ腑鎼滅储鍏抽敭璇嶃€佷富棰樼浉鍏冲唴瀹?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃攳 瀹㈡湇绯荤粺</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鎼滅储鍘嗗彶闂銆佽В鍐虫柟妗堛€佸父瑙侀棶棰?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搳 鍐呭鍒嗘瀽</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鍒嗘瀽鏂囩珷涓婚銆佸叧閿瘝棰戞銆佸唴瀹圭浉鍏虫€?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃敩 鐮旂┒宸ュ叿</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">瀛︽湳璁烘枃鎼滅储銆佹枃鐚患杩般€佺煡璇嗗彂鐜?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鏋勫缓涓€涓畝鍗曠殑鏂囨。鎼滅储寮曟搸锛屾敮鎸佸叧閿瘝鐩稿叧鎬ф帓搴?/p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇鎷煎啓绾犻敊鍔熻兘锛岃嚜鍔ㄥ缓璁纭殑鎼滅储鍏抽敭璇?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓璇█鍏ㄦ枃鎼滅储绯荤粺锛屾敮鎸佷腑鑻辨枃娣峰悎鎼滅储</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 杩戜技璁＄畻绔犺妭
// ============================================

export function ApproximateComputingSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">杩戜技璁＄畻</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鐢?0%鐨勫噯纭€ф崲鍙?0鍊嶇殑閫熷害鎻愬崌"</p>

      <Paragraph {...noteProps('p1')}>
        鍦ㄥぇ鏁版嵁鏃朵唬锛岀簿纭绠楀線寰€浠ｄ环楂樻槀銆傝繎浼艰绠楃畻娉曢€氳繃鐗虹壊灏戦噺鍑嗙‘鎬ф潵澶у箙鎻愬崌璁＄畻鎬ц兘锛岀壒鍒€傜敤浜庨渶瑕佸揩閫熷搷搴旀垨澶勭悊娴烽噺鏁版嵁鐨勫満鏅紝濡傚疄鏃跺垎鏋愩€佹暟鎹帰绱€佸ぇ瑙勬ā缁熻绛夈€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">杩戜技璁℃暟绠楁硶</h3>

      <CodeBlock
        title="HyperLogLog 杩戜技鍘婚噸璁℃暟"
        code={`-- 浼犵粺绮剧‘璁℃暟锛堝唴瀛樻秷鑰楀ぇ锛?
SELECT COUNT(DISTINCT user_id) AS exact_unique_users
FROM user_events
WHERE event_date >= '2024-01-01';

-- 杩戜技璁℃暟锛堝唴瀛橀珮鏁堬級
-- 娉ㄦ剰锛欴uckDB鍙兘涓嶆敮鎸佸師鐢烪yperLogLog锛岃繖閲屾槸妯℃嫙
WITH approx_count AS (
    SELECT
        COUNT(*) AS total_events,
        COUNT(DISTINCT user_id) * 0.95 AS approx_unique_users,  -- 绠€鍗曡繎浼?
        APPROX_COUNT_DISTINCT(user_id) AS approx_count  -- 濡傛灉鏀寔
    FROM user_events
    USING SAMPLE 10%  -- 鍏堥噰鏍峰啀璁＄畻
)
SELECT * FROM approx_count;

-- 瀹為檯搴旂敤锛歎V缁熻
SELECT
    DATE_TRUNC('day', event_time) AS day,
    COUNT(DISTINCT user_id) AS exact_uv,
    COUNT(DISTINCT user_id) * 0.97 AS approx_uv  -- 鍋囪3%鐨勮宸?
FROM events
WHERE event_time >= CURRENT_DATE - INTERVAL 30 DAY
GROUP BY DATE_TRUNC('day', event_time)
ORDER BY day;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">杩戜技鍒嗕綅鏁拌绠?/h3>

      <CodeBlock
        title="TDigest 鍜屽叾浠栬繎浼煎垎浣嶆暟绠楁硶"
        code={`-- 绮剧‘鍒嗕綅鏁帮紙瀵瑰ぇ鏁版嵁闆嗗緢鎱級
SELECT
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY response_time) AS median_response,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time) AS p95_response,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY response_time) AS p99_response
FROM api_requests;

-- 杩戜技鍒嗕綅鏁帮紙鏇村揩锛?
WITH sampled_data AS (
    SELECT response_time
    FROM api_requests
    USING SAMPLE BERNOULLI(5%)  -- 閲囨牱5%鐨勬暟鎹?
),
approx_percentiles AS (
    SELECT
        AVG(response_time) AS approx_median,
        MAX(response_time) AS approx_p95,  -- 绠€鍖栬繎浼?
        MAX(response_time) AS approx_p99   -- 绠€鍖栬繎浼?
    FROM (
        SELECT response_time,
               ROW_NUMBER() OVER (ORDER BY response_time) AS rn,
               COUNT(*) OVER () AS total
        FROM sampled_data
    ) t
    WHERE rn >= total * 0.5  -- 涓綅鏁伴檮杩?
)
SELECT * FROM approx_percentiles;

-- 瀹為檯搴旂敤锛氭€ц兘鐩戞帶
SELECT
    service_name,
    COUNT(*) AS total_requests,
    AVG(response_time) AS avg_response,
    MAX(response_time) AS max_response,
    -- 杩戜技P95
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time) AS exact_p95,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY response_time) * 1.02 AS approx_p95
FROM service_metrics
WHERE created_at >= CURRENT_TIMESTAMP - INTERVAL 1 HOUR
GROUP BY service_name;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">姒傜巼鏁版嵁缁撴瀯</h3>

      <CodeBlock
        title="Bloom Filter 姒傚康婕旂ず"
        code={`-- 甯冮殕杩囨护鍣ㄧ殑SQL妯℃嫙
-- 瀹為檯搴旂敤涓紝杩欎簺閫氬父鍦ㄥ簲鐢ㄥ眰瀹炵幇

-- 妯℃嫙鐢ㄦ埛瀛樺湪鎬ф鏌ワ紙浣跨敤閲囨牱锛?
CREATE TABLE user_bloom_filter AS
SELECT DISTINCT user_id
FROM user_events
USING SAMPLE 50% (SEED 12345);  -- 鍒涘缓杩囨护鍣?

-- 妫€鏌ョ敤鎴锋槸鍚﹀瓨鍦紙杩戜技锛?
SELECT
    u.user_id,
    CASE WHEN u.user_id IN (SELECT user_id FROM user_bloom_filter)
         THEN '鍙兘瀛樺湪'  -- 鍙兘鏈夊亣闃虫€?
         ELSE '涓€瀹氫笉瀛樺湪'  -- 涓€瀹氬噯纭?
    END AS existence_check
FROM potential_users u;

-- Count-Min Sketch 妯℃嫙锛堥鐜囦及璁★級
WITH frequency_estimate AS (
    SELECT
        item_id,
        COUNT(*) AS exact_count,
        COUNT(*) * 1.1 AS approx_count  -- 绠€鍗曡繎浼?
    FROM user_actions
    GROUP BY item_id
)
SELECT
    item_id,
    exact_count,
    approx_count,
    ABS(exact_count - approx_count) / exact_count AS error_rate
FROM frequency_estimate
ORDER BY exact_count DESC
LIMIT 10;`}
        {...noteProps('code3')}
      />

      <InfoBox type="tip" title="杩戜技璁＄畻浣跨敤鍘熷垯" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>绮惧害 vs 鎬ц兘锛?/strong> 鏍规嵁涓氬姟闇€姹傚钩琛″噯纭€у拰閫熷害</li>
          <li><strong>璇樊鑼冨洿锛?/strong> 浜嗚В鍚勭绠楁硶鐨勮宸竟鐣?/li>
          <li><strong>閲囨牱绛栫暐锛?/strong> 纭繚閲囨牱鍏锋湁浠ｈ〃鎬?/li>
          <li><strong>鐩戞帶鍑嗙‘鎬э細</strong> 瀹氭湡楠岃瘉杩戜技缁撴灉涓庣簿纭粨鏋滅殑宸紓</li>
          <li><strong>閫傜敤鍦烘櫙锛?/strong> 瀹炴椂鍒嗘瀽銆佹暟鎹帰绱€佸ぇ瑙勬ā缁熻</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 瀹炴椂鍒嗘瀽</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">浠〃鐩樻暟鎹€佸疄鏃剁洃鎺с€佸揩閫熸礊瀵?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃攳 鏁版嵁鎺㈢储</h4>
          <p className="text-sm text-green-600 dark:text-green-400">蹇€熼瑙堛€佽秼鍔垮彂鐜般€佸紓甯告娴?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搱 澶ц妯＄粺璁?/h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鐢ㄦ埛琛屼负鍒嗘瀽銆佹祦閲忕粺璁°€佹€ц兘鎸囨爣</p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃 鏈哄櫒瀛︿範棰勫鐞?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鐗瑰緛閫夋嫨銆佹暟鎹噰鏍枫€佹ā鍨嬮獙璇?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓熀浜庨噰鏍风殑瀹炴椂UV缁熻绯荤粺</p>
          <p><strong>鎸戞垬 2锛?/strong> 鍒涘缓杩戜技鍒嗕綅鏁拌绠楀櫒锛屾瘮杈冪簿纭笌杩戜技缁撴灉鐨勫樊寮?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鏋勫缓涓€涓嚜閫傚簲鐨勮繎浼艰绠楃郴缁燂紝鏍规嵁鏌ヨ鍝嶅簲鏃堕棿鍔ㄦ€佽皟鏁寸簿搴?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鏁扮粍涓庣粨鏋勪綋绔犺妭
// ============================================

export function ArrayStructSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鏁扮粍涓庣粨鏋勪綋</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"澶嶆潅鏁版嵁绫诲瀷鐨勫鐞嗚壓鏈?</p>

      <Paragraph {...noteProps('p1')}>
        鐜颁唬鏁版嵁澶勭悊缁忓父闇€瑕佸鐞嗗鏉傜殑宓屽缁撴瀯銆侱uckDB 鏀寔鏁扮粍锛圓RRAY锛夊拰缁撴瀯浣擄紙STRUCT锛夋暟鎹被鍨嬶紝璁╀綘鍙互浼橀泤鍦板鐞嗗鍊煎睘鎬с€佸祵濂楀璞＄瓑澶嶆潅鏁版嵁缁撴瀯銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏁扮粍绫诲瀷</h3>

      <CodeBlock
        title="鍒涘缓鍜屼娇鐢ㄦ暟缁?
        code={`-- 鍒涘缓鍖呭惈鏁扮粍鐨勮〃
CREATE TABLE products (
    id INTEGER,
    name VARCHAR,
    tags VARCHAR[],              -- 瀛楃涓叉暟缁?
    prices DECIMAL[][],          -- 浜岀淮鏁扮粍锛堜笉鍚屽湴鍖虹殑浠锋牸锛?
    features JSON                 -- 鎴栬€呬娇鐢↗SON瀛樺偍澶嶆潅缁撴瀯
);

-- 鎻掑叆鏁扮粍鏁版嵁
INSERT INTO products VALUES
    (1, 'iPhone 15', ['鏅鸿兘鎵嬫満', '鑻规灉', '5G'], [[999, 1099], [899, 999]]),
    (2, 'MacBook Pro', ['绗旇鏈?, '鑻规灉', 'M3'], [[2499, 2799], [2299, 2599]]);

-- 鏌ヨ鏁扮粍鏁版嵁
SELECT
    name,
    tags,
    tags[1] AS first_tag,        -- 鏁扮粍涓嬫爣浠?寮€濮?
    array_length(tags) AS tag_count,
    prices[1] AS region1_prices  -- 鑾峰彇绗竴涓瓙鏁扮粍
FROM products;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏁扮粍鎿嶄綔鍑芥暟</h3>

      <SQLExplainer
        sql={`SELECT
    name,
    tags,
    array_length(tags) AS len,
    array_contains(tags, '鑻规灉') AS has_apple,
    array_position(tags, '5G') AS g5_position,
    array_slice(tags, 2, 3) AS middle_tags,
    array_sort(tags) AS sorted_tags,
    array_reverse(tags) AS reversed_tags
FROM products;`}
        explanations={[
          { code: 'array_length(arr)', explanation: '鑾峰彇鏁扮粍闀垮害', tip: '杩斿洖鏁扮粍涓厓绱犵殑鏁伴噺' },
          { code: 'array_contains(arr, value)', explanation: '妫€鏌ユ暟缁勬槸鍚﹀寘鍚寚瀹氬€?, tip: '杩斿洖甯冨皵鍊? },
          { code: 'array_position(arr, value)', explanation: '鏌ユ壘鍏冪礌鍦ㄦ暟缁勪腑鐨勪綅缃?, tip: '鎵句笉鍒拌繑鍥?' },
          { code: 'array_slice(arr, start, end)', explanation: '鎻愬彇鏁扮粍鐨勫瓙闆?, tip: '鏀寔璐熸暟绱㈠紩' },
          { code: 'array_sort(arr)', explanation: '瀵规暟缁勫厓绱犳帓搴?, tip: '杩斿洖鎺掑簭鍚庣殑鏂版暟缁? },
          { code: 'array_reverse(arr)', explanation: '鍙嶈浆鏁扮粍椤哄簭', tip: '杩斿洖鍙嶈浆鍚庣殑鏂版暟缁? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">缁撴瀯浣撶被鍨?/h3>

      <CodeBlock
        title="鍒涘缓鍜屼娇鐢ㄧ粨鏋勪綋"
        code={`-- 鍒涘缓鍖呭惈缁撴瀯浣撶殑琛?
CREATE TABLE employees (
    id INTEGER,
    name VARCHAR,
    contact_info STRUCT(
        email VARCHAR,
        phone VARCHAR,
        address STRUCT(
            street VARCHAR,
            city VARCHAR,
            zipcode VARCHAR
        )
    ),
    skills VARCHAR[]
);

-- 鎻掑叆缁撴瀯浣撴暟鎹?
INSERT INTO employees VALUES
    (1, 'Alice Johnson',
     {'email': 'alice@example.com', 'phone': '555-0101',
      'address': {'street': '123 Main St', 'city': 'New York', 'zipcode': '10001'}},
     ['Python', 'SQL', 'Machine Learning']
    );

-- 鏌ヨ缁撴瀯浣撳瓧娈?
SELECT
    name,
    contact_info.email,
    contact_info.phone,
    contact_info.address.city AS city,
    skills
FROM employees;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">澶嶆潅鏁版嵁鏌ヨ</h3>

      <CodeBlock
        title="鏁扮粍鍜岀粨鏋勪綋鐨勮仈鍚堟煡璇?
        code={`-- 鏌ユ壘鍏锋湁鐗瑰畾鎶€鑳界殑鍛樺伐
SELECT
    name,
    contact_info.email,
    unnest(skills) AS skill  -- 灏嗘暟缁勫睍寮€涓哄琛?
FROM employees
WHERE array_contains(skills, 'Python');

-- 鎸夊煄甯傚垎缁勭粺璁″憳宸ユ暟閲?
SELECT
    contact_info.address.city AS city,
    COUNT(*) AS employee_count,
    array_agg(name) AS employee_names  -- 灏嗗悕瀛楄仛鍚堜负鏁扮粍
FROM employees
GROUP BY contact_info.address.city;

-- 澶嶆潅鏉′欢绛涢€?
SELECT *
FROM employees
WHERE contact_info.address.city = 'New York'
  AND array_contains(skills, 'SQL')
  AND contact_info.email LIKE '%.com';`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">UNNEST 涓庢暟缁勫睍寮€</h3>

      <CodeBlock
        title="鏁扮粍灞曞紑涓哄琛?
        code={`-- UNNEST 灏嗘暟缁勮浆鎹负澶氳
SELECT
    name,
    unnest(skills) AS individual_skill
FROM employees;

-- 缁撴灉锛?
-- Alice Johnson | Python
-- Alice Johnson | SQL
-- Alice Johnson | Machine Learning

-- 甯﹀簭鍙风殑灞曞紑
SELECT
    name,
    skill,
    row_number() OVER (PARTITION BY name ORDER BY skill) AS skill_rank
FROM (
    SELECT name, unnest(skills) AS skill
    FROM employees
) t;

-- 澶氭暟缁勫悓鏃跺睍寮€
SELECT
    name,
    region,
    price
FROM (
    SELECT
        name,
        unnest(['East', 'West', 'Central']) AS region,
        unnest(prices[1]) AS price  -- 灞曞紑浠锋牸鏁扮粍
    FROM products
) t;`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇鏁扮粍鎿嶄綔</h3>

      <CodeBlock
        title="鏁扮粍鑱氬悎鍜岃浆鎹?
        code={`-- 灏嗗琛屾暟鎹仛鍚堜负鏁扮粍
SELECT
    department,
    array_agg(employee_name ORDER BY salary DESC) AS employees_by_salary,
    array_agg(salary ORDER BY salary DESC) AS salaries_desc
FROM employees
GROUP BY department;

-- 鏁扮粍鍘婚噸鍜屾帓搴?
SELECT
    name,
    array_sort(array_distinct(skills)) AS unique_sorted_skills,
    array_length(array_distinct(skills)) AS unique_skill_count
FROM employees;

-- 鏁扮粍浜ら泦鍜屽苟闆?
SELECT
    e1.name AS emp1,
    e2.name AS emp2,
    array_intersect(e1.skills, e2.skills) AS common_skills,
    array_union(e1.skills, e2.skills) AS all_skills
FROM employees e1
JOIN employees e2 ON e1.id < e2.id;  -- 閬垮厤閲嶅閰嶅

-- 鍔ㄦ€佹暟缁勬瀯寤?
SELECT
    name,
    array_concat(
        skills,
        CASE WHEN contact_info.address.city = 'New York'
             THEN ['Remote Work'] ELSE [] END
    ) AS enhanced_skills
FROM employees;`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="鏁扮粍涓庣粨鏋勪綋浣跨敤寤鸿" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鏁版嵁寤烘ā锛?/strong> 浼樺厛浣跨敤鍏崇郴琛紝鏁扮粍鐢ㄤ簬绠€鍗曞鍊煎睘鎬?/li>
          <li><strong>鏌ヨ鎬ц兘锛?/strong> 鏁扮粍鎿嶄綔鍙兘褰卞搷绱㈠紩浣跨敤锛屾敞鎰忔煡璇㈡晥鐜?/li>
          <li><strong>鏁版嵁瀹屾暣鎬э細</strong> 浣跨敤 CHECK 绾︽潫楠岃瘉鏁扮粍鍐呭鐨勬湁鏁堟€?/li>
          <li><strong>JSON 鏇夸唬锛?/strong> 瀵逛簬澶嶆潅宓屽缁撴瀯锛孞SON 鍙兘鏇寸伒娲?/li>
          <li><strong>绱㈠紩绛栫暐锛?/strong> 鑰冭檻浣跨敤 GIN 绱㈠紩浼樺寲鏁扮粍鏌ヨ锛堝鏋滄敮鎸侊級</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彿锔?浜у搧鏍囩绯荤粺</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鍟嗗搧鏍囩銆佸垎绫汇€佸睘鎬х鐞?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃懃 绀句氦缃戠粶</h4>
          <p className="text-sm text-green-600 dark:text-green-400">濂藉弸鍒楄〃銆佸叴瓒ｆ爣绛俱€佸湴鐞嗕綅缃?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搳 鍒嗘瀽鏁版嵁</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">澶氱淮搴︽寚鏍囥€佹椂闂村簭鍒椼€佺粺璁″垎甯?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃洅 鐢靛晢骞冲彴</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鍟嗗搧瑙勬牸銆佺敤鎴峰亸濂姐€佽喘鐗╄溅</p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 璁捐涓€涓畬鏁寸殑鐢靛晢浜у搧琛紝鍖呭惈鏍囩銆佽鏍笺€佷环鏍肩瓑鏁扮粍瀛楁</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓爣绛炬帹鑽愮郴缁燂紝鍩轰簬鐢ㄦ埛鍘嗗彶琛屼负璁＄畻鐩镐技搴?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓伒娲荤殑閰嶇疆绠＄悊绯荤粺锛屼娇鐢ㄧ粨鏋勪綋瀛樺偍灞傜骇閰嶇疆</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// NULL 澶勭悊绔犺妭
// ============================================

export function NullHandlingSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">NULL 澶勭悊</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"涓夊€奸€昏緫涓庣己澶辨暟鎹殑鑹烘湳"</p>

      <Paragraph {...noteProps('p1')}>
        NULL 鍊间唬琛ㄧ己澶辨垨鏈煡鐨勬暟鎹€傚湪 SQL 涓紝NULL 鐨勫鐞嗛渶瑕佺壒鍒皬蹇冿紝鍥犱负瀹冨紩鍏ヤ簡涓夊€奸€昏緫锛圱RUE銆丗ALSE銆乁NKNOWN锛夛紝杩欎笌浼犵粺鐨勪簩鍊奸€昏緫鏈夊緢澶у樊寮傘€傛纭鐞?NULL 鍊兼槸鍐欏嚭鍙潬 SQL 鏌ヨ鐨勫叧閿€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">NULL 鐨勫熀鏈壒鎬?/h3>

      <SQLExplainer
        sql={`-- NULL 鍊肩殑鍩烘湰鐗规€?
SELECT
    NULL = NULL AS null_equals_null,      -- NULL锛圲NKNOWN锛?
    NULL <> NULL AS null_not_equals_null,  -- NULL锛圲NKNOWN锛?
    NULL IS NULL AS null_is_null,          -- TRUE
    NULL IS NOT NULL AS null_is_not_null,  -- FALSE

    -- 绠楁湳杩愮畻
    5 + NULL AS add_null,                  -- NULL
    10 * NULL AS multiply_null,            -- NULL

    -- 瀛楃涓茶繛鎺?
    'Hello ' || NULL AS concat_null,       -- NULL

    -- 閫昏緫杩愮畻
    TRUE AND NULL AS and_null,             -- NULL锛圲NKNOWN锛?
    FALSE OR NULL AS or_null,              -- NULL锛圲NKNOWN锛?
    NOT NULL AS not_null                   -- NULL锛圲NKNOWN锛?
FROM concepts LIMIT 1;`}
        explanations={[
          { code: 'NULL = NULL 鈫?UNKNOWN', explanation: 'NULL 鍊间笉鑳界敤绛変簬杩愮畻绗︽瘮杈?, tip: '杩欎笌鐩磋鐩稿弽锛? },
          { code: 'NULL IS NULL 鈫?TRUE', explanation: '妫€鏌ュ€兼槸鍚︿负 NULL 鐨勬纭柟娉?, tip: '浣跨敤 IS NULL 鎴?IS NOT NULL' },
          { code: '绠楁湳杩愮畻 + NULL 鈫?NULL', explanation: '浠讳綍杩愮畻娑夊強 NULL 閫氬父缁撴灉閮芥槸 NULL', tip: 'NULL 浼?姹℃煋"鏁翠釜琛ㄨ揪寮? },
          { code: 'TRUE AND NULL 鈫?UNKNOWN', explanation: '涓夊€奸€昏緫锛歍RUE銆丗ALSE銆乁NKNOWN', tip: 'WHERE 鏉′欢涓殑 UNKNOWN 琚涓?FALSE' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">NULL 鍊煎鐞嗗嚱鏁?/h3>

      <CodeBlock
        title="COALESCE 鍜?NULLIF"
        code={`-- COALESCE: 杩斿洖绗竴涓潪 NULL 鍊?
SELECT
    name,
    COALESCE(description, '鏆傛棤鎻忚堪') AS safe_description,
    COALESCE(parent_id, 0) AS safe_parent_id,
    COALESCE(email, phone, '鏃犺仈绯绘柟寮?) AS contact_info
FROM concepts c
LEFT JOIN contacts ct ON c.id = ct.concept_id;

-- NULLIF: 濡傛灉涓や釜鍊肩浉绛夎繑鍥?NULL锛屽惁鍒欒繑鍥炵涓€涓€?
SELECT
    name,
    price,
    NULLIF(price, 0) AS price_no_zero,  -- 浠锋牸涓?鏃惰繑鍥濶ULL
    NULLIF(discount, 0.0) AS valid_discount
FROM products;

-- 閬垮厤闄ら浂閿欒
SELECT
    name,
    sales,
    COALESCE(sales / NULLIF(quantity, 0), 0) AS avg_price
FROM products;

-- 绾ц仈 NULL 澶勭悊
SELECT
    customer_name,
    COALESCE(
        shipping_address,
        billing_address,
        '鍦板潃鏈～鍐?
    ) AS effective_address
FROM orders;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">IFNULL 涓?NVL</h3>

      <CodeBlock
        title="鏉′欢 NULL 澶勭悊"
        code={`-- IFNULL (MySQL椋庢牸) 鎴?NVL (Oracle椋庢牸)
-- DuckDB 鏀寔澶氱鍐欐硶
SELECT
    name,
    IFNULL(description, 'No description') AS desc_ifnull,
    COALESCE(description, 'No description') AS desc_coalesce
FROM concepts;

-- 澶嶆潅鏉′欢澶勭悊
SELECT
    product_name,
    original_price,
    discount_rate,
    CASE
        WHEN discount_rate IS NULL THEN original_price
        WHEN discount_rate >= 1.0 THEN 0  -- 100%鎶樻墸
        ELSE original_price * (1 - discount_rate)
    END AS final_price
FROM products;

-- NULL 鍊肩粺璁?
SELECT
    COUNT(*) AS total_products,
    COUNT(description) AS with_description,    -- NULL鍊间笉璁″叆
    COUNT(*) - COUNT(description) AS without_description,
    ROUND(100.0 * COUNT(description) / COUNT(*), 1) AS desc_coverage_pct
FROM products;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鑱氬悎鍑芥暟涓?NULL</h3>

      <CodeBlock
        title="鑱氬悎鍑芥暟濡備綍澶勭悊 NULL"
        code={`-- 鍒涘缓娴嬭瘯鏁版嵁
CREATE TABLE sales_data AS
SELECT * FROM (VALUES
    ('Product A', 100, NULL),
    ('Product B', 200, 10),
    ('Product C', NULL, 20),
    ('Product D', 300, NULL)
) AS t(product_name, sales_q1, sales_q2);

-- 鑱氬悎鍑芥暟瀵?NULL 鐨勫鐞?
SELECT
    COUNT(*) AS total_rows,           -- 4锛堝寘鎷琋ULL琛岋級
    COUNT(sales_q1) AS non_null_q1,   -- 3锛堟帓闄ULL锛?
    COUNT(sales_q2) AS non_null_q2,   -- 2锛堟帓闄ULL锛?

    SUM(sales_q1) AS sum_q1,          -- 600锛堝拷鐣ULL锛?
    AVG(sales_q1) AS avg_q1,          -- 200锛堝熀浜庨潪NULL鍊煎钩鍧囷級

    MIN(sales_q1) AS min_q1,          -- 100锛堝拷鐣ULL锛?
    MAX(sales_q1) AS max_q1           -- 300锛堝拷鐣ULL锛?
FROM sales_data;

-- 鎵嬪姩澶勭悊 NULL 鍦ㄨ仛鍚堜腑鐨勫奖鍝?
SELECT
    AVG(COALESCE(sales_q1, 0)) AS avg_including_nulls,
    AVG(sales_q1) AS avg_excluding_nulls,
    SUM(COALESCE(sales_q1, 0)) AS sum_including_nulls
FROM sales_data;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">JOIN 鏌ヨ涓殑 NULL 澶勭悊</h3>

      <CodeBlock
        title="澶勭悊杩炴帴涓殑 NULL 鍊?
        code={`-- LEFT JOIN 鍙兘浜х敓 NULL 鍊?
SELECT
    c.name AS concept_name,
    COALESCE(p.name, '鏍规蹇?) AS parent_name,
    COALESCE(c.parent_id, 0) AS safe_parent_id
FROM concepts c
LEFT JOIN concepts p ON c.parent_id = p.id;

-- 杩囨护 NULL 鍊?
SELECT *
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.id
WHERE c.id IS NOT NULL;  -- 鍙繚鐣欐湁瀹㈡埛淇℃伅鐨勮鍗?

-- 鎴栦娇鐢?INNER JOIN 閬垮厤 NULL
SELECT *
FROM orders o
INNER JOIN customers c ON o.customer_id = c.id;

-- 澶勭悊澶氬眰 NULL 宓屽
SELECT
    o.order_id,
    COALESCE(c.customer_name, '鏈煡瀹㈡埛') AS customer,
    COALESCE(p.product_name, '浜у搧宸蹭笅鏋?) AS product,
    COALESCE(o.quantity, 0) AS quantity,
    COALESCE(o.unit_price, 0) * COALESCE(o.quantity, 0) AS total_amount
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.id
LEFT JOIN products p ON o.product_id = p.id;`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">NULL 鍊肩殑鏈€浣冲疄璺?/h3>

      <InfoBox type="tip" title="NULL 澶勭悊鍘熷垯" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鏄庣‘璇箟锛?/strong> 鍖哄垎"鏈煡"鍜?涓嶅瓨鍦?鐨勬蹇?/li>
          <li><strong>浣跨敤绾︽潫锛?/strong> NOT NULL 绾︽潫闃叉鎰忓鐨?NULL 鍊?/li>
          <li><strong>鎻愪緵榛樿鍊硷細</strong> 鐢?COALESCE 鎻愪緵鏈夋剰涔夌殑榛樿鍊?/li>
          <li><strong>鏂囨。鍖栵細</strong> 鍦ㄦ暟鎹簱鏂囨。涓鏄庡摢浜涘瓧娈靛彲鑳戒负 NULL</li>
          <li><strong>娴嬭瘯瑕嗙洊锛?/strong> 纭繚鏌ヨ閫昏緫鑳芥纭鐞?NULL 鍊?/li>
        </ul>
      </InfoBox>

      <CodeBlock
        title="闃插尽鎬х紪绋嬫ā寮?
        code={`-- 瀹夊叏鐨勬暟鎹浆鎹㈠嚱鏁?
CREATE OR REPLACE FUNCTION safe_cast_to_int(value VARCHAR)
RETURNS INTEGER AS $$
    SELECT TRY_CAST(NULLIF(TRIM(value), '') AS INTEGER)
$$;

-- 瀹夊叏鐨勯櫎娉曡繍绠?
CREATE OR REPLACE FUNCTION safe_divide(numerator DECIMAL, denominator DECIMAL)
RETURNS DECIMAL AS $$
    SELECT CASE
        WHEN denominator = 0 OR denominator IS NULL THEN NULL
        ELSE numerator / denominator
    END
$$;

-- 搴旂敤绀轰緥
SELECT
    product_name,
    safe_cast_to_int(original_price_str) AS price,
    safe_divide(discounted_price, original_price) AS discount_ratio
FROM raw_product_data;`}
        {...noteProps('code5')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 鏁版嵁娓呮礂</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">澶勭悊缂哄け鍊笺€佹暟鎹爣鍑嗗寲銆佽川閲忔鏌?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃敆 鍙€夊叧鑱?/h4>
          <p className="text-sm text-green-600 dark:text-green-400">澶栬繛鎺ョ粨鏋滃鐞嗐€佸叧鑱旀暟鎹殑榛樿鍊?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搱 缁熻鍒嗘瀽</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">缂哄け鏁版嵁澶勭悊銆佸紓甯稿€兼娴嬨€佺ǔ鍋ョ粺璁?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃洝锔?鏁版嵁楠岃瘉</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">杈撳叆楠岃瘉銆佷笟鍔¤鍒欐鏌ャ€佹暟鎹畬鏁存€?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 璁捐涓€涓畬鏁寸殑NULL鍊煎鐞嗙瓥鐣ワ紝鍖呮嫭鏁版嵁瀵煎叆銆佹煡璇㈠拰瀵煎嚭</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓暟鎹川閲忚瘎鍒嗙郴缁燂紝鑰冭檻NULL鍊肩殑鍒嗗竷鍜屽奖鍝?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓€氱敤鐨凬ULL鍊煎～鍏呭嚱鏁帮紝鏀寔澶氱濉厖绛栫暐</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍦扮悊绌洪棿鍑芥暟绔犺妭
// ============================================

export function SpatialFunctionsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍦扮悊绌洪棿鍑芥暟</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"浣嶇疆鏁版嵁鐨勬煡璇笌鍒嗘瀽"</p>

      <Paragraph {...noteProps('p1')}>
        鍦扮悊绌洪棿鏁版嵁鏃犲涓嶅湪锛欸PS瀹氫綅銆佸湴鍥炬湇鍔°€佸湴鐞嗗洿鏍忋€佽矾寰勮鍒掔瓑銆侱uckDB 鏀寔涓板瘜鐨勫湴鐞嗙┖闂村嚱鏁帮紝鍙互楂樻晥澶勭悊鐐广€佺嚎銆侀潰绛夊嚑浣曟暟鎹紝杩涜璺濈璁＄畻銆佺┖闂村叧绯诲垽鏂€佸嚑浣曟搷浣滅瓑銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍑犱綍鏁版嵁绫诲瀷</h3>

      <CodeBlock
        title="鍒涘缓鍜屼娇鐢ㄥ嚑浣曟暟鎹?
        code={`-- 鍒涘缓鍖呭惈鍑犱綍瀛楁鐨勮〃
CREATE TABLE locations (
    id INTEGER,
    name VARCHAR,
    location GEOMETRY,        -- 閫氱敤鐨勫嚑浣曠被鍨?
    point_location GEOMETRY(POINT),     -- 鐐?
    area GEOMETRY(POLYGON)              -- 澶氳竟褰?
);

-- 鎻掑叆鍑犱綍鏁版嵁锛堜娇鐢╓KT鏍煎紡锛?
INSERT INTO locations VALUES
    (1, '鍏徃鎬婚儴', ST_GeomFromText('POINT(-122.4194 37.7749)'), ST_GeomFromText('POINT(-122.4194 37.7749)'), NULL),
    (2, '浠撳簱A', ST_GeomFromText('POINT(-122.0 37.5)'), ST_GeomFromText('POINT(-122.0 37.5)'), NULL),
    (3, '閰嶉€佸尯鍩?, NULL, NULL, ST_GeomFromText('POLYGON((-122.5 37.7, -122.3 37.7, -122.3 37.9, -122.5 37.9, -122.5 37.7))'));

-- 鏌ヨ鍑犱綍鏁版嵁
SELECT
    name,
    ST_AsText(location) AS wkt_location,
    ST_X(point_location) AS longitude,
    ST_Y(point_location) AS latitude
FROM locations;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">璺濈璁＄畻</h3>

      <SQLExplainer
        sql={`-- 璁＄畻涓ょ偣涔嬮棿鐨勮窛绂?
SELECT
    a.name AS location_a,
    b.name AS location_b,
    ST_Distance(a.location, b.location) AS distance_meters,
    ST_DistanceSphere(a.location, b.location) AS distance_sphere_meters
FROM locations a
CROSS JOIN locations b
WHERE a.id < b.id;

-- 鏌ユ壘闄勮繎鐨勫湴鐐?
SELECT
    target.name AS target_location,
    nearby.name AS nearby_location,
    ST_Distance(target.location, nearby.location) AS distance,
    ROUND(ST_Distance(target.location, nearby.location) / 1000, 2) AS distance_km
FROM locations target
CROSS JOIN locations nearby
WHERE target.name = '鍏徃鎬婚儴'
  AND nearby.name != '鍏徃鎬婚儴'
  AND ST_Distance(target.location, nearby.location) < 50000;  -- 50km鍐卄}
        explanations={[
          { code: 'ST_Distance(a, b)', explanation: '璁＄畻涓ゅ嚑浣曞璞′箣闂寸殑璺濈', tip: '浣跨敤绗涘崱灏斿潗鏍囩郴' },
          { code: 'ST_DistanceSphere(a, b)', explanation: '浣跨敤鐞冮潰璺濈锛堟洿閫傚悎鍦扮悆鍧愭爣锛?, tip: '鑰冭檻鍦扮悆鏇茬巼锛屽崟浣嶄负绫? },
          { code: 'CROSS JOIN', explanation: '璁＄畻鎵€鏈変綅缃箣闂寸殑璺濈鐭╅樀', tip: '澶ф暟鎹泦鏃惰璋ㄦ厧浣跨敤' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">绌洪棿鍏崇郴鍒ゆ柇</h3>

      <CodeBlock
        title="鍑犱綍瀵硅薄鐨勭┖闂村叧绯?
        code={`-- 鐐逛笌澶氳竟褰㈢殑鍏崇郴
SELECT
    l.name AS location_name,
    CASE
        WHEN ST_Contains(area.area_geom, l.location) THEN '鍐呴儴'
        WHEN ST_Touches(area.area_geom, l.location) THEN '杈圭晫涓?
        WHEN ST_DWithin(area.area_geom, l.location, 1000) THEN '闄勮繎'
        ELSE '澶栭儴'
    END AS relation_to_area
FROM locations l
CROSS JOIN (SELECT ST_GeomFromText('POLYGON((-123 37, -122 37, -122 38, -123 38, -123 37))') AS area_geom) area;

-- 绌洪棿鍏崇郴鍑芥暟
SELECT
    'Point A' AS geom_a,
    'Point B' AS geom_b,
    ST_Equals(a.location, b.location) AS equals,
    ST_Disjoint(a.location, b.location) AS disjoint,
    ST_Intersects(a.location, b.location) AS intersects
FROM locations a
CROSS JOIN locations b
WHERE a.name = '鍏徃鎬婚儴' AND b.name = '浠撳簱A';`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍑犱綍鏋勯€犱笌鎿嶄綔</h3>

      <CodeBlock
        title="鍒涘缓鍜屼慨鏀瑰嚑浣曞璞?
        code={`-- 鍒涘缓鍑犱綍瀵硅薄
SELECT
    ST_GeomFromText('POINT(0 0)') AS origin_point,
    ST_GeomFromText('LINESTRING(0 0, 1 1, 2 2)') AS diagonal_line,
    ST_GeomFromText('POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))') AS square,
    ST_Buffer(ST_GeomFromText('POINT(0 0)'), 1000) AS point_buffer;

-- 鍑犱綍鎿嶄綔
SELECT
    ST_Centroid(area) AS area_center,
    ST_Area(area) AS area_size,
    ST_Perimeter(area) AS perimeter,
    ST_NumPoints(ST_Boundary(area)) AS boundary_points
FROM (
    SELECT ST_GeomFromText('POLYGON((0 0, 2 0, 2 2, 0 2, 0 0))') AS area
) t;

-- 鍧愭爣绯昏浆鎹?
SELECT
    name,
    ST_AsText(location) AS original_wkt,
    ST_Transform(location, 4326, 3857) AS web_mercator,  -- WGS84 鍒?Web澧ㄥ崱鎵?
    ST_SRID(location) AS current_srid
FROM locations;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍦扮悊鍥存爮涓庡尯鍩熷垎鏋?/h3>

      <CodeBlock
        title="鍦扮悊鍥存爮搴旂敤"
        code={`-- 鍒涘缓閰嶉€佸尯鍩?
CREATE TABLE delivery_zones AS
SELECT * FROM (VALUES
    ('Downtown', ST_GeomFromText('POLYGON((-122.45 37.75, -122.35 37.75, -122.35 37.85, -122.45 37.85, -122.45 37.75))')),
    ('Suburb', ST_GeomFromText('POLYGON((-122.6 37.6, -122.4 37.6, -122.4 37.8, -122.6 37.8, -122.6 37.6))'))
) AS t(zone_name, zone_geom);

-- 璁㈠崟鍒嗛厤鍒伴厤閫佸尯鍩?
SELECT
    o.order_id,
    o.customer_location,
    dz.zone_name,
    ST_Distance(o.customer_location, ST_Centroid(dz.zone_geom)) AS distance_to_center
FROM orders o
CROSS JOIN delivery_zones dz
WHERE ST_Contains(dz.zone_geom, o.customer_location)
ORDER BY o.order_id, distance_to_center;

-- 鍖哄煙缁熻
SELECT
    dz.zone_name,
    COUNT(o.order_id) AS order_count,
    AVG(ST_Distance(o.customer_location, ST_Centroid(dz.zone_geom))) AS avg_distance_from_center
FROM delivery_zones dz
LEFT JOIN orders o ON ST_Contains(dz.zone_geom, o.customer_location)
GROUP BY dz.zone_name;`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="鍦扮悊绌洪棿鏁版嵁鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鍧愭爣绯伙細</strong> 鏄庣‘浣跨敤WGS84 (EPSG:4326) 鎴栨姇褰卞潗鏍囩郴</li>
          <li><strong>绱㈠紩锛?/strong> 涓哄嚑浣曞瓧娈靛垱寤虹┖闂寸储寮曚互鎻愰珮鏌ヨ鎬ц兘</li>
          <li><strong>绮惧害锛?/strong> 鏍规嵁搴旂敤闇€姹傞€夋嫨鍚堥€傜殑鍧愭爣绮惧害</li>
          <li><strong>楠岃瘉锛?/strong> 浣跨敤 ST_IsValid 楠岃瘉鍑犱綍瀵硅薄鐨勬湁鏁堟€?/li>
          <li><strong>绠€鍖栵細</strong> 瀵瑰鏉傚嚑浣曞璞′娇鐢?ST_Simplify 鎻愰珮鎬ц兘</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃殮 鐗╂祦閰嶉€?/h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">璺嚎浼樺寲銆侀厤閫佸尯鍩熷垝鍒嗐€佽窛绂昏绠?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搷 浣嶇疆鏈嶅姟</h4>
          <p className="text-sm text-green-600 dark:text-green-400">闄勮繎鎼滅储銆佸湴鐞嗗洿鏍忋€佸叴瓒ｇ偣鍙戠幇</p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃彊锔?鍩庡競瑙勫垝</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鍖哄煙鍒嗘瀽銆佸瘑搴﹁绠椼€佺┖闂村垎甯?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃搳 鍦扮悊鍙鍖?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鐑姏鍥剧敓鎴愩€佽仛绫诲垎鏋愩€佺┖闂寸粺璁?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鏋勫缓涓€涓畬鏁寸殑鍦扮悊浣嶇疆鎼滅储绯荤粺锛屾敮鎸侀檮杩戞煡鎵惧拰鍖哄煙杩囨护</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇鍦扮悊鍥存爮鎶ヨ绯荤粺锛屾娴嬪璞′綍鏃惰繘鍏ユ垨绂诲紑鎸囧畾鍖哄煙</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓绌洪棿鑱氱被鍒嗘瀽锛岃瘑鍒湴鐞嗘暟鎹殑鑷劧鍒嗙粍</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 搴忓垪鐢熸垚绔犺妭
// ============================================

export function SequenceGenerationSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">搴忓垪鐢熸垚</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鑷姩缂栧彿銆侀€掑搴忓垪涓庨殢鏈烘暟"</p>

      <Paragraph {...noteProps('p1')}>
        搴忓垪鐢熸垚鍑芥暟鐢ㄤ簬鍒涘缓鏈夊簭鐨勬暟瀛楀簭鍒椼€侀殢鏈烘暟銆侀€掑ID绛夈€傚湪鏁版嵁鍒嗘瀽銆佹祴璇曟暟鎹敓鎴愩€佹ā鎷熷疄楠岀瓑鍦烘櫙涓紝杩欎簺鍑芥暟鎻愪緵浜嗗己澶х殑鏁版嵁鐢熸垚鑳藉姏銆侱uckDB 鏀寔澶氱搴忓垪鐢熸垚鏂瑰紡锛屼粠绠€鍗曠殑鑼冨洿鐢熸垚鍒板鏉傜殑閫掑綊搴忓垪銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩烘湰搴忓垪鐢熸垚</h3>

      <SQLExplainer
        sql={`-- 鐢熸垚鏁板瓧搴忓垪
SELECT * FROM range(10);
-- 缁撴灉锛?, 1, 2, 3, 4, 5, 6, 7, 8, 9

-- 鎸囧畾鑼冨洿
SELECT * FROM range(5, 15);
-- 缁撴灉锛?, 6, 7, 8, 9, 10, 11, 12, 13, 14

-- 鎸囧畾姝ラ暱
SELECT * FROM range(0, 20, 5);
-- 缁撴灉锛?, 5, 10, 15

-- 闄嶅簭搴忓垪
SELECT * FROM range(10, 0, -1);
-- 缁撴灉锛?0, 9, 8, 7, 6, 5, 4, 3, 2, 1`}
        explanations={[
          { code: 'range(n)', explanation: '鐢熸垚浠?鍒皀-1鐨勫簭鍒?, tip: '鏈€绠€鍗曠殑搴忓垪鐢熸垚鏂瑰紡' },
          { code: 'range(start, end)', explanation: '鐢熸垚浠巗tart鍒癳nd-1鐨勫簭鍒?, tip: '鍖呭惈start锛屼笉鍖呭惈end' },
          { code: 'range(start, end, step)', explanation: '鎸囧畾姝ラ暱鐨勫簭鍒?, tip: 'step鍙鍙礋锛屾敮鎸侀檷搴? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇搴忓垪鎿嶄綔</h3>

      <CodeBlock
        title="搴忓垪鍙樻崲鍜岀粍鍚?
        code={`-- 鐢熸垚鏃ユ湡搴忓垪
SELECT
    date '2024-01-01' + INTERVAL (n) DAY AS date_series
FROM range(30) t(n);
-- 鐢熸垚2024骞?鏈堢殑姣忎竴澶?

-- 鐢熸垚鏃堕棿搴忓垪
SELECT
    timestamp '2024-01-01 00:00:00' +
    INTERVAL (n * 15) MINUTE AS time_slots
FROM range(96) t(n);  -- 24灏忔椂 * 4 (15鍒嗛挓闂撮殧)
-- 鐢熸垚涓€澶╀腑姣?5鍒嗛挓鐨勬椂闂寸偣

-- 绗涘崱灏旂Н鐢熸垚缁勫悎
SELECT
    products.name,
    sizes.size,
    colors.color
FROM (SELECT unnest(['T-Shirt', 'Hoodie', 'Pants']) AS name) products
CROSS JOIN (SELECT unnest(['S', 'M', 'L', 'XL']) AS size) sizes
CROSS JOIN (SELECT unnest(['Red', 'Blue', 'Green']) AS color) colors;
-- 鐢熸垚鎵€鏈変骇鍝併€佸昂瀵搞€侀鑹茬殑缁勫悎

-- 甯﹀簭鍙风殑搴忓垪
SELECT
    n,
    n * n AS square,
    CASE WHEN n % 2 = 0 THEN '鍋舵暟' ELSE '濂囨暟' END AS parity
FROM range(1, 11) t(n);`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">闅忔満鏁扮敓鎴?/h3>

      <CodeBlock
        title="闅忔満鏁板嚱鏁?
        code={`-- 鍩烘湰闅忔満鏁?
SELECT
    RANDOM() AS random_float,        -- 0.0 鍒?1.0 涔嬮棿鐨勯殢鏈烘诞鐐规暟
    RANDOM() * 100 AS random_0_100,  -- 0 鍒?100 涔嬮棿鐨勯殢鏈烘暟
    FLOOR(RANDOM() * 10) + 1 AS dice_roll  -- 1鍒?0鐨勯殢鏈烘暣鏁?
FROM range(5);

-- 闅忔満閫夋嫨
SELECT
    CASE FLOOR(RANDOM() * 3)
        WHEN 0 THEN '鐭冲ご'
        WHEN 1 THEN '鍓垁'
        WHEN 2 THEN '甯?
    END AS random_choice
FROM range(10);

-- 姝ｆ€佸垎甯冮殢鏈烘暟
SELECT
    -- 绠€鍗曠殑姝ｆ€佸垎甯冭繎浼硷紙Box-Muller鍙樻崲锛?
    SQRT(-2 * LN(RANDOM())) * COS(2 * PI() * RANDOM()) AS normal_random,
    SQRT(-2 * LN(RANDOM())) * SIN(2 * PI() * RANDOM()) AS normal_random_2
FROM range(1000);

-- 鍙噸鐜扮殑闅忔満搴忓垪锛堟寚瀹氱瀛愶級
SELECT n, RANDOM(12345) AS seeded_random
FROM range(10) t(n);
-- 姣忔杩愯缁撴灉鐩稿悓锛屼究浜庤皟璇昤}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">UNNEST 涓庢暟缁勫睍寮€</h3>

      <CodeBlock
        title="鏁扮粍杞搴忓垪"
        code={`-- 鍩烘湰 UNNEST
SELECT unnest([1, 2, 3, 4, 5]) AS numbers;
-- 缁撴灉锛氭瘡琛屼竴涓暟瀛?

-- 甯﹀簭鍙风殑灞曞紑
SELECT
    ROW_NUMBER() OVER () AS position,
    unnest(['Apple', 'Banana', 'Cherry']) AS fruit
FROM range(1) t;  -- 闇€瑕佷竴涓櫄鎷熻〃

-- 澶氭暟缁勫悓鏃跺睍寮€
SELECT
    ROW_NUMBER() OVER () AS id,
    unnest(['A', 'B', 'C']) AS letters,
    unnest([1, 2, 3]) AS numbers,
    unnest(['Red', 'Green', 'Blue']) AS colors
FROM range(1) t;

-- 瀛楃涓插垎鍓插睍寮€
SELECT
    sentence_id,
    word_number,
    word
FROM (
    SELECT
        sentence_id,
        unnest(string_split(sentences.text, ' ')) AS word,
        generate_series(1, length(sentences.text) - length(replace(sentences.text, ' ', '')) + 1) AS word_number
    FROM (
        SELECT 1 AS sentence_id, 'The quick brown fox jumps over the lazy dog' AS text
    ) sentences
) t;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">搴忓垪鐢熸垚鐨勯珮绾у簲鐢?/h3>

      <CodeBlock
        title="娴嬭瘯鏁版嵁鐢熸垚"
        code={`-- 鐢熸垚娴嬭瘯鐢ㄦ埛鏁版嵁
CREATE TABLE test_users AS
SELECT
    n AS user_id,
    'User_' || n AS username,
    'user' || n || '@example.com' AS email,
    date '2020-01-01' + INTERVAL (FLOOR(RANDOM() * 1460)) DAY AS registration_date,
    CASE FLOOR(RANDOM() * 4)
        WHEN 0 THEN 'Basic'
        WHEN 1 THEN 'Premium'
        WHEN 2 THEN 'Gold'
        WHEN 3 THEN 'Platinum'
    END AS subscription_level
FROM range(1, 1001) t(n);

-- 鐢熸垚閿€鍞褰?
CREATE TABLE test_sales AS
SELECT
    ROW_NUMBER() OVER () AS sale_id,
    FLOOR(RANDOM() * 1000) + 1 AS user_id,
    date '2024-01-01' + INTERVAL (FLOOR(RANDOM() * 365)) DAY AS sale_date,
    ROUND(RANDOM() * 500 + 10, 2) AS amount,
    unnest(['Electronics', 'Clothing', 'Books', 'Home', 'Sports']) AS category
FROM range(10000) t;

-- 鐢熸垚鍦扮悊鍧愭爣鏁版嵁
CREATE TABLE test_locations AS
SELECT
    n AS location_id,
    'Location_' || n AS name,
    -- 鐢熸垚绾界害甯傞檮杩戠殑闅忔満鍧愭爣
    40.7128 + (RANDOM() - 0.5) * 0.2 AS latitude,
    -74.0060 + (RANDOM() - 0.5) * 0.2 AS longitude
FROM range(1, 101) t(n);`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">閫掑綊搴忓垪鐢熸垚</h3>

      <CodeBlock
        title="浣跨敤閫掑綊鐢熸垚澶嶆潅搴忓垪"
        code={`-- 鐢熸垚鏂愭尝閭ｅ鏁板垪
WITH RECURSIVE fibonacci(n, a, b) AS (
    SELECT 1, 0, 1
    UNION ALL
    SELECT n + 1, b, a + b FROM fibonacci WHERE n < 20
)
SELECT n, a AS fibonacci_number FROM fibonacci;

-- 鐢熸垚鍒嗗舰搴忓垪锛堢璧洸绾跨偣锛?
WITH RECURSIVE koch_curve(level, x1, y1, x2, y2) AS (
    -- 鍩虹鎯呭喌锛氫竴鏉＄嚎娈?
    SELECT 0, 0.0, 0.0, 1.0, 0.0
    UNION ALL
    -- 閫掑綊鎯呭喌锛氬皢绾挎鏇挎崲涓?娈靛皬绾挎
    SELECT
        kc.level + 1,
        -- 璁＄畻绉戣但鏇茬嚎鐨勬柊鐐?
        kc.x1 + (kc.x2 - kc.x1) * 1/3,
        kc.y1 + (kc.y2 - kc.y1) * 1/3,
        kc.x1 + (kc.x2 - kc.x1) * 2/3,
        kc.y1 + (kc.y2 - kc.y1) * 2/3
    FROM koch_curve kc
    WHERE kc.level < 3
)
SELECT level, x1, y1, x2, y2 FROM koch_curve ORDER BY level;

-- 鐢熸垚鍐崇瓥鏍戣矾寰?
WITH RECURSIVE decision_paths(path, level) AS (
    SELECT '', 0
    UNION ALL
    SELECT
        dp.path || step,
        dp.level + 1
    FROM decision_paths dp
    CROSS JOIN (SELECT unnest(['A', 'B']) AS step) steps
    WHERE dp.level < 3
)
SELECT path, LENGTH(path) AS depth FROM decision_paths WHERE LENGTH(path) > 0;`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="搴忓垪鐢熸垚鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鎬ц兘鑰冭檻锛?/strong> 澶у簭鍒楃敓鎴愭椂娉ㄦ剰鍐呭瓨浣跨敤</li>
          <li><strong>鍙噸鐜版€э細</strong> 浣跨敤绉嶅瓙纭繚闅忔満缁撴灉鍙噸鐜?/li>
          <li><strong>杈圭晫澶勭悊锛?/strong> 娉ㄦ剰 range 鍑芥暟鐨勫寘鍚?鎺掗櫎杈圭晫</li>
          <li><strong>绫诲瀷鍖归厤锛?/strong> 纭繚搴忓垪鍏冪礌绫诲瀷涓庣洰鏍囧垪鍖归厤</li>
          <li><strong>缁勫悎浣跨敤锛?/strong> range銆乽nnest銆乬enerate_series 鍙粍鍚堜娇鐢?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃И 鏁版嵁娴嬭瘯</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鐢熸垚娴嬭瘯鏁版嵁銆佹ā鎷熷満鏅€佸帇鍔涙祴璇?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搳 鏃堕棿搴忓垪</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鏃ユ湡鑼冨洿鐢熸垚銆佹椂闂寸偣搴忓垪銆佸懆鏈熸€ф暟鎹?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃幉 妯℃嫙瀹為獙</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">闅忔満閲囨牱銆佹鐜囧垎甯冦€佽挋鐗瑰崱娲涙ā鎷?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃敘 ID鐢熸垚</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鑷姩缂栧彿銆佷富閿敓鎴愩€佸簭鍒楀彿鍒嗛厤</p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鍒涘缓涓€涓€氱敤鐨勬祴璇曟暟鎹敓鎴愬櫒锛屾敮鎸佸绉嶆暟鎹被鍨嬬殑闅忔満鐢熸垚</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓椂闂村簭鍒楀垎鏋愮郴缁燂紝鐢熸垚骞跺垎鏋愪笉鍚屾ā寮忕殑鏃跺簭鏁版嵁</p>
          <p><strong>鎸戞垬 3锛?/strong> 鏋勫缓涓€涓喅绛栨爲璺緞鐢熸垚鍣紝妯℃嫙澶嶆潅鐨勪笟鍔℃祦绋嬮€夋嫨</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍒楄〃鍑芥暟绔犺妭
// ============================================

export function ListFunctionsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍒楄〃鍑芥暟</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"澶勭悊鍒楄〃銆佹暟缁勫拰闆嗗悎鐨勯珮绾у伐鍏?</p>

      <Paragraph {...noteProps('p1')}>
        鍒楄〃鍑芥暟涓撻棬鐢ㄤ簬澶勭悊鏁扮粍銆佸垪琛ㄥ拰闆嗗悎鏁版嵁銆侱uckDB 鎻愪緵浜嗕赴瀵岀殑鍒楄〃鎿嶄綔鍑芥暟锛屾敮鎸佹帓搴忋€佽繃婊ゃ€佽仛鍚堛€佸彉鎹㈢瓑澶氱鎿嶄綔锛屾槸澶勭悊澶嶆潅鏁版嵁缁撴瀯鐨勯噸瑕佸伐鍏枫€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒楄〃鍒涘缓涓庡熀鏈搷浣?/h3>

      <SQLExplainer
        sql={`-- 鍒涘缓鍒楄〃
SELECT
    [1, 2, 3, 4, 5] AS numbers,
    ['apple', 'banana', 'cherry'] AS fruits,
    [] AS empty_list,
    [NULL, 'value', 42] AS mixed_list;

-- 鍒楄〃闀垮害鍜岃闂?
SELECT
    list_length([1, 2, 3]) AS len,           -- 3
    list_extract([1, 2, 3], 1) AS first,     -- 1 (1-绱㈠紩)
    list_extract([1, 2, 3], -1) AS last;     -- 3 (璐熺储寮曚粠鏈熬寮€濮?

-- 鍒楄〃鍒囩墖
SELECT
    list_slice([1, 2, 3, 4, 5], 2, 4) AS middle,  -- [2, 3, 4]
    list_slice([1, 2, 3, 4, 5], 1, 2) AS first_two; -- [1, 2]`}
        explanations={[
          { code: '[1, 2, 3]', explanation: '鏂规嫭鍙疯娉曞垱寤哄垪琛?, tip: '鏈€绠€鍗曞拰甯哥敤鐨勫垪琛ㄥ垱寤烘柟寮? },
          { code: 'list_length(list)', explanation: '鑾峰彇鍒楄〃闀垮害', tip: 'NULL 鍊间篃璁＄畻鍦ㄥ唴' },
          { code: 'list_extract(list, n)', explanation: '鎻愬彇绗琻涓厓绱?, tip: '鏀寔璐熺储寮曪紝浠庢湯灏惧紑濮? },
          { code: 'list_slice(list, start, end)', explanation: '鎻愬彇瀛愬垪琛?, tip: '鍖呭惈start锛屼笉鍖呭惈end' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒楄〃鍙樻崲涓庢搷浣?/h3>

      <CodeBlock
        title="鍒楄〃鎺掑簭銆佸幓閲嶅拰杩囨护"
        code={`-- 鍒楄〃鎺掑簭
SELECT
    list_sort([3, 1, 4, 1, 5]) AS sorted_asc,      -- [1, 1, 3, 4, 5]
    list_reverse(list_sort([3, 1, 4, 1, 5])) AS sorted_desc; -- [5, 4, 3, 1, 1]

-- 鍘婚噸
SELECT
    list_distinct([1, 2, 2, 3, 3, 3]) AS unique_numbers,  -- [1, 2, 3]
    list_distinct(['a', 'b', 'a', 'c']) AS unique_strings;  -- ['a', 'b', 'c']

-- 杩囨护
SELECT
    list_filter([1, 2, 3, 4, 5], x -> x > 3) AS greater_than_3,     -- [4, 5]
    list_filter(['apple', 'banana', 'cherry'], x -> length(x) > 5) AS long_fruits; -- ['banana', 'cherry']

-- 鍙樻崲
SELECT
    list_transform([1, 2, 3], x -> x * 2) AS doubled,                -- [2, 4, 6]
    list_transform(['hello', 'world'], x -> upper(x)) AS uppercased; -- ['HELLO', 'WORLD']`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒楄〃鑱氬悎涓庣粺璁?/h3>

      <CodeBlock
        title="鍒楄〃缁熻鍑芥暟"
        code={`-- 鏁板€煎垪琛ㄧ粺璁?
SELECT
    list_sum([1, 2, 3, 4, 5]) AS total,                    -- 15
    list_avg([1, 2, 3, 4, 5]) AS average,                  -- 3.0
    list_min([1, 2, 3, 4, 5]) AS minimum,                  -- 1
    list_max([1, 2, 3, 4, 5]) AS maximum,                  -- 5
    list_count([1, 2, 3, NULL, 5]) AS non_null_count;      -- 4

-- 鍒楄〃缁熻鐨勯珮绾х敤娉?
SELECT
    list_stddev([1, 2, 3, 4, 5]) AS std_deviation,
    list_variance([1, 2, 3, 4, 5]) AS variance,
    list_median([1, 2, 3, 4, 5]) AS median_value,
    list_mode([1, 2, 2, 3, 3, 3]) AS most_frequent;        -- 3

-- 鑷畾涔夎仛鍚?
SELECT
    list_aggregate([1, 2, 3, 4, 5], 0, (acc, x) -> acc + x) AS custom_sum,
    list_aggregate(['a', 'b', 'c'], '', (acc, x) -> acc || x) AS concatenation;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒楄〃缁勫悎涓庡垎鍓?/h3>

      <CodeBlock
        title="鍒楄〃鍚堝苟銆佸垎鍓插拰閲嶅"
        code={`-- 鍒楄〃鍚堝苟
SELECT
    list_concat([1, 2], [3, 4]) AS merged_list,           -- [1, 2, 3, 4]
    list_concat(['a', 'b'], ['c', 'd']) AS merged_strings; -- ['a', 'b', 'c', 'd']

-- 鍒楄〃鍘嬬缉锛堝幓闄ULL锛?
SELECT
    list_compact([1, NULL, 3, NULL, 5]) AS no_nulls;       -- [1, 3, 5]

-- 鍒楄〃灞曞钩
SELECT
    list_flatten([[1, 2], [3, 4], [5]]) AS flattened;       -- [1, 2, 3, 4, 5]

-- 鍒楄〃鍒嗙粍
SELECT
    list_group([1, 2, 3, 4, 5, 6], 2) AS pairs;            -- [[1, 2], [3, 4], [5, 6]]

-- 鍒楄〃杞疆
SELECT
    list_transpose([[1, 2, 3], [4, 5, 6]]) AS transposed;   -- [[1, 4], [2, 5], [3, 6]]

-- 瀛楃涓插垎鍓蹭负鍒楄〃
SELECT
    string_split('hello world duckdb', ' ') AS word_list,   -- ['hello', 'world', 'duckdb']
    string_split('a,b,c,d', ',') AS csv_values;              -- ['a', 'b', 'c', 'd']`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇鍒楄〃鎿嶄綔</h3>

      <CodeBlock
        title="澶嶆潅鍒楄〃澶勭悊"
        code={`-- 鍒楄〃浜ら泦銆佸苟闆嗐€佸樊闆?
SELECT
    list_intersect([1, 2, 3, 4], [3, 4, 5, 6]) AS intersection,  -- [3, 4]
    list_union([1, 2, 3], [3, 4, 5]) AS union_all,              -- [1, 2, 3, 3, 4, 5]
    list_distinct(list_union([1, 2, 3], [3, 4, 5])) AS union_distinct, -- [1, 2, 3, 4, 5]
    list_difference([1, 2, 3, 4], [2, 3]) AS difference;         -- [1, 4]

-- 鍒楄〃鎺掑簭鍜屾悳绱?
SELECT
    list_sort([3, 1, 4, 1, 5], 'DESC') AS sorted_desc,
    list_contains([1, 2, 3, 4, 5], 3) AS contains_3,            -- true
    list_indexof([1, 2, 3, 4, 5], 3) AS index_of_3,             -- 2
    list_position([1, 2, 3, 4, 5], 3) AS position_of_3;         -- 2

-- 鍒楄〃閲囨牱鍜岄€夋嫨
SELECT
    list_sample([1, 2, 3, 4, 5], 3) AS random_sample,           -- 闅忔満閫夋嫨3涓?
    list_topk([1, 2, 3, 4, 5], 3) AS top_3,                     -- [5, 4, 3]
    list_topk([1, 2, 3, 4, 5], 3, 'ASC') AS bottom_3;           -- [1, 2, 3]

-- 鏉′欢澶勭悊
SELECT
    list_if([true, false, true], [1, 2, 3], [0, 0, 0]) AS conditional_list, -- [1, 0, 3]
    list_any([true, false, true]) AS any_true,                    -- true
    list_all([true, false, true]) AS all_true;                    -- false`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <CodeBlock
        title="涓氬姟鏁版嵁澶勭悊绀轰緥"
        code={`-- 鐢靛晢璁㈠崟澶勭悊
SELECT
    order_id,
    list_length(items) AS item_count,
    list_sum(list_transform(prices, p -> p * quantities)) AS total_amount,
    list_max(prices) AS most_expensive_item,
    list_distinct(categories) AS unique_categories
FROM orders;

-- 鐢ㄦ埛鏍囩鍒嗘瀽
SELECT
    user_id,
    list_length(tags) AS tag_count,
    list_topk(list_count_tags, 5) AS top_interests,
    list_contains(tags, 'premium') AS is_premium,
    list_intersect(user_tags, campaign_tags) AS matching_tags
FROM user_profiles;

-- 鏃堕棿搴忓垪鏁版嵁澶勭悊
SELECT
    sensor_id,
    list_avg(temperature_readings) AS avg_temp,
    list_stddev(temperature_readings) AS temp_variation,
    list_filter(temperature_readings, t -> t > 30) AS high_temp_readings,
    list_count(list_filter(temperature_readings, t -> t > threshold)) AS alert_count
FROM sensor_data;`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="鍒楄〃鍑芥暟浣跨敤寤鸿" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>绫诲瀷涓€鑷存€э細</strong> 鍒楄〃涓殑鍏冪礌绫诲瀷搴旇淇濇寔涓€鑷?/li>
          <li><strong>NULL 澶勭悊锛?/strong> 娉ㄦ剰 NULL 鍊煎鍒楄〃鎿嶄綔鐨勫奖鍝?/li>
          <li><strong>鎬ц兘鑰冭檻锛?/strong> 澶у垪琛ㄦ搷浣滄椂娉ㄦ剰鍐呭瓨浣跨敤</li>
          <li><strong>绱㈠紩浠?寮€濮嬶細</strong> list_extract 浣跨敤1-绱㈠紩锛屼笌 SQL 鏁扮粍涔犳儻涓€鑷?/li>
          <li><strong>鍑芥暟缁勫悎锛?/strong> 澶氫釜鍒楄〃鍑芥暟鍙互宓屽浣跨敤鏋勫缓澶嶆潅閫昏緫</li>
        </ul>
      </InfoBox>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 鏁版嵁鍒嗘瀽</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">澶氬€煎瓧娈电粺璁°€佹暟缁勬暟鎹仛鍚堛€佸鏉傝绠?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃彿锔?鏍囩绯荤粺</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鐢ㄦ埛鏍囩绠＄悊銆佸唴瀹瑰垎绫汇€佸叴瓒ｅ垎鏋?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搱 鏃堕棿搴忓垪</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">婊戝姩绐楀彛璁＄畻銆佽秼鍔垮垎鏋愩€佸紓甯告娴?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃敡 ETL 澶勭悊</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鏁版嵁娓呮礂銆佹牸寮忚浆鎹€佸瓧娈甸噸濉?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓伒娲荤殑鍒楄〃澶勭悊宸ュ叿绠憋紝鏀寔鎺掑簭銆佽繃婊ゃ€佽仛鍚堢瓑鎿嶄綔</p>
          <p><strong>鎸戞垬 2锛?/strong> 鍒涘缓涓€涓敤鎴锋爣绛惧垎鏋愮郴缁燂紝璁＄畻鏍囩閲嶅彔搴﹀拰鐩镐技搴?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鏋勫缓涓€涓椂闂村簭鍒楀紓甯告娴嬪櫒锛屼娇鐢ㄥ垪琛ㄥ嚱鏁板垎鏋愬巻鍙叉暟鎹ā寮?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍔犲瘑鍑芥暟绔犺妭
// ============================================

export function CryptoFunctionsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍔犲瘑鍑芥暟</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鏁版嵁瀹夊叏涓庨殣绉佷繚鎶ょ殑宸ュ叿"</p>

      <Paragraph {...noteProps('p1')}>
        鍔犲瘑鍑芥暟鐢ㄤ簬淇濇姢鏁忔劅鏁版嵁瀹夊叏锛屽寘鎷搱甯屽嚱鏁般€佸绉板姞瀵嗐€侀潪瀵圭О鍔犲瘑绛夈€侱uckDB 鎻愪緵浜嗗绉嶅姞瀵嗙畻娉曪紝鏀寔鏁版嵁鑴辨晱銆佹暟瀛楃鍚嶃€佸畬鏁存€ч獙璇佺瓑瀹夊叏鍔熻兘銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍝堝笇鍑芥暟</h3>

      <SQLExplainer
        sql={`-- MD5 鍝堝笇锛堜笉鎺ㄨ崘鐢ㄤ簬瀹夊叏鍦烘櫙锛?
SELECT md5('password') AS md5_hash;

-- SHA-256 鍝堝笇锛堟帹鑽愶級
SELECT sha256('sensitive_data') AS sha256_hash;

-- SHA-512 鍝堝笇锛堟洿楂樺畨鍏ㄦ€э級
SELECT sha512('very_sensitive_data') AS sha512_hash;

-- 鍏朵粬鍝堝笇绠楁硶
SELECT
    md5('data') AS md5,
    sha1('data') AS sha1,
    sha256('data') AS sha256,
    sha384('data') AS sha384,
    sha512('data') AS sha512;`}
        explanations={[
          { code: 'md5(text)', explanation: 'MD5 鍝堝笇鍑芥暟', tip: '宸蹭笉鎺ㄨ崘鐢ㄤ簬瀹夊叏鍦烘櫙锛屽鏄撶鎾? },
          { code: 'sha256(text)', explanation: 'SHA-256 瀹夊叏鍝堝笇鍑芥暟', tip: '鐩墠鏈€甯哥敤鐨勫畨鍏ㄥ搱甯岀畻娉? },
          { code: 'sha512(text)', explanation: 'SHA-512 鍝堝笇鍑芥暟', tip: '鎻愪緵鏈€楂樺畨鍏ㄦ€э紝閫熷害绋嶆參' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍝堝笇搴旂敤鍦烘櫙</h3>

      <CodeBlock
        title="鏁版嵁瀹屾暣鎬ч獙璇佸拰闅愮淇濇姢"
        code={`-- 鍒涘缓鐢ㄦ埛琛紙瀵嗙爜鍝堝笇瀛樺偍锛?
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR NOT NULL,
    password_hash VARCHAR NOT NULL,
    email VARCHAR,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 瀵嗙爜鍝堝笇瀛樺偍锛堝疄闄呭簲鐢ㄤ腑搴斿姞鐩愶級
INSERT INTO users (username, password_hash, email)
VALUES
    ('alice', sha256('password123'), 'alice@example.com'),
    ('bob', sha256('secret456'), 'bob@example.com');

-- 瀵嗙爜楠岃瘉
SELECT
    username,
    CASE WHEN password_hash = sha256('password123')
         THEN '瀵嗙爜姝ｇ‘' ELSE '瀵嗙爜閿欒' END AS auth_result
FROM users
WHERE username = 'alice';

-- 鏁版嵁瀹屾暣鎬ф鏌?
CREATE TABLE file_checksums (
    filename VARCHAR,
    file_hash VARCHAR,
    computed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 璁＄畻鏂囦欢鍝堝笇
SELECT
    filename,
    sha256(file_content) AS file_hash
FROM files;

-- 楠岃瘉鏂囦欢鏄惁琚鏀?
SELECT
    f.filename,
    CASE WHEN f.file_hash = c.file_hash
         THEN '鏂囦欢瀹屾暣' ELSE '鏂囦欢琚慨鏀? END AS integrity_check
FROM files f
LEFT JOIN file_checksums c ON f.filename = c.filename;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏁版嵁鑴辨晱涓庡尶鍚嶅寲</h3>

      <CodeBlock
        title="浣跨敤鍝堝笇杩涜鏁版嵁鑴辨晱"
        code={`-- 閭鑴辨晱锛堜繚鐣欏煙淇℃伅锛?
SELECT
    id,
    username,
    -- 鑴辨晱閭锛歶ser@domain.com -> u***@domain.com
    regexp_replace(email, '^(.).*(.@.*)$', '\\1***\\2') AS masked_email,
    -- 閭鍝堝笇锛堢敤浜庡幓鏍囪瘑鍖栵級
    sha256(lower(email)) AS email_hash
FROM users;

-- 鐢佃瘽鍙风爜鑴辨晱
SELECT
    phone_number,
    -- 淇濈暀鍓?鍚?浣嶏細13812345678 -> 138****5678
    regexp_replace(phone_number, '^(\\d{3})\\d{4}(\\d{4})$', '\\1****\\2') AS masked_phone,
    -- 鍝堝笇瀛樺偍
    sha256(phone_number) AS phone_hash
FROM contacts;

-- 濮撳悕鍖垮悕鍖?
SELECT
    full_name,
    -- 淇濈暀濮撴皬锛氬紶涓変赴 -> 寮?*
    regexp_replace(full_name, '^(.).*$', '\\1**') AS masked_name,
    -- 鍝堝笇鐢ㄤ簬缁熻鍒嗘瀽
    sha256(lower(full_name)) AS name_hash
FROM customers;

-- 鍦板潃淇℃伅鑴辨晱
SELECT
    address,
    -- 鍦板潃鍝堝笇锛堝畬鍏ㄥ尶鍚嶅寲锛?
    sha256(lower(address)) AS address_hash,
    -- 淇濈暀鐪佸競淇℃伅锛氬寳浜競鏈濋槼鍖?-> 鍖椾含甯?*
    regexp_replace(address, '^([^鍖哄幙]+鍖哄幙).*$', '\\1**') AS masked_address
FROM addresses;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">HMAC 涓庡瘑閽ュ搱甯?/h3>

      <CodeBlock
        title="甯﹀瘑閽ョ殑鍝堝笇鍑芥暟"
        code={`-- HMAC-SHA256锛堟秷鎭璇佺爜锛?
SELECT
    hmac('my_secret_key', 'important_message', 'sha256') AS message_auth_code,
    hmac('api_key', 'request_data', 'sha256') AS api_signature;

-- 瀵嗙爜鍔犵洂鍝堝笇锛堟帹鑽愮殑瀹夊叏瀹炶返锛?
SELECT
    username,
    -- 妯℃嫙鍔犵洂鍝堝笇锛氬疄闄呭簲鐢ㄤ腑搴斾娇鐢ㄤ笓鐢ㄥ瘑鐮佸搱甯屽嚱鏁?
    sha256('salt123' || password || 'pepper456') AS salted_hash,
    -- 鏇村畨鍏ㄧ殑鍋氭硶锛氫娇鐢?PBKDF2 鎴?Argon2锛堝鏋滄敮鎸侊級
    sha256(username || password) AS user_specific_hash
FROM user_credentials;

-- API 璇锋眰绛惧悕楠岃瘉
SELECT
    request_body,
    provided_signature,
    hmac('server_secret', request_body, 'sha256') AS computed_signature,
    CASE WHEN provided_signature = hmac('server_secret', request_body, 'sha256')
         THEN '绛惧悕鏈夋晥' ELSE '绛惧悕鏃犳晥' END AS signature_check
FROM api_requests;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍔犲瘑涓庤В瀵嗗嚱鏁?/h3>

      <CodeBlock
        title="瀵圭О鍔犲瘑绠楁硶"
        code={`-- AES 鍔犲瘑锛堝鏋滄敮鎸侊級
-- 娉ㄦ剰锛氬疄闄呭姞瀵嗗嚱鏁板彲鑳藉洜 DuckDB 鐗堟湰鑰屽紓
SELECT
    encrypt('sensitive_data', 'encryption_key', 'aes-256-cbc') AS encrypted_data,
    decrypt(encrypted_data, 'encryption_key', 'aes-256-cbc') AS decrypted_data
FROM sensitive_table;

-- 绠€鍗曠殑鏁版嵁娣锋穯锛堜笉鎺ㄨ崘鐢ㄤ簬鐪熷疄鍔犲瘑锛?
SELECT
    data,
    -- ROT13 绠€鍗曟浛鎹紙浠呯敤浜庢紨绀猴級
    translate(data, 'abcdefghijklmnopqrstuvwxyz',
                   'nopqrstuvwxyzabcdefghijklm') AS obfuscated,
    -- 鏇村鏉傜殑娣锋穯
    encode(data::bytea, 'base64') AS base64_encoded,
    decode(base64_encoded, 'base64')::text AS base64_decoded
FROM sample_data;`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹夊叏鏈€浣冲疄璺?/h3>

      <InfoBox type="warning" title="鍔犲瘑瀹夊叏娉ㄦ剰浜嬮」" {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>涓嶈浣跨敤 MD5锛?/strong> MD5 宸蹭笉瀹夊叏锛屽鏄撹纰版挒鏀诲嚮</li>
          <li><strong>瀵嗙爜鍝堝笇锛?/strong> 瀵嗙爜搴斾娇鐢ㄤ笓闂ㄧ殑瀵嗙爜鍝堝笇鍑芥暟锛屽 bcrypt銆乻crypt</li>
          <li><strong>鍔犵洂澶勭悊锛?/strong> 鍝堝笇鍓嶆坊鍔犻殢鏈虹洂鍊硷紝闃叉褰╄櫣琛ㄦ敾鍑?/li>
          <li><strong>瀵嗛挜绠＄悊锛?/strong> 鍔犲瘑瀵嗛挜搴斿畨鍏ㄥ瓨鍌紝瀹氭湡杞崲</li>
          <li><strong>浼犺緭瀹夊叏锛?/strong> 鏁忔劅鏁版嵁浼犺緭搴斾娇鐢?HTTPS 鎴?TLS</li>
          <li><strong>娉曡鍚堣锛?/strong> 浜嗚В GDPR銆丆CPA 绛夐殣绉佷繚鎶ゆ硶瑙勮姹?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃攼 鐢ㄦ埛璁よ瘉</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">瀵嗙爜鍝堝笇瀛樺偍銆佸畨鍏ㄧ櫥褰曢獙璇併€佷細璇濈鐞?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搳 鏁版嵁闅愮</h4>
          <p className="text-sm text-green-600 dark:text-green-400">PII 鏁版嵁鑴辨晱銆佸尶鍚嶅寲澶勭悊銆侀殣绉佷繚鎶?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃敆 API 瀹夊叏</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">璇锋眰绛惧悕楠岃瘉銆丄PI瀵嗛挜绠＄悊銆侀槻姝㈤噸鏀炬敾鍑?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">鉁?鏁版嵁瀹屾暣鎬?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鏂囦欢鏍￠獙鍜屻€佹秷鎭璇併€佹暟瀛楃鍚?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓畬鏁寸殑瀹夊叏鐢ㄦ埛娉ㄥ唽鍜岀櫥褰曠郴缁燂紝鍖呮嫭瀵嗙爜鍝堝笇鍜岄獙璇?/p>
          <p><strong>鎸戞垬 2锛?/strong> 鍒涘缓涓€涓暟鎹劚鏁忓伐鍏凤紝鏀寔澶氱鏁版嵁绫诲瀷鐨勫尶鍚嶅寲澶勭悊</p>
          <p><strong>鎸戞垬 3锛?/strong> 鏋勫缓涓€涓?API 璇锋眰绛惧悕鍜岄獙璇佺郴缁燂紝闃叉璇锋眰绡℃敼鍜岄噸鏀炬敾鍑?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 澶栭儴鏁版嵁婧愮珷鑺?
// ============================================

export function ExternalSourcesSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">澶栭儴鏁版嵁婧?/h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"杩炴帴澶栭儴涓栫晫鐨勬ˉ姊?</p>

      <Paragraph {...noteProps('p1')}>
        DuckDB 涓嶄粎浠呮槸鐙珛鐨勬暟鎹簱锛屽畠杩樺彲浠ユ棤缂濊繛鎺ュ悇绉嶅閮ㄦ暟鎹簮銆備粠鍏崇郴鍨嬫暟鎹簱鍒颁簯瀛樺偍锛屼粠 API 鍒版秷鎭槦鍒楋紝DuckDB 鎻愪緵浜嗕赴瀵岀殑杩炴帴鍣ㄥ拰璁块棶鏂规硶锛岃浣犺兘澶熷儚鏌ヨ鏈湴琛ㄤ竴鏍锋煡璇㈠閮ㄦ暟鎹€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍏崇郴鍨嬫暟鎹簱杩炴帴</h3>

      <SQLExplainer
        sql={`-- 杩炴帴 PostgreSQL 鏁版嵁搴?
INSTALL postgres;
LOAD postgres;

-- 鍒涘缓杩炴帴瀛楃涓?
ATTACH 'postgresql://user:password@localhost:5432/mydb' AS pg_db (TYPE postgres);

-- 鏌ヨ杩滅▼ PostgreSQL 琛?
SELECT *
FROM pg_db.remote_table
WHERE status = 'active';

-- 鑱斿悎鏌ヨ锛氭湰鍦?DuckDB + 杩滅▼ PostgreSQL
SELECT
    l.local_id,
    l.local_data,
    r.remote_info
FROM local_table l
LEFT JOIN pg_db.remote_table r ON l.id = r.id;`}
        explanations={[
          { code: 'INSTALL postgres; LOAD postgres;', explanation: '瀹夎鍜屽姞杞?PostgreSQL 鎵╁睍', tip: '闇€瑕佸厛瀹夎鎵╁睍鎵嶈兘浣跨敤' },
          { code: 'ATTACH ... AS pg_db (TYPE postgres)', explanation: '鍒涘缓鍒?PostgreSQL 鏁版嵁搴撶殑杩炴帴', tip: '杩炴帴瀛楃涓插寘鍚璇佷俊鎭? },
          { code: 'FROM pg_db.remote_table', explanation: '鍍忔煡璇㈡湰鍦拌〃涓€鏍锋煡璇㈣繙绋嬭〃', tip: '閫忔槑鐨勫閮ㄦ暟鎹闂? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">浜戝瓨鍌ㄩ泦鎴?/h3>

      <CodeBlock
        title="AWS S3 鍜屼簯瀛樺偍璁块棶"
        code={`-- 閰嶇疆 AWS 鍑嵁锛堢幆澧冨彉閲忔垨閰嶇疆鏂囦欢锛?
SET s3_region='us-west-2';
SET s3_access_key_id='your-access-key';
SET s3_secret_access_key='your-secret-key';

-- 鐩存帴鏌ヨ S3 涓婄殑 CSV 鏂囦欢
SELECT *
FROM read_csv('s3://my-bucket/data/sales.csv')
WHERE date >= '2024-01-01';

-- 鏌ヨ Parquet 鏂囦欢
SELECT
    customer_id,
    SUM(amount) AS total_amount
FROM read_parquet('s3://my-bucket/parquet/sales/*.parquet')
GROUP BY customer_id;

-- 鍐欏叆鏁版嵁鍒?S3
COPY (
    SELECT *
    FROM local_table
    WHERE created_date >= '2024-01-01'
) TO 's3://my-bucket/archive/recent_data.csv' (FORMAT CSV);

-- 鍒楀嚭 S3 瀛樺偍妗跺唴瀹?
SELECT *
FROM glob('s3://my-bucket/data/**/*.csv');`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">HTTP API 鏁版嵁璁块棶</h3>

      <CodeBlock
        title="閫氳繃 HTTP 璁块棶澶栭儴 API 鏁版嵁"
        code={`-- 鏌ヨ REST API 鏁版嵁锛堥渶瑕?httpfs 鎵╁睍锛?
INSTALL httpfs;
LOAD httpfs;

-- 鐩存帴鏌ヨ JSON API
SELECT *
FROM read_json('https://api.github.com/repos/duckdb/duckdb/issues?state=open');

-- 鏌ヨ CSV API 绔偣
SELECT
    symbol,
    price,
    change_percent
FROM read_csv('https://api.example.com/stocks.csv')
WHERE change_percent > 5.0;

-- 甯﹁璇佺殑 API 璁块棶
SELECT *
FROM read_json(
    'https://api.example.com/private/data',
    headers={'Authorization': 'Bearer your-token-here'}
);

-- 缁勫悎澶氫釜 API 璋冪敤
WITH api1 AS (
    SELECT * FROM read_json('https://api1.example.com/data')
),
api2 AS (
    SELECT * FROM read_json('https://api2.example.com/data')
)
SELECT
    a1.id,
    a1.name,
    a2.status
FROM api1 a1
JOIN api2 a2 ON a1.id = a2.id;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">澶ф暟鎹郴缁熼泦鎴?/h3>

      <CodeBlock
        title="杩炴帴澶ф暟鎹敓鎬佺郴缁?
        code={`-- Apache Arrow 闆嗘垚
INSTALL arrow;
LOAD arrow;

-- 璇诲彇 Arrow 鏂囦欢
SELECT *
FROM arrow_scan('data.arrow')
WHERE timestamp >= '2024-01-01';

-- Iceberg 琛ㄦ牸寮忔敮鎸?
INSTALL iceberg;
LOAD iceberg;

-- 鏌ヨ Iceberg 琛?
SELECT *
FROM iceberg_scan('s3://warehouse/db/table/', version => '2');

-- Delta Lake 鏀寔
INSTALL delta;
LOAD delta;

-- 鏌ヨ Delta Lake 琛?
SELECT *
FROM delta_scan('s3://bucket/path/to/delta-table');

-- 杩炴帴 Apache Spark
-- 閫氳繃 Arrow 鎴?Parquet 涓棿鏍煎紡浜ゆ崲鏁版嵁
SELECT *
FROM read_parquet('hdfs://namenode:port/path/to/spark/output/*.parquet');`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">缂撳瓨鍜屾€ц兘浼樺寲</h3>

      <CodeBlock
        title="澶栭儴鏁版嵁鏌ヨ浼樺寲"
        code={`-- 鍒涘缓澶栭儴琛ㄨ鍥撅紙甯︾紦瀛橈級
CREATE VIEW cached_external_data AS
SELECT *
FROM read_parquet('s3://bucket/large-dataset.parquet')
WHERE date >= '2024-01-01';

-- 棰勮繃婊ゅ閮ㄦ暟鎹?
SELECT *
FROM read_csv('https://data.example.com/large-file.csv')
WHERE column_filter = 'important_value'
ORDER BY priority_column
LIMIT 1000;

-- 浣跨敤鐗╁寲瑙嗗浘缂撳瓨棰戠箒鏌ヨ
CREATE MATERIALIZED VIEW daily_stats AS
SELECT
    DATE_TRUNC('day', timestamp) AS day,
    COUNT(*) AS records,
    AVG(value) AS avg_value
FROM read_parquet('s3://bucket/streaming-data/*.parquet')
WHERE timestamp >= CURRENT_DATE - INTERVAL 30 DAY
GROUP BY DATE_TRUNC('day', timestamp);

-- 澧為噺鍒锋柊鐗╁寲瑙嗗浘
REFRESH MATERIALIZED VIEW daily_stats;`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="澶栭儴鏁版嵁婧愭渶浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>瀹夊叏璁よ瘉锛?/strong> 浣跨敤鏈€灏忔潈闄愬師鍒欙紝閬垮厤鏄庢枃瀛樺偍鍑嵁</li>
          <li><strong>杩炴帴姹狅細</strong> 閲嶇敤杩炴帴閬垮厤棰戠箒寤虹珛/鏂紑寮€閿€</li>
          <li><strong>鏁版嵁棰勮锛?/strong> 鍏堢敤 LIMIT 棰勮澶ф暟鎹泦缁撴瀯</li>
          <li><strong>缂撳瓨绛栫暐锛?/strong> 瀵归绻佽闂殑澶栭儴鏁版嵁浣跨敤鐗╁寲瑙嗗浘</li>
          <li><strong>閿欒澶勭悊锛?/strong> 瀹炵幇閲嶈瘯鏈哄埗澶勭悊缃戠粶涓嶇ǔ瀹?/li>
          <li><strong>鎴愭湰鎺у埗锛?/strong> 鐩戞帶浜戝瓨鍌ㄨ闂鐜囧拰璐圭敤</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彚 鏁版嵁浠撳簱</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">杩炴帴澶氫釜鏁版嵁婧愯繘琛岃仈鍚堝垎鏋?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搳 瀹炴椂浠〃鏉?/h4>
          <p className="text-sm text-green-600 dark:text-green-400">浠庡涓?API 鑱氬悎瀹炴椂鏁版嵁</p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃攧 ETL 绠￠亾</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">浠庡閮ㄦ簮鎻愬彇锛岃浆鎹㈠悗鍔犺浇</p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃搱 涓存椂鍒嗘瀽</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">蹇€熻繛鎺ュ閮ㄦ暟鎹繘琛屾帰绱㈡€у垎鏋?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鏋勫缓涓€涓婧愭暟鎹仛鍚堝櫒锛屼粠涓嶅悓 API 鏀堕泦骞舵暣鍚堟暟鎹?/p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓櫤鑳界紦瀛樺眰锛岃嚜鍔ㄧ鐞嗗閮ㄦ暟鎹殑鏈湴缂撳瓨</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓暟鎹簮鐩戞帶绯荤粺锛岃窡韪閮ㄨ繛鎺ョ殑鍋ュ悍鐘舵€佸拰鎬ц兘</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 澧為噺澶勭悊绔犺妭
// ============================================

export function IncrementalProcessingSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">澧為噺澶勭悊</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"楂樻晥澶勭悊鏁版嵁鍙樻洿"</p>

      <Paragraph {...noteProps('p1')}>
        鍦ㄥぇ鏁版嵁鏃朵唬锛屽叏閲忔暟鎹鐞嗗線寰€浠ｄ环楂樻槀銆傚閲忓鐞嗘妧鏈厑璁告垜浠彧澶勭悊鏂板鎴栧彉鏇寸殑鏁版嵁锛屽ぇ澶ф彁楂樺鐞嗘晥鐜囧拰闄嶄綆璧勬簮娑堣€椼€侱uckDB 鎻愪緵浜嗗绉嶅閲忓鐞嗘ā寮忓拰宸ュ叿銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏃堕棿鎴?based 澧為噺</h3>

      <SQLExplainer
        sql={`-- 鍒涘缓甯︽椂闂存埑鐨勮〃
CREATE TABLE user_events (
    user_id INTEGER,
    event_type VARCHAR,
    event_data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 璁板綍鏈€鍚庡鐞嗘椂闂?
CREATE TABLE processing_state (
    table_name VARCHAR PRIMARY KEY,
    last_processed TIMESTAMP
);

-- 澧為噺鎻愬彇鏂版暟鎹?
INSERT INTO processing_state VALUES ('user_events', '2024-01-01 00:00:00');

SELECT *
FROM user_events
WHERE created_at > (SELECT last_processed FROM processing_state WHERE table_name = 'user_events')
ORDER BY created_at;

-- 鏇存柊澶勭悊鐘舵€?
UPDATE processing_state
SET last_processed = (SELECT MAX(created_at) FROM user_events)
WHERE table_name = 'user_events';`}
        explanations={[
          { code: 'created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP', explanation: '鑷姩璁板綍鏁版嵁鍒涘缓鏃堕棿', tip: '涓哄閲忓鐞嗘彁渚涙椂闂村熀鍑? },
          { code: 'WHERE created_at > last_processed', explanation: '鍙鐞嗘柊澧炴暟鎹?, tip: '鍩轰簬鏃堕棿鎴崇殑澧為噺杩囨护' },
          { code: 'UPDATE processing_state', explanation: '璁板綍澶勭悊杩涘害', tip: '纭繚涓嬫澶勭悊鑳戒粠姝ｇ‘浣嶇疆寮€濮? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鐗堟湰鍙峰拰鍙樻洿杩借釜</h3>

      <CodeBlock
        title="浣跨敤鐗堟湰鍙疯繘琛屽閲忓悓姝?
        code={`-- 甯︾増鏈彿鐨勮〃璁捐
CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    name VARCHAR,
    price DECIMAL,
    version INTEGER DEFAULT 1,
    last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 鍙樻洿鍘嗗彶琛?
CREATE TABLE product_changes (
    product_id INTEGER,
    change_type VARCHAR, -- 'INSERT', 'UPDATE', 'DELETE'
    old_data JSON,
    new_data JSON,
    version INTEGER,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 瑙﹀彂鍣ㄨ嚜鍔ㄨ褰曞彉鏇?
CREATE TRIGGER product_change_trigger
    AFTER INSERT OR UPDATE OR DELETE ON products
    FOR EACH ROW EXECUTE FUNCTION log_product_change();

-- 澧為噺鍚屾鍒颁笅娓哥郴缁?
SELECT
    pc.product_id,
    pc.change_type,
    pc.new_data,
    pc.version
FROM product_changes pc
WHERE pc.version > (SELECT COALESCE(MAX(version), 0) FROM downstream_sync)
ORDER BY pc.version;

-- 搴旂敤鍙樻洿鍒颁笅娓歌〃
INSERT OR REPLACE INTO downstream_products
SELECT
    id, name, price, version, last_modified
FROM products
WHERE version > (SELECT COALESCE(MAX(version), 0) FROM downstream_products);`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">姘村嵃锛圵atermark锛夋妧鏈?/h3>

      <CodeBlock
        title="娴佸紡鏁版嵁鐨勬按鍗板鐞?
        code={`-- 鍒涘缓姘村嵃琛?
CREATE TABLE watermarks (
    stream_name VARCHAR PRIMARY KEY,
    watermark_value VARCHAR, -- 鍙互鏄椂闂存埑銆両D绛?
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 娴佸紡鏁版嵁澶勭悊
CREATE TABLE stream_events (
    event_id VARCHAR PRIMARY KEY,
    event_type VARCHAR,
    event_data JSON,
    event_timestamp TIMESTAMP,
    processed BOOLEAN DEFAULT FALSE
);

-- 鑾峰彇鏈鐞嗙殑浜嬩欢锛堝熀浜庢按鍗帮級
WITH latest_watermark AS (
    SELECT watermark_value::TIMESTAMP AS watermark
    FROM watermarks
    WHERE stream_name = 'user_events'
)
SELECT *
FROM stream_events
WHERE event_timestamp > (SELECT watermark FROM latest_watermark)
  AND processed = FALSE
ORDER BY event_timestamp;

-- 鏇存柊姘村嵃锛堝鐞嗗畬鎴愪竴鎵规暟鎹悗锛?
UPDATE watermarks
SET watermark_value = (
    SELECT MAX(event_timestamp)::VARCHAR
    FROM stream_events
    WHERE processed = TRUE
)
WHERE stream_name = 'user_events';

-- 鏍囪宸插鐞?
UPDATE stream_events
SET processed = TRUE
WHERE event_timestamp <= (
    SELECT watermark_value::TIMESTAMP
    FROM watermarks
    WHERE stream_name = 'user_events'
);`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">澧為噺鑱氬悎</h3>

      <CodeBlock
        title="澧為噺璁＄畻鑱氬悎缁撴灉"
        code={`-- 鑱氬悎鐘舵€佽〃
CREATE TABLE aggregation_state (
    group_key VARCHAR,
    current_sum DECIMAL DEFAULT 0,
    current_count INTEGER DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (group_key)
);

-- 鏂板鏁版嵁
CREATE TABLE new_sales (
    product_id INTEGER,
    amount DECIMAL,
    sale_time TIMESTAMP
);

-- 澧為噺鏇存柊鑱氬悎
INSERT INTO aggregation_state (group_key, current_sum, current_count)
SELECT
    product_id::VARCHAR,
    SUM(amount),
    COUNT(*)
FROM new_sales
WHERE sale_time > (SELECT COALESCE(MAX(last_updated), '1970-01-01') FROM aggregation_state)
GROUP BY product_id
ON CONFLICT (group_key) DO UPDATE SET
    current_sum = aggregation_state.current_sum + EXCLUDED.current_sum,
    current_count = aggregation_state.current_count + EXCLUDED.current_count,
    last_updated = CURRENT_TIMESTAMP;

-- 鏌ヨ褰撳墠鑱氬悎缁撴灉
SELECT
    group_key,
    current_sum,
    current_count,
    current_sum / NULLIF(current_count, 0) AS avg_amount
FROM aggregation_state;

-- 娓呯悊宸插鐞嗙殑鍘熷鏁版嵁锛堝彲閫夛級
DELETE FROM new_sales
WHERE sale_time <= (SELECT MIN(last_updated) FROM aggregation_state);`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">CDC锛堝彉鏇存暟鎹崟鑾凤級</h3>

      <CodeBlock
        title="瀹炵幇鍙樻洿鏁版嵁鎹曡幏"
        code={`-- CDC 鍙樻洿鏃ュ織琛?
CREATE TABLE change_log (
    table_name VARCHAR,
    operation VARCHAR, -- 'INSERT', 'UPDATE', 'DELETE'
    primary_key JSON, -- 涓婚敭鍊?
    old_values JSON,  -- 鏃у€硷紙UPDATE/DELETE锛?
    new_values JSON,  -- 鏂板€硷紙INSERT/UPDATE锛?
    change_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    change_id SERIAL PRIMARY KEY
);

-- 妯℃嫙 CDC 瑙﹀彂鍣ㄥ嚱鏁?
CREATE OR REPLACE FUNCTION capture_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO change_log (table_name, operation, primary_key, new_values)
        VALUES (TG_TABLE_NAME, 'INSERT', json_build_object('id', NEW.id), row_to_json(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO change_log (table_name, operation, primary_key, old_values, new_values)
        VALUES (TG_TABLE_NAME, 'UPDATE', json_build_object('id', OLD.id), row_to_json(OLD), row_to_json(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO change_log (table_name, operation, primary_key, old_values)
        VALUES (TG_TABLE_NAME, 'DELETE', json_build_object('id', OLD.id), row_to_json(OLD));
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- 涓鸿〃娣诲姞 CDC 瑙﹀彂鍣?
CREATE TRIGGER users_cdc_trigger
    AFTER INSERT OR UPDATE OR DELETE ON users
    FOR EACH ROW EXECUTE FUNCTION capture_changes();

-- 娑堣垂鍙樻洿浜嬩欢
SELECT *
FROM change_log
WHERE change_id > (SELECT COALESCE(MAX(processed_change_id), 0) FROM cdc_consumer_state)
ORDER BY change_id;

-- 鏇存柊娑堣垂鐘舵€?
UPDATE cdc_consumer_state
SET processed_change_id = (SELECT MAX(change_id) FROM change_log);`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="澧為噺澶勭悊鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>骞傜瓑鎬э細</strong> 纭繚閲嶅澶勭悊鐩稿悓鏁版嵁涓嶄細浜х敓鍓綔鐢?/li>
          <li><strong>浜嬪姟涓€鑷存€э細</strong> 鐘舵€佹洿鏂板拰鏁版嵁澶勭悊鍦ㄥ悓涓€浜嬪姟涓?/li>
          <li><strong>瀹归敊鏈哄埗锛?/strong> 瀹炵幇閲嶈瘯鍜岄敊璇仮澶嶉€昏緫</li>
          <li><strong>鐩戞帶鍛婅锛?/strong> 鐩戞帶澶勭悊寤惰繜鍜岀Н鍘嬫儏鍐?/li>
          <li><strong>鏁版嵁娓呯悊锛?/strong> 瀹氭湡娓呯悊宸插鐞嗙殑鏃ф暟鎹?/li>
          <li><strong>鎬ц兘鐩戞帶锛?/strong> 璺熻釜澧為噺澶勭悊鐨勬€ц兘鎸囨爣</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 瀹炴椂浠〃鏉?/h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鎸佺画鏇存柊缁熻鏁版嵁锛岄伩鍏嶅叏閲忛噸绠?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃攧 鏁版嵁鍚屾</h4>
          <p className="text-sm text-green-600 dark:text-green-400">楂樻晥鍚屾鏁版嵁鍙樻洿鍒板涓笅娓哥郴缁?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搱 瓒嬪娍鍒嗘瀽</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">瀹炴椂鏇存柊瓒嬪娍鎸囨爣鍜岄娴嬫ā鍨?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃彈锔?缂撳瓨绠＄悊</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鏅鸿兘缂撳瓨澶辨晥鍜屽閲忔洿鏂扮瓥鐣?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓畬鏁寸殑 CDC 绯荤粺锛屾敮鎸佸琛ㄥ彉鏇存崟鑾峰拰涓嬫父鍚屾</p>
          <p><strong>鎸戞垬 2锛?/strong> 鏋勫缓涓€涓閲忚仛鍚堝紩鎿庯紝鏀寔澶嶆潅缁熻鎸囨爣鐨勫疄鏃舵洿鏂?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓櫤鑳芥按鍗扮鐞嗙郴缁燂紝鑷姩澶勭悊涔卞簭鏁版嵁鍜屽欢杩熷埌杈?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 娴佸紡澶勭悊绔犺妭
// ============================================

export function StreamingProcessingSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">娴佸紡澶勭悊</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"瀹炴椂鏁版嵁娴佺殑榄旀硶"</p>

      <Paragraph {...noteProps('p1')}>
        娴佸紡澶勭悊璁╂暟鎹湪浜х敓鏃跺氨鑳借瀹炴椂鍒嗘瀽鍜屽鐞嗭紝鑰屼笉鏄瓑寰呮暟鎹Н绱€侱uckDB 鏀寔澶氱娴佸紡鏁版嵁婧愬拰澶勭悊妯″紡锛屽彲浠ユ瀯寤哄疄鏃朵华琛ㄦ澘銆佸紓甯告娴嬬郴缁熴€佸嵆鏃舵帹鑽愬紩鎿庣瓑搴旂敤銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">娴佸紡鏁版嵁婧愰泦鎴?/h3>

      <SQLExplainer
        sql={`-- 杩炴帴 Kafka 娴?
INSTALL kafka;
LOAD kafka;

-- 鍒涘缓 Kafka 娑堣垂鑰?
CREATE TABLE kafka_events AS
SELECT *
FROM kafka(
    bootstrap_servers = 'localhost:9092',
    topic = 'user_events',
    group_id = 'duckdb_processor'
);

-- 瀹炴椂澶勭悊 Kafka 娑堟伅
SELECT
    event_type,
    COUNT(*) AS event_count,
    AVG(event_value) AS avg_value
FROM kafka_events
WHERE event_timestamp >= CURRENT_TIMESTAMP - INTERVAL 1 MINUTE
GROUP BY event_type;`}
        explanations={[
          { code: 'INSTALL kafka; LOAD kafka;', explanation: '瀹夎鍜屽姞杞?Kafka 鎵╁睍', tip: '闇€瑕佸厛瀹夎鐩稿叧鎵╁睍' },
          { code: 'FROM kafka(...)', explanation: '鐩存帴浠?Kafka 涓婚娑堣垂鏁版嵁', tip: '鏀寔澶氱閰嶇疆鍙傛暟' },
          { code: 'WHERE event_timestamp >= CURRENT_TIMESTAMP - INTERVAL 1 MINUTE', explanation: '瀹炴椂澶勭悊鏈€杩?鍒嗛挓鐨勬暟鎹?, tip: '鍩轰簬鏃堕棿绐楀彛鐨勬祦寮忓鐞? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏃堕棿绐楀彛鑱氬悎</h3>

      <CodeBlock
        title="婊戝姩绐楀彛鍜屾粴鍔ㄧ獥鍙?
        code={`-- 鍒涘缓娴佸紡浜嬩欢琛?
CREATE TABLE stream_events (
    event_id VARCHAR,
    user_id INTEGER,
    event_type VARCHAR,
    event_value DECIMAL,
    event_time TIMESTAMP
);

-- 婊氬姩鏃堕棿绐楀彛锛堝浐瀹氱獥鍙ｏ級
SELECT
    window_start,
    window_end,
    user_id,
    COUNT(*) AS events_count,
    SUM(event_value) AS total_value
FROM (
    SELECT *,
           TIME_BUCKET(INTERVAL 5 MINUTE, event_time) AS window_start,
           TIME_BUCKET(INTERVAL 5 MINUTE, event_time) + INTERVAL 5 MINUTE AS window_end
    FROM stream_events
    WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 1 HOUR
) t
GROUP BY window_start, window_end, user_id
ORDER BY window_start, user_id;

-- 婊戝姩绐楀彛锛堥噸鍙犵獥鍙ｏ級
WITH sliding_windows AS (
    SELECT
        user_id,
        event_time,
        event_value,
        -- 姣忓垎閽熸粦鍔ㄤ竴娆★紝绐楀彛澶у皬5鍒嗛挓
        LAG(event_time, 4) OVER (
            PARTITION BY user_id
            ORDER BY event_time
            ROWS BETWEEN 4 PRECEDING AND CURRENT ROW
        ) AS window_start,
        event_time AS window_end
    FROM stream_events
    WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 1 HOUR
)
SELECT
    user_id,
    window_start,
    window_end,
    COUNT(*) AS events_in_window,
    AVG(event_value) AS avg_value_in_window
FROM sliding_windows
WHERE window_start IS NOT NULL
GROUP BY user_id, window_start, window_end;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹炴椂寮傚父妫€娴?/h3>

      <CodeBlock
        title="鍩轰簬缁熻鐨勫紓甯告娴?
        code={`-- 璁＄畻瀹炴椂缁熻鎸囨爣
WITH recent_stats AS (
    SELECT
        user_id,
        AVG(event_value) AS mean_value,
        STDDEV(event_value) AS stddev_value,
        COUNT(*) AS event_count
    FROM stream_events
    WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 30 MINUTE
    GROUP BY user_id
),
latest_events AS (
    SELECT *
    FROM stream_events
    WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 5 MINUTE
)
SELECT
    le.user_id,
    le.event_value,
    le.event_time,
    rs.mean_value,
    rs.stddev_value,
    -- Z-score 寮傚父妫€娴?
    (le.event_value - rs.mean_value) / NULLIF(rs.stddev_value, 0) AS z_score,
    CASE
        WHEN ABS((le.event_value - rs.mean_value) / NULLIF(rs.stddev_value, 0)) > 3
        THEN '寮傚父'
        ELSE '姝ｅ父'
    END AS anomaly_status
FROM latest_events le
JOIN recent_stats rs ON le.user_id = rs.user_id
ORDER BY ABS((le.event_value - rs.mean_value) / NULLIF(rs.stddev_value, 0)) DESC;

-- 鍩轰簬鐧惧垎浣嶆暟鐨勫紓甯告娴?
WITH percentile_stats AS (
    SELECT
        user_id,
        APPROXIMATE_PERCENTILE(event_value, 0.25) AS q1,
        APPROXIMATE_PERCENTILE(event_value, 0.75) AS q3,
        APPROXIMATE_MEDIAN(event_value) AS median_value
    FROM stream_events
    WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 1 HOUR
    GROUP BY user_id
)
SELECT
    le.user_id,
    le.event_value,
    ps.q1,
    ps.q3,
    ps.median_value,
    -- IQR 鏂规硶妫€娴嬪紓甯?
    (ps.q3 - ps.q1) * 1.5 AS iqr_threshold,
    CASE
        WHEN le.event_value < ps.q1 - (ps.q3 - ps.q1) * 1.5
          OR le.event_value > ps.q3 + (ps.q3 - ps.q1) * 1.5
        THEN '寮傚父'
        ELSE '姝ｅ父'
    END AS outlier_status
FROM stream_events le
JOIN percentile_stats ps ON le.user_id = ps.user_id
WHERE le.event_time >= CURRENT_TIMESTAMP - INTERVAL 5 MINUTE;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">娴佸紡 JOIN 鎿嶄綔</h3>

      <CodeBlock
        title="瀹炴椂鏁版嵁鍏宠仈"
        code={`-- 鐢ㄦ埛淇℃伅娴?
CREATE TABLE user_stream (
    user_id INTEGER,
    user_name VARCHAR,
    user_region VARCHAR,
    update_time TIMESTAMP
);

-- 浜嬩欢娴?
CREATE TABLE event_stream (
    event_id VARCHAR,
    user_id INTEGER,
    event_type VARCHAR,
    event_value DECIMAL,
    event_time TIMESTAMP
);

-- 娴佸紡 JOIN锛氬疄鏃跺叧鑱旂敤鎴峰拰浜嬩欢
SELECT
    e.event_id,
    COALESCE(u.user_name, '鏈煡鐢ㄦ埛') AS user_name,
    COALESCE(u.user_region, '鏈煡鍦板尯') AS user_region,
    e.event_type,
    e.event_value,
    e.event_time
FROM event_stream e
LEFT JOIN user_stream u ON e.user_id = u.user_id
WHERE e.event_time >= CURRENT_TIMESTAMP - INTERVAL 10 MINUTE
  AND (u.update_time IS NULL OR u.update_time >= CURRENT_TIMESTAMP - INTERVAL 1 HOUR);

-- 绐楀彛鍖?JOIN锛堝鐞嗘椂闂村欢杩燂級
WITH event_window AS (
    SELECT *
    FROM event_stream
    WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 15 MINUTE
),
user_window AS (
    SELECT *
    FROM user_stream
    WHERE update_time >= CURRENT_TIMESTAMP - INTERVAL 1 HOUR
)
SELECT
    ew.event_id,
    uw.user_name,
    ew.event_type,
    ew.event_value,
    -- 璁＄畻鍏宠仈寤惰繜
    EXTRACT(EPOCH FROM (ew.event_time - uw.update_time)) AS join_delay_seconds
FROM event_window ew
LEFT JOIN user_window uw ON ew.user_id = uw.user_id
ORDER BY ew.event_time DESC;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">娴佸紡鏁版嵁鎸佷箙鍖?/h3>

      <CodeBlock
        title="瀹炴椂鏁版嵁钀藉湴鍜屽巻鍙插綊妗?
        code={`-- 鍒涘缓鍒嗗尯琛ㄧ敤浜庡巻鍙叉暟鎹瓨鍌?
CREATE TABLE event_history (
    event_id VARCHAR,
    user_id INTEGER,
    event_type VARCHAR,
    event_value DECIMAL,
    event_time TIMESTAMP,
    partition_date DATE GENERATED ALWAYS AS (event_time::DATE) STORED
) PARTITION BY partition_date;

-- 瀹炴椂鏁版嵁澶勭悊鍜屽瓨鍌?
CREATE OR REPLACE FUNCTION process_stream_event(
    p_event_id VARCHAR,
    p_user_id INTEGER,
    p_event_type VARCHAR,
    p_event_value DECIMAL,
    p_event_time TIMESTAMP
) RETURNS VOID AS $$
BEGIN
    -- 鎻掑叆鍘嗗彶琛?
    INSERT INTO event_history (event_id, user_id, event_type, event_value, event_time)
    VALUES (p_event_id, p_user_id, p_event_type, p_event_value, p_event_time);

    -- 鏇存柊瀹炴椂鑱氬悎琛?
    INSERT INTO realtime_aggregates (user_id, event_type, total_value, event_count, last_update)
    VALUES (p_user_id, p_event_type, p_event_value, 1, p_event_time)
    ON CONFLICT (user_id, event_type) DO UPDATE SET
        total_value = realtime_aggregates.total_value + p_event_value,
        event_count = realtime_aggregates.event_count + 1,
        last_update = p_event_time;

    -- 妫€鏌ユ槸鍚﹂渶瑕佽Е鍙戝憡璀?
    IF p_event_value > 1000 THEN
        INSERT INTO alerts (event_id, alert_type, alert_message, created_at)
        VALUES (p_event_id, 'HIGH_VALUE', '楂樹环鍊间簨浠舵娴?, CURRENT_TIMESTAMP);
    END IF;
END;
$$ LANGUAGE plpgsql;

-- 鑷姩褰掓。杩囨湡鏁版嵁
CREATE OR REPLACE FUNCTION archive_old_data() RETURNS VOID AS $$
BEGIN
    -- 灏?0澶╁墠鐨勬暟鎹Щ鍔ㄥ埌褰掓。琛?
    INSERT INTO event_archive
    SELECT * FROM event_history
    WHERE partition_date < CURRENT_DATE - INTERVAL 30 DAY;

    -- 鍒犻櫎宸插綊妗ｇ殑鏁版嵁
    DELETE FROM event_history
    WHERE partition_date < CURRENT_DATE - INTERVAL 30 DAY;
END;
$$ LANGUAGE plpgsql;

-- 璁剧疆瀹氭椂浠诲姟
SELECT cron.schedule('archive-old-data', '0 2 * * *', 'SELECT archive_old_data();');`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="娴佸紡澶勭悊鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>姘村嵃绠＄悊锛?/strong> 澶勭悊涔卞簭鏁版嵁鍜屽欢杩熷埌杈剧殑浜嬩欢</li>
          <li><strong>鐘舵€佺鐞嗭細</strong> 鎺у埗鐘舵€佸ぇ灏忥紝閬垮厤鍐呭瓨婧㈠嚭</li>
          <li><strong>瀹归敊鏈哄埗锛?/strong> 瀹炵幇妫€鏌ョ偣鍜屾晠闅滄仮澶?/li>
          <li><strong>鎬ц兘鐩戞帶锛?/strong> 鐩戞帶澶勭悊寤惰繜鍜屽悶鍚愰噺</li>
          <li><strong>璧勬簮鎺у埗锛?/strong> 璁剧疆鍚堢悊鐨勫唴瀛樺拰CPU浣跨敤闄愬埗</li>
          <li><strong>鏁版嵁璐ㄩ噺锛?/strong> 瀹炵幇鏁版嵁楠岃瘉鍜屾竻鐞嗛€昏緫</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 瀹炴椂浠〃鏉?/h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">瀹炴椂鏇存柊缁熻鍥捐〃鍜孠PI鎸囨爣</p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃毃 寮傚父妫€娴?/h4>
          <p className="text-sm text-green-600 dark:text-green-400">瀹炴椂鐩戞帶绯荤粺鎸囨爣鍜屼笟鍔″紓甯?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃幆 鍗虫椂鎺ㄨ崘</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鍩轰簬瀹炴椂琛屼负鐨勭敤鎴蜂釜鎬у寲鎺ㄨ崘</p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃挵 瀹炴椂椋庢帶</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">浜ゆ槗鐩戞帶銆佹璇堟娴嬨€侀闄╄瘎浼?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鏋勫缓涓€涓疄鏃跺紓甯告娴嬬郴缁燂紝鐩戞帶鐢ㄦ埛琛屼负妯″紡骞跺憡璀?/p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓祦寮忔帹鑽愬紩鎿庯紝鏍规嵁鐢ㄦ埛瀹炴椂琛屼负璋冩暣鎺ㄨ崘缁撴灉</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓疄鏃朵华琛ㄦ澘锛屾敮鎸佸鏁版嵁婧愯仛鍚堝拰鍔ㄦ€佹洿鏂?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// Delta Lake 绔犺妭
// ============================================

export function DeltaLakeSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">Delta Lake</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鏁版嵁婀栫殑鏂版爣鍑?</p>

      <Paragraph {...noteProps('p1')}>
        Delta Lake 鏄竴涓紑婧愬瓨鍌ㄥ眰锛屼负鏁版嵁婀栧甫鏉CID浜嬪姟銆佹ā寮忓己鍒躲€佹椂闂存梾琛岀瓑浼佷笟绾х壒鎬с€侱uckDB 鎻愪緵浜嗗師鐢熺殑 Delta Lake 鏀寔锛岃浣犲彲浠ュ儚鏌ヨ鏅€氳〃涓€鏍锋煡璇㈠拰鎿嶄綔 Delta Lake 琛ㄣ€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">杩炴帴 Delta Lake</h3>

      <SQLExplainer
        sql={`-- 瀹夎 Delta Lake 鎵╁睍
INSTALL delta;
LOAD delta;

-- 璇诲彇 Delta Lake 琛?
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/')
LIMIT 10;

-- 鎸囧畾鐗堟湰璇诲彇
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', version => 5);

-- 璇诲彇鏃堕棿鏃呰鏁版嵁
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', timestamp => '2024-01-01 12:00:00');

-- 鏌ヨ琛ㄥ巻鍙?
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', show_history => true);`}
        explanations={[
          { code: 'INSTALL delta; LOAD delta;', explanation: '瀹夎鍜屽姞杞?Delta Lake 鎵╁睍', tip: '闇€瑕佸厛瀹夎鎵╁睍鎵嶈兘浣跨敤' },
          { code: 'delta_scan(path)', explanation: '鎵弿 Delta Lake 琛?, tip: '鏀寔澶氱瀛樺偍鍚庣' },
          { code: 'version => 5', explanation: '璇诲彇鐗瑰畾鐗堟湰鐨勬暟鎹?, tip: '鏀寔鏃堕棿鏃呰鍔熻兘' },
          { code: 'timestamp => ...', explanation: '鎸夋椂闂寸偣璇诲彇鍘嗗彶鏁版嵁', tip: '绮剧‘鐨勬椂闂存梾琛? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">ACID 浜嬪姟鏀寔</h3>

      <CodeBlock
        title="浜嬪姟鎿嶄綔鍜屽苟鍙戞帶鍒?
        code={`-- 鍒涘缓 Delta Lake 琛?
CREATE TABLE delta_table (
    id INTEGER,
    name VARCHAR,
    value DECIMAL
) USING DELTA LOCATION 's3://my-bucket/delta-table/';

-- 鎻掑叆鏁版嵁锛堣嚜鍔ㄤ簨鍔★級
INSERT INTO delta_table VALUES
    (1, 'Alice', 100.0),
    (2, 'Bob', 200.0);

-- 鏇存柊鎿嶄綔锛堜簨鍔℃€э級
UPDATE delta_table
SET value = value * 1.1
WHERE id = 1;

-- 鍒犻櫎鎿嶄綔锛堜簨鍔℃€э級
DELETE FROM delta_table
WHERE value < 150;

-- 澶嶆潅浜嬪姟
BEGIN;
    INSERT INTO delta_table VALUES (3, 'Charlie', 300.0);
    UPDATE delta_table SET value = value + 50 WHERE name = 'Bob';
    DELETE FROM delta_table WHERE id = 1;
COMMIT;

-- 鏌ョ湅浜嬪姟鍘嗗彶
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', show_history => true)
ORDER BY version DESC;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">妯″紡婕旇繘</h3>

      <CodeBlock
        title="鍔ㄦ€佹ā寮忓拰妯″紡寮哄埗"
        code={`-- 鍚敤妯″紡婕旇繘
SET delta.enableChangeDataFeed = true;

-- 娣诲姞鏂板垪锛堟ā寮忔紨杩涳級
ALTER TABLE delta_table ADD COLUMN category VARCHAR;

-- 鏇存柊鏁版嵁锛堝寘鎷柊鍒楋級
UPDATE delta_table
SET category = CASE
    WHEN value >= 200 THEN 'Premium'
    ELSE 'Standard'
END;

-- 璇诲彇鏃惰嚜鍔ㄥ悎骞舵ā寮?
SELECT
    id,
    name,
    value,
    COALESCE(category, 'Uncategorized') AS category
FROM delta_scan('s3://my-bucket/delta-table/');

-- 妯″紡楠岃瘉锛堜弗鏍兼ā寮忥級
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', schema_mode => 'strict');

-- 妯″紡婕旇繘锛堝鏉炬ā寮忥級
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', schema_mode => 'permissive');`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏃堕棿鏃呰鍜屽璁?/h3>

      <CodeBlock
        title="鍘嗗彶鏁版嵁鏌ヨ鍜屽璁?
        code={`-- 鏌ョ湅琛ㄥ巻鍙茬増鏈?
SELECT
    version,
    timestamp,
    operation,
    operationParameters,
    operationMetrics
FROM delta_scan('s3://my-bucket/delta-table/', show_history => true)
ORDER BY version DESC;

-- 鎸夋椂闂寸偣鏌ヨ鍘嗗彶鏁版嵁
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', timestamp => '2024-01-01 10:30:00');

-- 鎸夌増鏈彿鏌ヨ
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', version => 3);

-- 姣旇緝涓嶅悓鐗堟湰鐨勬暟鎹樊寮?
WITH version5 AS (
    SELECT * FROM delta_scan('s3://my-bucket/delta-table/', version => 5)
),
version10 AS (
    SELECT * FROM delta_scan('s3://my-bucket/delta-table/', version => 10)
)
SELECT
    COALESCE(v5.id, v10.id) AS id,
    v5.name AS name_v5,
    v10.name AS name_v10,
    v5.value AS value_v5,
    v10.value AS value_v10
FROM version5 v5
FULL OUTER JOIN version10 v10 ON v5.id = v10.id
WHERE v5.name != v10.name OR v5.value != v10.value;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">浼樺寲鍜岀淮鎶?/h3>

      <CodeBlock
        title="琛ㄤ紭鍖栧拰鏂囦欢绠＄悊"
        code={`-- 鍘嬬缉灏忔枃浠讹紙浼樺寲瀛樺偍锛?
OPTIMIZE delta_table;

-- 娣诲姞 Z-ORDER 绱㈠紩
OPTIMIZE delta_table
ZORDER BY (date, user_id);

-- 鏌ョ湅鏂囦欢缁熻淇℃伅
DESCRIBE DETAIL delta_scan('s3://my-bucket/delta-table/');

-- 娓呯悊鏃х増鏈紙鍨冨溇鍥炴敹锛?
VACUUM delta_scan('s3://my-bucket/delta-table/') RETAIN 168 HOURS;

-- 閲嶅缓娓呭崟鏂囦欢
REORG TABLE delta_scan('s3://my-bucket/delta-table/');

-- 鍒嗘瀽琛ㄧ粺璁′俊鎭?
ANALYZE TABLE delta_scan('s3://my-bucket/delta-table/') COMPUTE STATISTICS;

-- 鏌ョ湅浼樺寲寤鸿
SELECT *
FROM delta_scan('s3://my-bucket/delta-table/', show_optimize => true);`}
        {...noteProps('code4')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">涓庡叾浠栫郴缁熼泦鎴?/h3>

      <CodeBlock
        title="澶氬紩鎿庢暟鎹叡浜?
        code={`-- 涓?Apache Spark 鍏变韩鏁版嵁
-- Spark 绔垱寤?Delta 琛?
-- DuckDB 鍙互鐩存帴璇诲彇 Spark 鍒涘缓鐨?Delta 琛?
SELECT *
FROM delta_scan('s3://shared-bucket/delta-table/')
WHERE created_by_spark = true;

-- 涓?Presto/Trino 闆嗘垚
SELECT *
FROM delta_scan('s3://bucket/delta-table/')
WHERE processed_by_presto = false;

-- 鏁版嵁琛€缂樿拷韪?
WITH delta_history AS (
    SELECT *
    FROM delta_scan('s3://bucket/delta-table/', show_history => true)
)
SELECT
    version,
    operation,
    operationMetrics.numFiles,
    operationMetrics.numOutputBytes,
    timestamp
FROM delta_history
WHERE operation IN ('WRITE', 'MERGE', 'DELETE')
ORDER BY timestamp DESC
LIMIT 20;

-- 璺ㄥ紩鎿庢煡璇㈣仈鍚?
SELECT
    'DuckDB' AS engine,
    COUNT(*) AS record_count,
    SUM(value) AS total_value
FROM delta_scan('s3://bucket/delta-table/')
UNION ALL
SELECT
    'Spark' AS engine,
    COUNT(*) AS record_count,
    SUM(value) AS total_value
FROM spark_delta_table;`}
        {...noteProps('code5')}
      />

      <InfoBox type="tip" title="Delta Lake 鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>瀛樺偍甯冨眬锛?/strong> 浣跨敤鍒嗗眰瀛樺偍锛岀儹鏁版嵁鏀維SD锛屽喎鏁版嵁鏀惧璞″瓨鍌?/li>
          <li><strong>鍒嗗尯绛栫暐锛?/strong> 鎸夋椂闂村拰涓氬姟缁村害鍚堢悊鍒嗗尯</li>
          <li><strong>浼樺寲棰戠巼锛?/strong> 瀹氭湡杩愯 OPTIMIZE 鍘嬬缉灏忔枃浠?/li>
          <li><strong>淇濈暀绛栫暐锛?/strong> 鏍规嵁涓氬姟闇€姹傝缃巻鍙茬増鏈繚鐣欐椂闂?/li>
          <li><strong>鐩戞帶鍛婅锛?/strong> 鐩戞帶琛ㄥぇ灏忋€佹枃浠舵暟閲忋€佹搷浣滃欢杩?/li>
          <li><strong>澶囦唤鎭㈠锛?/strong> 瀹炴柦澶氬尯鍩熷浠藉拰鐏鹃毦鎭㈠璁″垝</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彚 鏁版嵁浠撳簱</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鏋勫缓浼佷笟绾ф暟鎹粨搴擄紝鏀寔ACID鍜屾椂闂存梾琛?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃攧 鏁版嵁绠￠亾</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鍙潬鐨勬暟鎹瓻TL绠￠亾锛屾敮鎸佷簨鍔″拰鍥炴粴</p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搳 瀹炴椂鍒嗘瀽</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鏀寔瀹炴椂鍐欏叆鍜屽巻鍙叉暟鎹垎鏋愮殑娣峰悎宸ヤ綔璐熻浇</p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃攳 鏁版嵁瀹¤</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">瀹屾暣鐨勬暟鎹彉鏇村巻鍙插拰瀹¤杩借釜</p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鏋勫缓涓€涓畬鏁寸殑鏁版嵁婀栨灦鏋勶紝浣跨敤Delta Lake瀛樺偍澶氭簮鏁版嵁</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓椂闂存梾琛屾煡璇㈢郴缁燂紝鏀寔鍘嗗彶鏁版嵁鍥炴函鍜屽姣斿垎鏋?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓寮曟搸鏁版嵁鍏变韩骞冲彴锛屾敮鎸丼park銆丳resto鍜孌uckDB鍗忓悓宸ヤ綔</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鐗╁寲瑙嗗浘绔犺妭
// ============================================

export function MaterializedViewsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鐗╁寲瑙嗗浘</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"棰勮绠楃殑鏌ヨ鍔犻€熷櫒"</p>

      <Paragraph {...noteProps('p1')}>
        鐗╁寲瑙嗗浘閫氳繃棰勮绠楀拰瀛樺偍鏌ヨ缁撴灉鏉ユ樉钁楁彁鍗囨煡璇㈡€ц兘銆備笉鍚屼簬鏅€氳鍥惧彧淇濆瓨鏌ヨ閫昏緫锛岀墿鍖栬鍥句繚瀛樺疄闄呯殑鏁版嵁缁撴灉銆傚綋搴曞眰鏁版嵁鍙樺寲鏃讹紝鐗╁寲瑙嗗浘鍙互澧為噺鍒锋柊鎴栧畬鍏ㄩ噸寤恒€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒涘缓鐗╁寲瑙嗗浘</h3>

      <SQLExplainer
        sql={`-- 鍒涘缓鍩虹鐗╁寲瑙嗗浘
CREATE MATERIALIZED VIEW monthly_sales AS
SELECT
    DATE_TRUNC('month', order_date) AS month,
    product_category,
    SUM(quantity) AS total_quantity,
    SUM(amount) AS total_amount,
    COUNT(*) AS order_count
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY DATE_TRUNC('month', order_date), product_category;

-- 鏌ヨ鐗╁寲瑙嗗浘锛堢洿鎺ヤ粠棰勮绠楃粨鏋滆鍙栵級
SELECT * FROM monthly_sales
WHERE month >= '2024-01-01'
ORDER BY total_amount DESC;

-- 鏌ョ湅鐗╁寲瑙嗗浘淇℃伅
SELECT * FROM duckdb_materialized_views()
WHERE view_name = 'monthly_sales';`}
        explanations={[
          { code: 'CREATE MATERIALIZED VIEW ... AS', explanation: '鍒涘缓鐗╁寲瑙嗗浘骞剁珛鍗虫墽琛屾煡璇㈠瓨鍌ㄧ粨鏋?, tip: '浼氬疄闄呰绠楀苟瀛樺偍鏁版嵁' },
          { code: 'FROM monthly_sales', explanation: '鏌ヨ鐗╁寲瑙嗗浘灏卞儚鏌ヨ鏅€氳〃', tip: '鎬ц兘鎺ヨ繎鐩存帴鏌ヨ瀛樺偍鐨勬暟鎹? },
          { code: 'duckdb_materialized_views()', explanation: '鏌ョ湅绯荤粺涓墍鏈夌墿鍖栬鍥剧殑淇℃伅', tip: '鍖呮嫭鍒涘缓鏃堕棿銆佸埛鏂扮姸鎬佺瓑' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍒锋柊绛栫暐</h3>

      <CodeBlock
        title="鐗╁寲瑙嗗浘鐨勭淮鎶ゅ拰鏇存柊"
        code={`-- 瀹屽叏鍒锋柊锛堥噸寤烘暣涓鍥撅級
REFRESH MATERIALIZED VIEW monthly_sales;

-- 澧為噺鍒锋柊绀轰緥锛堝鏋滄敮鎸侊級
-- 娉ㄦ剰锛欴uckDB褰撳墠涓昏鏀寔瀹屽叏鍒锋柊
REFRESH MATERIALIZED VIEW user_stats;

-- 瀹氭椂鑷姩鍒锋柊
-- 鍒涘缓鍒锋柊鍑芥暟
CREATE OR REPLACE FUNCTION refresh_dashboard_views() RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW monthly_sales;
    REFRESH MATERIALIZED VIEW user_stats;
    REFRESH MATERIALIZED VIEW product_performance;
END;
$$ LANGUAGE plpgsql;

-- 璁剧疆瀹氭椂浠诲姟锛堥渶瑕佸閮ㄨ皟搴﹀櫒锛?
-- 渚嬪锛氭瘡澶╁噷鏅?鐐瑰埛鏂?
SELECT cron.schedule(
    'refresh-dashboard-views',
    '0 2 * * *',
    'SELECT refresh_dashboard_views();'
);

-- 鏉′欢鍒锋柊锛堝彧鍦ㄩ渶瑕佹椂鍒锋柊锛?
CREATE OR REPLACE FUNCTION smart_refresh() RETURNS VOID AS $$
DECLARE
    last_refresh TIMESTAMP;
    data_changed BOOLEAN;
BEGIN
    -- 妫€鏌ユ渶鍚庡埛鏂版椂闂?
    SELECT last_refreshed INTO last_refresh
    FROM view_refresh_log
    WHERE view_name = 'monthly_sales';

    -- 妫€鏌ユ暟鎹槸鍚︽湁鍙樺寲
    SELECT EXISTS(
        SELECT 1 FROM orders
        WHERE order_date > last_refresh
    ) INTO data_changed;

    -- 鍙湁鍦ㄦ暟鎹彉鍖栨椂鎵嶅埛鏂?
    IF data_changed THEN
        REFRESH MATERIALIZED VIEW monthly_sales;
        UPDATE view_refresh_log
        SET last_refreshed = CURRENT_TIMESTAMP
        WHERE view_name = 'monthly_sales';
    END IF;
END;
$$ LANGUAGE plpgsql;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鎬ц兘浼樺寲</h3>

      <CodeBlock
        title="鐗╁寲瑙嗗浘鐨勬€ц兘璋冧紭"
        code={`-- 姣旇緝鏅€氳鍥惧拰鐗╁寲瑙嗗浘鐨勬€ц兘
-- 鏅€氳鍥撅細姣忔鏌ヨ閮介噸鏂拌绠?
CREATE VIEW normal_monthly_sales AS
SELECT
    DATE_TRUNC('month', order_date) AS month,
    product_category,
    SUM(quantity) AS total_quantity,
    SUM(amount) AS total_amount
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY DATE_TRUNC('month', order_date), product_category;

-- 鐗╁寲瑙嗗浘锛氶璁＄畻缁撴灉
CREATE MATERIALIZED VIEW fast_monthly_sales AS
SELECT
    DATE_TRUNC('month', order_date) AS month,
    product_category,
    SUM(quantity) AS total_quantity,
    SUM(amount) AS total_amount
FROM orders
WHERE order_date >= '2024-01-01'
GROUP BY DATE_TRUNC('month', order_date), product_category;

-- 鎬ц兘瀵规瘮娴嬭瘯
.timer on

-- 鏅€氳鍥炬煡璇紙姣忔閮借绠楋級
SELECT * FROM normal_monthly_sales WHERE month >= '2024-06-01';

-- 鐗╁寲瑙嗗浘鏌ヨ锛堢洿鎺ヨ鍙栫粨鏋滐級
SELECT * FROM fast_monthly_sales WHERE month >= '2024-06-01';

.timer off

-- 鍒涘缓绱㈠紩浼樺寲鐗╁寲瑙嗗浘鏌ヨ
CREATE INDEX idx_monthly_sales_month ON monthly_sales(month);
CREATE INDEX idx_monthly_sales_category ON monthly_sales(product_category);

-- 鍒嗗尯鐗╁寲瑙嗗浘锛堟寜鏃堕棿鍒嗗尯锛?
CREATE MATERIALIZED VIEW sales_by_quarter (
    quarter_start,
    quarter_end,
    total_sales,
    top_product
) PARTITION BY (YEAR(quarter_start))
AS
SELECT
    DATE_TRUNC('quarter', order_date) AS quarter_start,
    DATE_TRUNC('quarter', order_date) + INTERVAL 3 MONTH - INTERVAL 1 DAY AS quarter_end,
    SUM(amount) AS total_sales,
    (SELECT product_name FROM (
        SELECT product_name, SUM(amount) AS sales
        FROM orders o2
        WHERE DATE_TRUNC('quarter', o2.order_date) = DATE_TRUNC('quarter', o1.order_date)
        GROUP BY product_name
        ORDER BY sales DESC
        LIMIT 1
    )) AS top_product
FROM orders o1
WHERE order_date >= '2023-01-01'
GROUP BY DATE_TRUNC('quarter', order_date);`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇搴旂敤鍦烘櫙</h3>

      <CodeBlock
        title="澶嶆潅鐗╁寲瑙嗗浘鐨勫簲鐢?
        code={`-- 鏁版嵁浠撳簱鑱氬悎灞?
CREATE MATERIALIZED VIEW dw_fact_sales_daily AS
SELECT
    DATE(order_date) AS sale_date,
    customer_id,
    product_id,
    store_id,
    SUM(quantity) AS daily_quantity,
    SUM(amount) AS daily_amount,
    AVG(discount_percent) AS avg_discount,
    COUNT(*) AS transaction_count
FROM fact_sales
WHERE order_date >= CURRENT_DATE - INTERVAL 2 YEAR
GROUP BY DATE(order_date), customer_id, product_id, store_id;

-- 瀹炴椂浠〃鏉胯鍥?
CREATE MATERIALIZED VIEW dashboard_kpis AS
SELECT
    DATE_TRUNC('hour', event_time) AS hour,
    event_type,
    COUNT(*) AS event_count,
    COUNT(DISTINCT user_id) AS unique_users,
    AVG(event_value) AS avg_value,
    MAX(event_value) AS max_value,
    APPROXIMATE_PERCENTILE(event_value, 0.95) AS p95_value
FROM user_events
WHERE event_time >= CURRENT_TIMESTAMP - INTERVAL 24 HOUR
GROUP BY DATE_TRUNC('hour', event_time), event_type;

-- 澶氳〃鍏宠仈鐨勭墿鍖栬鍥?
CREATE MATERIALIZED VIEW customer_lifetime_value AS
SELECT
    c.customer_id,
    c.customer_name,
    c.registration_date,
    COUNT(o.order_id) AS total_orders,
    SUM(o.total_amount) AS lifetime_value,
    AVG(o.total_amount) AS avg_order_value,
    MAX(o.order_date) AS last_order_date,
    CURRENT_DATE - MAX(o.order_date) AS days_since_last_order,
    CASE
        WHEN CURRENT_DATE - MAX(o.order_date) <= 30 THEN '娲昏穬'
        WHEN CURRENT_DATE - MAX(o.order_date) <= 90 THEN '涓€鑸?
        ELSE '娴佸け'
    END AS customer_status
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.customer_name, c.registration_date;

-- 鍦扮悊鍒嗘瀽鐗╁寲瑙嗗浘
CREATE MATERIALIZED VIEW regional_sales_analysis AS
SELECT
    r.region_name,
    r.region_manager,
    COUNT(DISTINCT s.store_id) AS store_count,
    COUNT(DISTINCT c.customer_id) AS customer_count,
    SUM(s.monthly_sales) AS total_monthly_sales,
    AVG(s.monthly_sales) AS avg_store_sales,
    SUM(s.employee_count) AS total_employees,
    ROUND(SUM(s.monthly_sales) / SUM(s.employee_count), 2) AS sales_per_employee
FROM regions r
JOIN stores s ON r.region_id = s.region_id
LEFT JOIN customers c ON s.region_id = c.region_id
GROUP BY r.region_name, r.region_manager;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">缁存姢鍜岀洃鎺?/h3>

      <CodeBlock
        title="鐗╁寲瑙嗗浘鐨勮繍缁寸鐞?
        code={`-- 鏌ョ湅鐗╁寲瑙嗗浘鐘舵€?
SELECT
    view_name,
    created_time,
    last_refresh_time,
    refresh_duration_ms,
    row_count,
    storage_size_mb
FROM duckdb_materialized_views();

-- 鐩戞帶鍒锋柊鎬ц兘
CREATE TABLE mv_refresh_log (
    view_name VARCHAR,
    refresh_start TIMESTAMP,
    refresh_end TIMESTAMP,
    duration_ms INTEGER,
    rows_affected INTEGER,
    success BOOLEAN,
    error_message VARCHAR
);

-- 璁板綍鍒锋柊鎿嶄綔
CREATE OR REPLACE FUNCTION log_refresh_operation(
    p_view_name VARCHAR
) RETURNS VOID AS $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
    affected_rows INTEGER;
BEGIN
    start_time := CURRENT_TIMESTAMP;

    -- 鎵ц鍒锋柊
    EXECUTE 'REFRESH MATERIALIZED VIEW ' || p_view_name;

    end_time := CURRENT_TIMESTAMP;
    affected_rows := (SELECT COUNT(*) FROM pg_stat_user_tables WHERE relname = p_view_name);

    -- 璁板綍鏃ュ織
    INSERT INTO mv_refresh_log (
        view_name, refresh_start, refresh_end,
        duration_ms, rows_affected, success
    ) VALUES (
        p_view_name, start_time, end_time,
        EXTRACT(EPOCH FROM (end_time - start_time)) * 1000,
        affected_rows, TRUE
    );

EXCEPTION WHEN OTHERS THEN
    -- 璁板綍閿欒
    INSERT INTO mv_refresh_log (
        view_name, refresh_start, refresh_end,
        success, error_message
    ) VALUES (
        p_view_name, start_time, CURRENT_TIMESTAMP,
        FALSE, SQLERRM
    );
END;
$$ LANGUAGE plpgsql;

-- 娓呯悊杩囨湡鐗╁寲瑙嗗浘
CREATE OR REPLACE FUNCTION cleanup_stale_mvs() RETURNS VOID AS $$
DECLARE
    mv_record RECORD;
BEGIN
    FOR mv_record IN
        SELECT view_name, last_refresh_time
        FROM duckdb_materialized_views()
        WHERE last_refresh_time < CURRENT_TIMESTAMP - INTERVAL 30 DAY
    LOOP
        -- 鍒犻櫎闀挎湡鏈埛鏂扮殑鐗╁寲瑙嗗浘
        EXECUTE 'DROP MATERIALIZED VIEW ' || mv_record.view_name;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 鍒嗘瀽鐗╁寲瑙嗗浘浣跨敤鎯呭喌
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del
FROM pg_stat_user_tables
WHERE tablename LIKE '%materialized%'
ORDER BY seq_scan DESC;`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="鐗╁寲瑙嗗浘鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>閫夋嫨鎬у垱寤猴細</strong> 鍙负棰戠箒鏌ヨ涓旇绠楁垚鏈珮鐨勫満鏅垱寤虹墿鍖栬鍥?/li>
          <li><strong>鍒锋柊绛栫暐锛?/strong> 鏍规嵁鏁版嵁鍙樺寲棰戠巼閫夋嫨鍚堥€傜殑鍒锋柊闂撮殧</li>
          <li><strong>瀛樺偍鑰冭檻锛?/strong> 璇勪及瀛樺偍鎴愭湰涓庢煡璇㈡€ц兘鎻愬崌鐨勫钩琛?/li>
          <li><strong>渚濊禆绠＄悊锛?/strong> 娉ㄦ剰鐗╁寲瑙嗗浘瀵瑰熀纭€琛ㄧ殑渚濊禆鍏崇郴</li>
          <li><strong>鐩戞帶鍛婅锛?/strong> 鐩戞帶鍒锋柊澶辫触鍜屾€ц兘涓嬮檷</li>
          <li><strong>鐗堟湰鎺у埗锛?/strong> 灏嗙墿鍖栬鍥惧畾涔夌撼鍏ョ増鏈帶鍒剁郴缁?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 鏁版嵁浠撳簱</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鏋勫缓鑱氬悎灞傦紝鎻愬崌鏌ヨ鎬ц兘锛屾敮鎸佸鏉傚垎鏋?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃搱 瀹炴椂浠〃鏉?/h4>
          <p className="text-sm text-green-600 dark:text-green-400">棰勮绠桲PI鎸囨爣锛屾敮鎸佸揩閫熷搷搴旂敤鎴锋煡璇?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃攳 鎼滅储浼樺寲</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">棰勮绠楁悳绱㈢粨鏋滐紝鍔犻€熷叏鏂囨悳绱㈠拰澶嶆潅绛涢€?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃搲 缂撳瓨灞?/h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">浣滀负鏌ヨ缂撳瓨灞傦紝鍑忓皯瀵瑰師濮嬫暟鎹殑璁块棶</p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 璁捐涓€涓暟鎹粨搴撶殑鐗╁寲瑙嗗浘灞傦紝鍖呮嫭鑱氬悎琛ㄥ拰缁村害琛?/p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓櫤鑳藉埛鏂扮郴缁燂紝鏍规嵁鏁版嵁鍙樺寲棰戠巼鑷姩璋冩暣鍒锋柊绛栫暐</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓墿鍖栬鍥剧洃鎺у拰浼樺寲绯荤粺锛岃瘑鍒€ц兘鐡堕骞舵彁鍑烘敼杩涘缓璁?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍔ㄦ€佽鍥剧珷鑺?
// ============================================

export function DynamicViewsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍔ㄦ€佽鍥?/h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鐏垫椿鐨勬暟鎹€忚鍜屽彉鎹?</p>

      <Paragraph {...noteProps('p1')}>
        鍔ㄦ€佽鍥鹃€氳繃鍙傛暟鍖栨煡璇㈠拰杩愯鏃惰绠楁彁渚涚伒娲荤殑鏁版嵁璁块棶鏂瑰紡銆備笌闈欐€佽鍥句笉鍚岋紝鍔ㄦ€佽鍥惧彲浠ュ湪鏌ヨ鏃舵牴鎹緭鍏ュ弬鏁拌皟鏁磋涓猴紝鏀寔鏉′欢閫昏緫銆佸姩鎬佸垎缁勩€佸弬鏁板寲杩囨护绛夐珮绾у姛鑳姐€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍙傛暟鍖栬鍥?/h3>

      <SQLExplainer
        sql={`-- 鍒涘缓鍙傛暟鍖栬鍥惧嚱鏁?
CREATE OR REPLACE FUNCTION get_user_orders(
    user_id_param INTEGER DEFAULT NULL,
    status_filter VARCHAR DEFAULT 'all',
    date_from DATE DEFAULT NULL,
    date_to DATE DEFAULT NULL
) RETURNS TABLE (
    order_id INTEGER,
    order_date DATE,
    total_amount DECIMAL,
    status VARCHAR,
    customer_name VARCHAR
) AS $$
    SELECT
        o.order_id,
        o.order_date,
        o.total_amount,
        o.status,
        c.customer_name
    FROM orders o
    JOIN customers c ON o.customer_id = c.customer_id
    WHERE (user_id_param IS NULL OR o.customer_id = user_id_param)
      AND (status_filter = 'all' OR o.status = status_filter)
      AND (date_from IS NULL OR o.order_date >= date_from)
      AND (date_to IS NULL OR o.order_date <= date_to)
    ORDER BY o.order_date DESC;
$$ LANGUAGE SQL;

-- 浣跨敤鍙傛暟鍖栬鍥?
SELECT * FROM get_user_orders(123);                    -- 鎸囧畾鐢ㄦ埛
SELECT * FROM get_user_orders(NULL, 'completed');      -- 鎵€鏈夊畬鎴愯鍗?
SELECT * FROM get_user_orders(123, 'all', '2024-01-01', '2024-12-31'); -- 鏃堕棿鑼冨洿`}
        explanations={[
          { code: 'CREATE OR REPLACE FUNCTION ... RETURNS TABLE', explanation: '鍒涘缓杩斿洖琛ㄧ殑鍑芥暟浣滀负鍔ㄦ€佽鍥?, tip: '鍙互鎺ュ彈澶氫釜鍙傛暟骞惰繑鍥炲姩鎬佺粨鏋? },
          { code: 'WHERE (condition IS NULL OR ...)', explanation: '鏉′欢鍙傛暟澶勭悊NULL鍊艰〃绀?鍏ㄩ儴"', tip: '瀹炵幇鍙€夊弬鏁扮殑鐏垫椿绛涢€? },
          { code: 'FROM get_user_orders(...)', explanation: '鍍忔煡璇㈣〃涓€鏍疯皟鐢ㄥ弬鏁板寲瑙嗗浘', tip: '鏀寔鍦↗OIN鍜屽叾浠栨煡璇腑浣跨敤' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍔ㄦ€侀€忚琛?/h3>

      <CodeBlock
        title="杩愯鏃剁敓鎴愰€忚琛?
        code={`-- 鍒涘缓鍔ㄦ€侀€忚琛ㄥ嚱鏁?
CREATE OR REPLACE FUNCTION pivot_sales_data(
    group_by_column VARCHAR,
    pivot_column VARCHAR,
    value_column VARCHAR DEFAULT 'amount',
    agg_function VARCHAR DEFAULT 'SUM'
) RETURNS TABLE (
    group_value VARCHAR,
    pivot_values JSON
) AS $$
DECLARE
    sql_query TEXT;
BEGIN
    sql_query := format('
        SELECT
            %I::VARCHAR AS group_value,
            json_group_object(
                COALESCE(%I::VARCHAR, ''NULL''),
                %s(%s)
            ) AS pivot_values
        FROM sales
        GROUP BY %I
        ORDER BY group_value
    ', group_by_column, pivot_column, agg_function, value_column, group_by_column);

    RETURN QUERY EXECUTE sql_query;
END;
$$ LANGUAGE plpgsql;

-- 浣跨敤鍔ㄦ€侀€忚琛?
SELECT * FROM pivot_sales_data('region', 'product_category');
-- 缁撴灉绫讳技锛?
-- group_value | pivot_values
-- 'North'     | {"Electronics": 15000, "Clothing": 8000, "Books": 3000}
-- 'South'     | {"Electronics": 12000, "Clothing": 9000, "Books": 4000}

-- 鏇寸伒娲荤殑閫忚鍑芥暟
CREATE OR REPLACE FUNCTION create_pivot_view(
    table_name VARCHAR,
    row_dims TEXT[],    -- 琛岀淮搴?
    col_dim VARCHAR,    -- 鍒楃淮搴?
    value_expr VARCHAR, -- 鍊艰〃杈惧紡
    agg_func VARCHAR DEFAULT 'SUM'
) RETURNS TEXT AS $$
DECLARE
    row_dims_str TEXT;
    sql_query TEXT;
BEGIN
    row_dims_str := array_to_string(row_dims, ', ');

    sql_query := format('
        SELECT %s,
               json_group_object(
                   COALESCE(%I::VARCHAR, ''NULL''),
                   %s(%s)
               ) AS pivot_data
        FROM %I
        GROUP BY %s
    ', row_dims_str, col_dim, agg_func, value_expr, table_name, row_dims_str);

    RETURN sql_query;
END;
$$ LANGUAGE plpgsql;

-- 鐢熸垚骞舵墽琛岄€忚鏌ヨ
SELECT create_pivot_view(
    'sales_transactions',
    ARRAY['region', 'quarter'],
    'product_type',
    'sales_amount'
) AS pivot_query;

-- 鎵ц鐢熸垚鐨勬煡璇?
EXECUTE create_pivot_view(
    'sales_transactions',
    ARRAY['region', 'quarter'],
    'product_type',
    'sales_amount'
);`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏉′欢閫昏緫瑙嗗浘</h3>

      <CodeBlock
        title="鍩轰簬杩愯鏃舵潯浠剁殑鍔ㄦ€佽鍥?
        code={`-- 鏅鸿兘鎶ヨ〃鐢熸垚鍣?
CREATE OR REPLACE FUNCTION generate_smart_report(
    report_type VARCHAR,
    filters JSON DEFAULT '{}',
    group_level VARCHAR DEFAULT 'standard'
) RETURNS TABLE (
    dimension VARCHAR,
    metric_name VARCHAR,
    metric_value DECIMAL,
    trend VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    CASE report_type
        WHEN 'sales_performance' THEN
            SELECT
                p.product_name::VARCHAR,
                'Sales Amount'::VARCHAR,
                SUM(s.amount),
                CASE
                    WHEN SUM(s.amount) > (SELECT AVG(amount) FROM sales) THEN 'Above Average'
                    ELSE 'Below Average'
                END
            FROM sales s
            JOIN products p ON s.product_id = p.product_id
            WHERE (filters->>'date_from' IS NULL OR s.sale_date >= (filters->>'date_from')::DATE)
              AND (filters->>'date_to' IS NULL OR s.sale_date <= (filters->>'date_to')::DATE)
            GROUP BY p.product_name
            ORDER BY SUM(s.amount) DESC;

        WHEN 'customer_segmentation' THEN
            SELECT
                seg.segment_name::VARCHAR,
                'Customer Count'::VARCHAR,
                COUNT(*)::DECIMAL,
                CASE
                    WHEN COUNT(*) > 1000 THEN 'Large Segment'
                    WHEN COUNT(*) > 100 THEN 'Medium Segment'
                    ELSE 'Small Segment'
                END
            FROM customers c
            JOIN customer_segments seg ON c.segment_id = seg.segment_id
            GROUP BY seg.segment_name;

        WHEN 'regional_analysis' THEN
            SELECT
                r.region_name::VARCHAR,
                CASE
                    WHEN group_level = 'detailed' THEN 'Detailed Metrics'
                    ELSE 'Summary Metrics'
                END::VARCHAR,
                SUM(o.total_amount),
                CASE
                    WHEN SUM(o.total_amount) > 100000 THEN 'High Performing'
                    WHEN SUM(o.total_amount) > 50000 THEN 'Medium Performing'
                    ELSE 'Low Performing'
                END
            FROM orders o
            JOIN regions r ON o.region_id = r.region_id
            GROUP BY r.region_name;

        ELSE
            -- 榛樿鎶ヨ〃
            SELECT
                'Total'::VARCHAR,
                'Summary'::VARCHAR,
                SUM(amount)::DECIMAL,
                'Overall'::VARCHAR
            FROM transactions;
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- 浣跨敤鏅鸿兘鎶ヨ〃鐢熸垚鍣?
SELECT * FROM generate_smart_report('sales_performance');
SELECT * FROM generate_smart_report('customer_segmentation', '{"date_from": "2024-01-01"}');
SELECT * FROM generate_smart_report('regional_analysis', '{}', 'detailed');`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍔ㄦ€佹暟鎹浆鎹?/h3>

      <CodeBlock
        title="杩愯鏃舵暟鎹粨鏋勫彉鎹?
        code={`-- 鍔ㄦ€佸垪鐢熸垚鍣?
CREATE OR REPLACE FUNCTION generate_dynamic_columns(
    base_table VARCHAR,
    column_configs JSON
) RETURNS TEXT AS $$
DECLARE
    config_record JSON;
    column_defs TEXT := '';
    select_list TEXT := '';
BEGIN
    -- 瑙ｆ瀽閰嶇疆鐢熸垚鍒楀畾涔?
    FOR config_record IN SELECT json_array_elements(column_configs)
    LOOP
        column_defs := column_defs || format(
            ', %I %s GENERATED ALWAYS AS (%s) STORED',
            config_record->>'name',
            config_record->>'type',
            config_record->>'expression'
        );

        select_list := select_list || ', ' || (config_record->>'name');
    END LOOP;

    RETURN format(
        'CREATE VIEW dynamic_%s AS SELECT *%s FROM %s',
        base_table, select_list, base_table
    );
END;
$$ LANGUAGE plpgsql;

-- 閰嶇疆鍔ㄦ€佸垪
SELECT generate_dynamic_columns(
    'sales_data',
    '[
        {"name": "quarter", "type": "VARCHAR", "expression": "EXTRACT(QUARTER FROM sale_date)::VARCHAR"},
        {"name": "is_high_value", "type": "BOOLEAN", "expression": "amount > 1000"},
        {"name": "profit_margin", "type": "DECIMAL", "expression": "ROUND((amount - cost) / amount * 100, 2)"},
        {"name": "customer_tier", "type": "VARCHAR", "expression": "CASE WHEN lifetime_value > 10000 THEN ''Platinum'' WHEN lifetime_value > 5000 THEN ''Gold'' ELSE ''Silver'' END"}
    ]'::JSON
);

-- 鍔ㄦ€佹暟鎹被鍨嬭浆鎹?
CREATE OR REPLACE FUNCTION smart_cast(
    value TEXT,
    target_type VARCHAR
) RETURNS TEXT AS $$
BEGIN
    RETURN CASE target_type
        WHEN 'INTEGER' THEN value::INTEGER::TEXT
        WHEN 'DECIMAL' THEN value::DECIMAL::TEXT
        WHEN 'DATE' THEN value::DATE::TEXT
        WHEN 'TIMESTAMP' THEN value::TIMESTAMP::TEXT
        WHEN 'BOOLEAN' THEN CASE WHEN lower(value) IN ('true', '1', 'yes', 'on') THEN 'true'
                                 WHEN lower(value) IN ('false', '0', 'no', 'off') THEN 'false'
                                 ELSE NULL END
        ELSE value
    END;
EXCEPTION WHEN OTHERS THEN
    RETURN NULL; -- 杞崲澶辫触杩斿洖NULL
END;
$$ LANGUAGE plpgsql;

-- 鏁版嵁娓呯悊鍜屾爣鍑嗗寲瑙嗗浘
CREATE VIEW cleaned_customer_data AS
SELECT
    customer_id,
    smart_cast(name, 'VARCHAR') AS cleaned_name,
    smart_cast(age, 'INTEGER') AS cleaned_age,
    smart_cast(email, 'VARCHAR') AS cleaned_email,
    CASE
        WHEN smart_cast(phone, 'VARCHAR') ~ '^\d{3}-\d{3}-\d{4}$' THEN smart_cast(phone, 'VARCHAR')
        ELSE NULL
    END AS cleaned_phone,
    smart_cast(signup_date, 'DATE') AS cleaned_signup_date
FROM raw_customer_imports;`}
        {...noteProps('code3')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">杩愯鏃舵煡璇㈡瀯寤?/h3>

      <CodeBlock
        title="鍔ㄦ€丼QL鏌ヨ鐢熸垚"
        code={`-- 楂樼骇鏌ヨ鏋勫缓鍣?
CREATE OR REPLACE FUNCTION build_advanced_query(
    base_table VARCHAR,
    select_columns TEXT[] DEFAULT NULL,
    where_conditions JSON DEFAULT '[]',
    group_by_columns TEXT[] DEFAULT NULL,
    order_by_columns TEXT[] DEFAULT NULL,
    limit_count INTEGER DEFAULT NULL
) RETURNS TEXT AS $$
DECLARE
    select_clause TEXT;
    where_clause TEXT := '';
    group_clause TEXT := '';
    order_clause TEXT := '';
    limit_clause TEXT := '';
    condition_record JSON;
BEGIN
    -- SELECT瀛愬彞
    IF select_columns IS NULL THEN
        select_clause := '*';
    ELSE
        select_clause := array_to_string(select_columns, ', ');
    END IF;

    -- WHERE瀛愬彞
    IF json_array_length(where_conditions) > 0 THEN
        where_clause := ' WHERE ';
        FOR condition_record IN SELECT json_array_elements(where_conditions)
        LOOP
            where_clause := where_clause ||
                format('(%s %s %s)',
                    condition_record->>'column',
                    condition_record->>'operator',
                    quote_literal(condition_record->>'value')
                ) || ' AND ';
        END LOOP;
        where_clause := rtrim(where_clause, ' AND ');
    END IF;

    -- GROUP BY瀛愬彞
    IF group_by_columns IS NOT NULL THEN
        group_clause := ' GROUP BY ' || array_to_string(group_by_columns, ', ');
    END IF;

    -- ORDER BY瀛愬彞
    IF order_by_columns IS NOT NULL THEN
        order_clause := ' ORDER BY ' || array_to_string(order_by_columns, ', ');
    END IF;

    -- LIMIT瀛愬彞
    IF limit_count IS NOT NULL THEN
        limit_clause := ' LIMIT ' || limit_count::TEXT;
    END IF;

    RETURN format(
        'SELECT %s FROM %s%s%s%s%s',
        select_clause, base_table, where_clause, group_clause, order_clause, limit_clause
    );
END;
$$ LANGUAGE plpgsql;

-- 浣跨敤鏌ヨ鏋勫缓鍣?
SELECT build_advanced_query(
    'orders',
    ARRAY['order_id', 'customer_id', 'total_amount'],
    '[
        {"column": "status", "operator": "=", "value": "completed"},
        {"column": "total_amount", "operator": ">", "value": "100"}
    ]'::JSON,
    ARRAY['customer_id'],
    ARRAY['total_amount DESC'],
    10
) AS generated_query;

-- 鎵ц鍔ㄦ€佺敓鎴愮殑鏌ヨ
EXECUTE build_advanced_query(
    'orders',
    ARRAY['order_id', 'customer_id', 'total_amount'],
    '[
        {"column": "status", "operator": "=", "value": "completed"},
        {"column": "total_amount", "operator": ">", "value": "100"}
    ]'::JSON,
    ARRAY['customer_id'],
    ARRAY['total_amount DESC'],
    10
);`}
        {...noteProps('code4')}
      />

      <InfoBox type="tip" title="鍔ㄦ€佽鍥炬渶浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鍙傛暟楠岃瘉锛?/strong> 瀵硅緭鍏ュ弬鏁拌繘琛屼弗鏍奸獙璇侊紝闃叉SQL娉ㄥ叆</li>
          <li><strong>鎬ц兘鐩戞帶锛?/strong> 鐩戞帶鍔ㄦ€佹煡璇㈢殑鎵ц璁″垝鍜屾€ц兘</li>
          <li><strong>缂撳瓨绛栫暐锛?/strong> 瀵归绻佷娇鐢ㄧ殑鍔ㄦ€佽鍥剧粨鏋滆繘琛岀紦瀛?/li>
          <li><strong>閿欒澶勭悊锛?/strong> 瀹炵幇瀹屽杽鐨勫紓甯稿鐞嗗拰鐢ㄦ埛鍙嬪ソ鐨勯敊璇俊鎭?/li>
          <li><strong>鏂囨。璁板綍锛?/strong> 涓哄鏉傜殑鍔ㄦ€佽鍥剧紪鍐欒缁嗙殑浣跨敤鏂囨。</li>
          <li><strong>娴嬭瘯瑕嗙洊锛?/strong> 缂栧啓鍗曞厓娴嬭瘯瑕嗙洊鍚勭鍙傛暟缁勫悎鍜岃竟鐣屾儏鍐?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃搳 鑷姪鍒嗘瀽</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">鍏佽鐢ㄦ埛鍔ㄦ€侀€夋嫨缁村害鍜屾寚鏍囩敓鎴愭姤琛?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃攳 鎼滅储杩囨护</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鏀寔澶嶆潅澶氭潯浠剁殑鍔ㄦ€佹煡璇㈡瀯寤?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搱 閫忚鍒嗘瀽</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">杩愯鏃剁敓鎴愰€忚琛紝鏀寔浠绘剰缁村害缁勫悎</p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃敡 鏁版嵁杞崲</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鏍规嵁闇€姹傚姩鎬佽皟鏁存暟鎹粨鏋勫拰鏍煎紡</p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 鍒涘缓涓€涓€氱敤鎶ヨ〃鐢熸垚鍣紝鏀寔鐢ㄦ埛鑷畾涔夌淮搴︺€佹寚鏍囧拰绛涢€夋潯浠?/p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓姩鎬侀€忚琛ㄥ紩鎿庯紝鏀寔浠绘剰鏁版嵁婧愬拰鑱氬悎鍑芥暟</p>
          <p><strong>鎸戞垬 3锛?/strong> 鏋勫缓涓€涓櫤鑳芥煡璇㈡瀯寤哄櫒锛岃兘澶熸牴鎹嚜鐒惰瑷€鎻忚堪鐢熸垚SQL鏌ヨ</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鐢ㄦ埛鏉冮檺绔犺妭
// ============================================

export function UserPermissionsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鐢ㄦ埛鏉冮檺</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"鏁版嵁璁块棶鐨勫畨鍏ㄦ帶鍒?</p>

      <Paragraph {...noteProps('p1')}>
        鐢ㄦ埛鏉冮檺绠＄悊绯荤粺鏄暟鎹畨鍏ㄧ殑鏍稿績銆傞€氳繃瑙掕壊-based璁块棶鎺у埗锛圧BAC锛夈€佹潈闄愬垎绾с€佸璁℃棩蹇楃瓑鏈哄埗锛岀‘淇濈敤鎴峰彧鑳借闂叾鑱岃矗鎵€闇€鐨勬暟鎹紝闃叉鏁版嵁娉勯湶鍜屾湭缁忔巿鏉冪殑璁块棶銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鐢ㄦ埛鍜岃鑹茬鐞?/h3>

      <SQLExplainer
        sql={`-- 鍒涘缓鐢ㄦ埛瑙掕壊
CREATE ROLE data_analyst;
CREATE ROLE data_engineer;
CREATE ROLE admin;
CREATE ROLE readonly_user;

-- 鎺堜簣瑙掕壊鏉冮檺
GRANT SELECT ON ALL TABLES IN SCHEMA public TO data_analyst;
GRANT SELECT, INSERT, UPDATE ON fact_sales TO data_engineer;
GRANT ALL PRIVILEGES ON DATABASE analytics TO admin;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- 鍒涘缓鐢ㄦ埛骞跺垎閰嶈鑹?
CREATE USER alice WITH PASSWORD 'secure_password';
CREATE USER bob WITH PASSWORD 'another_password';

GRANT data_analyst TO alice;
GRANT data_engineer TO bob;

-- 鏌ョ湅鐢ㄦ埛鏉冮檺
SELECT
    grantee,
    privilege_type,
    table_name
FROM information_schema.role_table_grants
WHERE grantee IN ('alice', 'bob', 'data_analyst', 'data_engineer');`}
        explanations={[
          { code: 'CREATE ROLE role_name', explanation: '鍒涘缓鐢ㄦ埛瑙掕壊鐢ㄤ簬鏉冮檺鍒嗙粍', tip: '瑙掕壊鍙互鍖呭惈澶氫釜鐢ㄦ埛锛岀粺涓€绠＄悊鏉冮檺' },
          { code: 'GRANT privileges TO role/user', explanation: '鎺堜簣鏉冮檺缁欒鑹叉垨鐢ㄦ埛', tip: '鏀寔 SELECT銆両NSERT銆乁PDATE銆丏ELETE 绛夋潈闄? },
          { code: 'GRANT role TO user', explanation: '灏嗙敤鎴锋坊鍔犲埌瑙掕壊涓?, tip: '鐢ㄦ埛缁ф壙瑙掕壊鐨勬墍鏈夋潈闄? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">缁嗙矑搴︽潈闄愭帶鍒?/h3>

      <CodeBlock
        title="瀵硅薄绾у拰鍒楃骇鏉冮檺"
        code={`-- 鍒涘缓娴嬭瘯琛?
CREATE TABLE employee_data (
    id INTEGER PRIMARY KEY,
    name VARCHAR,
    salary DECIMAL,
    ssn VARCHAR,        -- 绀句細淇濋櫓鍙凤紝鏁忔劅淇℃伅
    department VARCHAR,
    manager_id INTEGER
);

-- 鎻掑叆娴嬭瘯鏁版嵁
INSERT INTO employee_data VALUES
    (1, 'Alice Johnson', 75000, '123-45-6789', 'Engineering', 5),
    (2, 'Bob Smith', 65000, '987-65-4321', 'Sales', 6),
    (3, 'Carol Davis', 80000, '456-78-9123', 'Engineering', 5);

-- 鎸夊垪鎺堜簣鏉冮檺
GRANT SELECT (id, name, department, manager_id) ON employee_data TO data_analyst;
GRANT SELECT (id, name, salary, department, manager_id) ON employee_data TO data_engineer;
GRANT SELECT ON employee_data TO admin;  -- 绠＄悊鍛樺彲浠ユ煡鐪嬫墍鏈夊垪

-- 鎸夎闄愬埗锛堟ā鎷熻绾у畨鍏級
CREATE VIEW employee_data_limited AS
SELECT * FROM employee_data
WHERE department IN (
    SELECT department FROM user_departments
    WHERE user_name = current_user
);

GRANT SELECT ON employee_data_limited TO data_analyst;

-- 閮ㄩ棬绾у埆鏉冮檺
CREATE TABLE user_departments (
    user_name VARCHAR,
    department VARCHAR,
    access_level VARCHAR  -- 'read', 'write', 'admin'
);

INSERT INTO user_departments VALUES
    ('alice', 'Engineering', 'read'),
    ('bob', 'Sales', 'write'),
    ('admin', 'All', 'admin');

-- 鍔ㄦ€佹潈闄愭鏌ュ嚱鏁?
CREATE OR REPLACE FUNCTION check_user_access(
    target_department VARCHAR,
    required_level VARCHAR DEFAULT 'read'
) RETURNS BOOLEAN AS $$
    SELECT EXISTS(
        SELECT 1 FROM user_departments
        WHERE user_name = current_user
          AND (department = target_department OR department = 'All')
          AND access_level IN ('admin', required_level)
    );
$$ LANGUAGE SQL;

-- 鍦ㄨ鍥句腑浣跨敤鏉冮檺妫€鏌?
CREATE VIEW secure_employee_data AS
SELECT
    id, name, department,
    CASE WHEN check_user_access(department, 'write')
         THEN salary ELSE NULL END AS salary,
    CASE WHEN check_user_access(department, 'admin')
         THEN ssn ELSE NULL END AS ssn
FROM employee_data
WHERE check_user_access(department, 'read');`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏉冮檺缁ф壙鍜屽眰绾?/h3>

      <CodeBlock
        title="瑙掕壊缁ф壙鍜屾潈闄愬眰绾?
        code={`-- 鍒涘缓鏉冮檺灞傜骇
CREATE ROLE base_user;                    -- 鍩虹鐢ㄦ埛
CREATE ROLE analyst INHERIT base_user;    -- 鍒嗘瀽甯堬紝缁ф壙鍩虹鐢ㄦ埛鏉冮檺
CREATE ROLE senior_analyst INHERIT analyst; -- 楂樼骇鍒嗘瀽甯堬紝缁ф壙鍒嗘瀽甯堟潈闄?
CREATE ROLE admin INHERIT senior_analyst;  -- 绠＄悊鍛橈紝缁ф壙楂樼骇鍒嗘瀽甯堟潈闄?

-- 鍩虹鏉冮檺锛堟墍鏈夌敤鎴凤級
GRANT CONNECT ON DATABASE company_db TO base_user;
GRANT USAGE ON SCHEMA public TO base_user;

-- 鍒嗘瀽甯堟潈闄?
GRANT SELECT ON ALL TABLES IN SCHEMA analytics TO analyst;

-- 楂樼骇鍒嗘瀽甯堟潈闄愶紙棰濆鏉冮檺锛?
GRANT INSERT, UPDATE ON TABLE analytics.reports TO senior_analyst;
GRANT CREATE TEMP TABLE TO senior_analyst;

-- 绠＄悊鍛樻潈闄?
GRANT ALL PRIVILEGES ON DATABASE company_db TO admin;

-- 鍒涘缓鐢ㄦ埛骞跺垎閰嶈鑹?
CREATE USER junior_analyst IN ROLE analyst;
CREATE USER expert_analyst IN ROLE senior_analyst;
CREATE USER system_admin IN ROLE admin;

-- 鏌ョ湅瑙掕壊缁ф壙鍏崇郴
SELECT
    role_name,
    member_name,
    inheritance  -- 鏄惁缁ф壙鏉冮檺
FROM (
    SELECT
        r.rolname AS role_name,
        m.rolname AS member_name,
        CASE WHEN r.rolname = m.rolname THEN false ELSE true END AS inheritance
    FROM pg_roles r
    CROSS JOIN pg_roles m
    WHERE r.oid = ANY (m.rolmembers) OR r.rolname = m.rolname
) role_hierarchy
ORDER BY role_name, member_name;

-- 鏉冮檺妫€鏌ュ嚱鏁?
CREATE OR REPLACE FUNCTION get_user_permissions(user_name VARCHAR)
RETURNS TABLE (
    role_name VARCHAR,
    inherited_from VARCHAR,
    permission_type VARCHAR,
    object_name VARCHAR
) AS $$
    -- 閫掑綊鏌ヨ鐢ㄦ埛鐨勬墍鏈夋潈闄愶紙鍖呮嫭缁ф壙鐨勶級
    WITH RECURSIVE user_roles AS (
        -- 鐩存帴瑙掕壊
        SELECT
            r.rolname::VARCHAR AS role_name,
            NULL::VARCHAR AS inherited_from
        FROM pg_roles r
        JOIN pg_auth_members am ON r.oid = am.member
        JOIN pg_roles ur ON am.roleid = ur.oid
        WHERE ur.rolname = user_name

        UNION

        -- 缁ф壙鐨勮鑹?
        SELECT
            r.rolname::VARCHAR,
            ur.role_name
        FROM pg_roles r
        JOIN pg_auth_members am ON r.oid = am.member
        JOIN user_roles ur ON am.roleid = (
            SELECT oid FROM pg_roles WHERE rolname = ur.role_name
        )
    )
    SELECT DISTINCT
        ur.role_name,
        ur.inherited_from,
        'ROLE'::VARCHAR,
        ur.role_name
    FROM user_roles ur;
$$ LANGUAGE SQL;

-- 妫€鏌ョ敤鎴锋潈闄?
SELECT * FROM get_user_permissions('expert_analyst');`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏉冮檺瀹¤鍜岀洃鎺?/h3>

      <CodeBlock
        title="鏉冮檺鍙樻洿瀹¤"
        code={`-- 鍒涘缓鏉冮檺瀹¤琛?
CREATE TABLE permission_audit (
    audit_id SERIAL PRIMARY KEY,
    action_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    action_user VARCHAR,
    action_type VARCHAR, -- 'GRANT', 'REVOKE', 'CREATE_ROLE', 'DROP_ROLE'
    target_type VARCHAR, -- 'USER', 'ROLE', 'TABLE', 'DATABASE'
    target_name VARCHAR,
    privilege_type VARCHAR,
    granted_by VARCHAR,
    notes TEXT
);

-- 瀹¤瑙﹀彂鍣ㄥ嚱鏁?
CREATE OR REPLACE FUNCTION audit_permission_change()
RETURNS EVENT_TRIGGER AS $$
DECLARE
    audit_record JSON;
BEGIN
    -- 鎹曡幏鏉冮檺鍙樻洿浜嬩欢
    SELECT json_build_object(
        'timestamp', CURRENT_TIMESTAMP,
        'user', current_user,
        'command', tg_tag,
        'object_type', tg_object_type,
        'object_name', tg_object_name
    ) INTO audit_record;

    INSERT INTO permission_audit (
        action_user, action_type, target_type, target_name, notes
    ) VALUES (
        current_user,
        tg_tag,
        tg_object_type,
        tg_object_name,
        audit_record::TEXT
    );

    RETURN;
END;
$$ LANGUAGE plpgsql;

-- 鍒涘缓浜嬩欢瑙﹀彂鍣紙闇€瑕佺鐞嗗憳鏉冮檺锛?
CREATE EVENT TRIGGER permission_audit_trigger
    ON ddl_command_end
    WHEN TAG IN ('GRANT', 'REVOKE', 'CREATE ROLE', 'DROP ROLE')
    EXECUTE FUNCTION audit_permission_change();

-- 鏉冮檺浣跨敤鐩戞帶
CREATE TABLE access_log (
    log_id SERIAL PRIMARY KEY,
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_name VARCHAR,
    database_name VARCHAR,
    schema_name VARCHAR,
    table_name VARCHAR,
    operation VARCHAR, -- SELECT, INSERT, UPDATE, DELETE
    row_count INTEGER,
    query_text TEXT,
    client_ip VARCHAR
);

-- 璁板綍璁块棶鏃ュ織鐨勫嚱鏁?
CREATE OR REPLACE FUNCTION log_table_access()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO access_log (
        user_name, database_name, schema_name, table_name,
        operation, row_count, query_text
    ) VALUES (
        current_user,
        current_database(),
        TG_TABLE_SCHEMA,
        TG_TABLE_NAME,
        TG_OP,
        CASE WHEN TG_OP = 'DELETE' THEN OLD IS NOT NULL ELSE NEW IS NOT NULL END,
        current_query()
    );

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- 涓烘晱鎰熻〃娣诲姞瀹¤瑙﹀彂鍣?
CREATE TRIGGER employee_access_audit
    AFTER INSERT OR UPDATE OR DELETE ON employee_data
    FOR EACH ROW EXECUTE FUNCTION log_table_access();

-- 鏉冮檺鍚堣妫€鏌?
CREATE OR REPLACE FUNCTION check_permission_compliance()
RETURNS TABLE (
    issue_type VARCHAR,
    severity VARCHAR,
    description TEXT,
    recommendation TEXT
) AS $$
BEGIN
    -- 妫€鏌ヨ繃搴︽潈闄?
    RETURN QUERY
    SELECT
        'OVER_PERMISSIONS'::VARCHAR,
        'HIGH'::VARCHAR,
        format('鐢ㄦ埛 %s 鎷ユ湁杩囧鏉冮檺', grantee)::TEXT,
        '鑰冭檻鍑忓皯涓嶅繀瑕佺殑鏉冮檺'::TEXT
    FROM information_schema.role_table_grants
    WHERE privilege_type = 'ALL'
      AND grantee NOT IN ('admin', 'postgres');

    -- 妫€鏌ュ绔嬬敤鎴?
    RETURN QUERY
    SELECT
        'ORPHANED_USERS'::VARCHAR,
        'MEDIUM'::VARCHAR,
        format('鐢ㄦ埛 %s 娌℃湁鍒嗛厤浠讳綍瑙掕壊', usename)::TEXT,
        '涓虹敤鎴峰垎閰嶉€傚綋鐨勮鑹?::TEXT
    FROM pg_user
    WHERE usename NOT IN (
        SELECT member_name FROM (
            SELECT r.rolname AS role_name, m.rolname AS member_name
            FROM pg_roles r
            CROSS JOIN pg_roles m
            WHERE r.oid = ANY (m.rolmembers)
        ) role_members
    );

    -- 妫€鏌ュ叕鍏辨潈闄?
    RETURN QUERY
    SELECT
        'PUBLIC_ACCESS'::VARCHAR,
        'CRITICAL'::VARCHAR,
        format('琛?%s 瀵?PUBLIC 瑙掕壊寮€鏀?, table_name)::TEXT,
        '绉婚櫎 PUBLIC 瑙掕壊鐨勮闂潈闄?::TEXT
    FROM information_schema.role_table_grants
    WHERE grantee = 'PUBLIC'
      AND privilege_type != 'CONNECT';
END;
$$ LANGUAGE plpgsql;

-- 杩愯鍚堣妫€鏌?
SELECT * FROM check_permission_compliance();`}
        {...noteProps('code3')}
      />

      <InfoBox type="tip" title="鏉冮檺绠＄悊鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鏈€灏忔潈闄愬師鍒欙細</strong> 鍙巿浜堝畬鎴愬伐浣滄墍闇€鐨勬渶灏忔潈闄?/li>
          <li><strong>瑙掕壊鍒嗙锛?/strong> 灏嗕笉鍚岃亴璐ｇ殑鏉冮檺鍒嗛厤缁欎笉鍚岃鑹?/li>
          <li><strong>瀹氭湡瀹¤锛?/strong> 瀹氭湡妫€鏌ュ拰娓呯悊涓嶅繀瑕佺殑鏉冮檺</li>
          <li><strong>鏉冮檺缁ф壙锛?/strong> 浣跨敤瑙掕壊缁ф壙绠€鍖栨潈闄愮鐞?/li>
          <li><strong>瀹¤鏃ュ織锛?/strong> 璁板綍鎵€鏈夋潈闄愬彉鏇村拰璁块棶鎿嶄綔</li>
          <li><strong>搴旀€ヨ闂細</strong> 寤虹珛涓存椂鏉冮檺鎻愬崌鍜屽鎵规祦绋?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彚 浼佷笟鏁版嵁娌荤悊</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">澶氶儴闂ㄦ暟鎹殧绂汇€佸悎瑙勬€ц姹傘€佸璁¤拷韪?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃攼 SaaS搴旂敤</h4>
          <p className="text-sm text-green-600 dark:text-green-400">澶氱鎴锋暟鎹殧绂汇€佺敤鎴锋潈闄愮鐞嗐€佹暟鎹畨鍏?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搳 鑷姪BI骞冲彴</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鍔ㄦ€佹潈闄愭帶鍒躲€佽绾у畨鍏ㄣ€佹暟鎹劚鏁?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃彞 鍖荤枟鍋ュ悍</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">HIPAA鍚堣銆佹偅鑰呮暟鎹繚鎶ゃ€佽闂帶鍒?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 璁捐涓€涓畬鏁寸殑RBAC鏉冮檺绯荤粺锛屾敮鎸佽鑹茬户鎵垮拰鏉冮檺鍒嗙骇</p>
          <p><strong>鎸戞垬 2锛?/strong> 瀹炵幇涓€涓潈闄愬璁″拰鐩戞帶绯荤粺锛岃窡韪墍鏈夋暟鎹闂涓?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓姩鎬佹潈闄愮鐞嗙郴缁燂紝鏀寔鍩轰簬灞炴€х殑璁块棶鎺у埗</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍔犲瘑涓庢帺鐮佺珷鑺?
// ============================================

export function EncryptionMaskingSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍔犲瘑涓庢帺鐮?/h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"淇濇姢鏁版嵁鐨勫灞傞槻寰?</p>

      <Paragraph {...noteProps('p1')}>
        鏁版嵁鍔犲瘑鍜屾帺鐮佹槸淇濇姢鏁忔劅淇℃伅鐨勫叧閿妧鏈€傚姞瀵嗙‘淇濇暟鎹湪瀛樺偍鍜屼紶杈撹繃绋嬩腑鐨勫畨鍏ㄦ€э紝鑰屾帺鐮佹妧鏈垯鍏佽鍦ㄩ潪鐢熶骇鐜涓畨鍏ㄥ湴浣跨敤绫讳技鐢熶骇鏁版嵁鐨勬祴璇曟暟鎹€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏁版嵁鍔犲瘑</h3>

      <SQLExplainer
        sql={`-- 鍒涘缓鍔犲瘑鍑芥暟锛堜娇鐢?pgcrypto 鎵╁睍锛?
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 瀵圭О鍔犲瘑
SELECT
    id,
    name,
    encrypt(sensitive_data::bytea, 'my_secret_key', 'aes') AS encrypted_data,
    decrypt(encrypted_data, 'my_secret_key', 'aes')::text AS decrypted_data
FROM user_sensitive_data;

-- 鍝堝笇瀛樺偍瀵嗙爜
SELECT
    username,
    crypt('user_password', gen_salt('bf', 8)) AS password_hash
FROM users;

-- 楠岃瘉瀵嗙爜
SELECT
    username,
    password_hash = crypt('entered_password', password_hash) AS password_valid
FROM users
WHERE username = 'testuser';`}
        explanations={[
          { code: 'encrypt(data, key, algorithm)', explanation: '浣跨敤瀵圭О瀵嗛挜鍔犲瘑鏁版嵁', tip: '鏀寔 AES銆丏ES 绛夌畻娉? },
          { code: 'crypt(password, salt)', explanation: '瀹夊叏鍝堝笇瀵嗙爜', tip: '浣跨敤 Blowfish 绠楁硶锛屽寘鍚洂鍊? },
          { code: 'gen_salt(type, rounds)', explanation: '鐢熸垚鐩愬€?, tip: '澧炲姞瀵嗙爜瀹夊叏鎬? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏁版嵁鑴辨晱鍜屾帺鐮?/h3>

      <CodeBlock
        title="鐢熶骇鏁版嵁瀹夊叏鑴辨晱"
        code={`-- 鍒涘缓鑴辨晱瑙嗗浘
CREATE VIEW customer_data_masked AS
SELECT
    customer_id,
    -- 濮撳悕鑴辨晱
    CASE
        WHEN LENGTH(name) > 1 THEN LEFT(name, 1) || REPEAT('*', LENGTH(name) - 1)
        ELSE name
    END AS name_masked,

    -- 閭鑴辨晱
    SPLIT_PART(email, '@', 1) || '@' || REPEAT('*', LENGTH(SPLIT_PART(email, '@', 2))) AS email_masked,

    -- 鐢佃瘽鍙风爜鑴辨晱
    LEFT(phone, 3) || '****' || RIGHT(phone, 4) AS phone_masked,

    -- 鍦板潃鑴辨晱锛堜繚鐣欑渷甯傚尯锛?
    CASE
        WHEN POSITION('鍖? IN address) > 0
        THEN LEFT(address, POSITION('鍖? IN address)) || '**琛楅亾**鍙?
        ELSE address
    END AS address_masked,

    -- 閲戦鍖洪棿鍖?
    CASE
        WHEN annual_income < 50000 THEN '< 50K'
        WHEN annual_income < 100000 THEN '50K - 100K'
        WHEN annual_income < 200000 THEN '100K - 200K'
        ELSE '> 200K'
    END AS income_range,

    registration_date,
    customer_segment
FROM customers;

-- 鍔ㄦ€佽劚鏁忓嚱鏁?
CREATE OR REPLACE FUNCTION mask_sensitive_data(
    data_type VARCHAR,
    original_value VARCHAR,
    mask_level VARCHAR DEFAULT 'standard'
) RETURNS VARCHAR AS $$
DECLARE
    result VARCHAR;
BEGIN
    CASE data_type
        WHEN 'name' THEN
            result := CASE mask_level
                WHEN 'full' THEN REPEAT('*', LENGTH(original_value))
                WHEN 'partial' THEN LEFT(original_value, 1) || REPEAT('*', LENGTH(original_value) - 1)
                ELSE original_value
            END;

        WHEN 'email' THEN
            result := CASE mask_level
                WHEN 'full' THEN REPEAT('*', LENGTH(original_value))
                WHEN 'partial' THEN
                    LEFT(original_value, POSITION('@' IN original_value) - 1) || '@****'
                ELSE original_value
            END;

        WHEN 'phone' THEN
            result := CASE mask_level
                WHEN 'full' THEN REPEAT('*', LENGTH(original_value))
                WHEN 'partial' THEN
                    LEFT(original_value, 3) || '****' || RIGHT(original_value, 4)
                ELSE original_value
            END;

        WHEN 'id_card' THEN
            result := CASE mask_level
                WHEN 'full' THEN REPEAT('*', LENGTH(original_value))
                WHEN 'partial' THEN
                    LEFT(original_value, 6) || '********' || RIGHT(original_value, 4)
                ELSE original_value
            END;

        ELSE
            result := original_value;
    END CASE;

    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 搴旂敤鍔ㄦ€佽劚鏁?
SELECT
    customer_id,
    mask_sensitive_data('name', name, 'partial') AS masked_name,
    mask_sensitive_data('email', email, 'partial') AS masked_email,
    mask_sensitive_data('phone', phone, 'partial') AS masked_phone,
    annual_income,
    registration_date
FROM customers;`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">娴嬭瘯鏁版嵁鐢熸垚</h3>

      <CodeBlock
        title="鐢熸垚瀹夊叏鐨勬祴璇曟暟鎹?
        code={`-- 闅忔満鏁版嵁鐢熸垚鍑芥暟
CREATE OR REPLACE FUNCTION generate_test_data(
    template_type VARCHAR,
    record_count INTEGER DEFAULT 1
) RETURNS TABLE (
    generated_value VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    CASE template_type
        WHEN 'name' THEN
            SELECT
                (ARRAY['寮?, '鏉?, '鐜?, '璧?, '鍒?, '闄?, '鏉?, '榛?, '鍛?, '鍚?])[1 + random() * 9] ||
                (ARRAY['浼?, '寮?, '鍐?, '鏄?, '姘?, '寤?, '鍥?, '骞?, '蹇?, '鏂?])[1 + random() * 9] ||
                (ARRAY['', '鍗?, '鏄?, '姘?, '蹇?, '鏂?, '鎴?, '鍗?, '蹇?, '鏂?])[1 + random() * 9]
            FROM generate_series(1, record_count);

        WHEN 'phone' THEN
            SELECT
                '1' || (ARRAY['3', '5', '7', '8'])[1 + random() * 3] ||
                LPAD((random() * 99999999)::INTEGER::VARCHAR, 8, '0')
            FROM generate_series(1, record_count);

        WHEN 'email' THEN
            SELECT
                'user' || (random() * 999999)::INTEGER || '@' ||
                (ARRAY['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com'])[1 + random() * 3]
            FROM generate_series(1, record_count);

        WHEN 'address' THEN
            SELECT
                (ARRAY['鍖椾含甯?, '涓婃捣甯?, '骞垮窞甯?, '娣卞湷甯?, '鏉窞甯?])[1 + random() * 4] ||
                (ARRAY['鏈濋槼鍖?, '娴锋穩鍖?, '娴︿笢鏂板尯', '澶╂渤鍖?, '鍗楀北鍖?])[1 + random() * 4] ||
                '娴嬭瘯琛楅亾' || (random() * 999)::INTEGER || '鍙?
            FROM generate_series(1, record_count);

        WHEN 'id_card' THEN
            SELECT
                (ARRAY['110101', '310101', '440101', '510101'])[1 + random() * 3] ||
                TO_CHAR(CURRENT_DATE - INTERVAL '20 years' + (random() * 60 || ' years')::INTERVAL, 'YYYYMMDD') ||
                LPAD((random() * 999)::INTEGER::VARCHAR, 3, '0') ||
                (random() * 9)::INTEGER::VARCHAR
            FROM generate_series(1, record_count);

        ELSE
            SELECT 'Unknown template type' FROM generate_series(1, record_count);
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- 鐢熸垚娴嬭瘯鏁版嵁闆?
CREATE TABLE test_customers AS
SELECT
    n AS customer_id,
    (SELECT generated_value FROM generate_test_data('name', 1) LIMIT 1) AS name,
    (SELECT generated_value FROM generate_test_data('phone', 1) LIMIT 1) AS phone,
    (SELECT generated_value FROM generate_test_data('email', 1) LIMIT 1) AS email,
    (SELECT generated_value FROM generate_test_data('address', 1) LIMIT 1) AS address,
    (SELECT generated_value FROM generate_test_data('id_card', 1) LIMIT 1) AS id_card,
    CURRENT_DATE - (random() * 365 * 5 || ' days')::INTERVAL AS registration_date,
    (random() * 100000)::DECIMAL(10,2) AS annual_income,
    (ARRAY['VIP', 'Gold', 'Silver', 'Bronze'])[1 + (random() * 3)::INTEGER] AS customer_segment
FROM generate_series(1, 1000) t(n);

-- 楠岃瘉娴嬭瘯鏁版嵁璐ㄩ噺
SELECT
    COUNT(*) AS total_records,
    COUNT(DISTINCT name) AS unique_names,
    COUNT(DISTINCT phone) AS unique_phones,
    AVG(LENGTH(name)) AS avg_name_length,
    AVG(annual_income) AS avg_income
FROM test_customers;

-- 鐢熶骇鏁版嵁缁熻瀵规瘮锛堣劚鏁忓悗锛?
SELECT
    'Production' AS data_source,
    COUNT(*) AS customer_count,
    ROUND(AVG(annual_income), 2) AS avg_income,
    COUNT(DISTINCT customer_segment) AS segments
FROM customers

UNION ALL

SELECT
    'Test' AS data_source,
    COUNT(*) AS customer_count,
    ROUND(AVG(annual_income), 2) AS avg_income,
    COUNT(DISTINCT customer_segment) AS segments
FROM test_customers;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏁版嵁鍔犲瘑瀛樺偍</h3>

      <CodeBlock
        title="閫忔槑鏁版嵁鍔犲瘑"
        code={`-- 鍒涘缓鍔犲瘑琛?
CREATE TABLE encrypted_customer_data (
    customer_id INTEGER PRIMARY KEY,
    encrypted_ssn VARCHAR,    -- 鍔犲瘑瀛樺偍
    encrypted_credit_card VARCHAR,
    name VARCHAR,             -- 涓嶅姞瀵?
    email VARCHAR,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 鍔犲瘑鎻掑叆鍑芥暟
CREATE OR REPLACE FUNCTION insert_encrypted_customer(
    p_customer_id INTEGER,
    p_ssn VARCHAR,
    p_credit_card VARCHAR,
    p_name VARCHAR,
    p_email VARCHAR
) RETURNS VOID AS $$
DECLARE
    encryption_key VARCHAR := 'my_database_encryption_key_2024';
BEGIN
    INSERT INTO encrypted_customer_data (
        customer_id,
        encrypted_ssn,
        encrypted_credit_card,
        name,
        email
    ) VALUES (
        p_customer_id,
        encode(encrypt(p_ssn::bytea, encryption_key, 'aes'), 'hex'),
        encode(encrypt(p_credit_card::bytea, encryption_key, 'aes'), 'hex'),
        p_name,
        p_email
    );
END;
$$ LANGUAGE plpgsql;

-- 瑙ｅ瘑鏌ヨ鍑芥暟
CREATE OR REPLACE FUNCTION get_decrypted_customer(customer_id_param INTEGER)
RETURNS TABLE (
    customer_id INTEGER,
    ssn VARCHAR,
    credit_card VARCHAR,
    name VARCHAR,
    email VARCHAR
) AS $$
DECLARE
    encryption_key VARCHAR := 'my_database_encryption_key_2024';
BEGIN
    RETURN QUERY
    SELECT
        ecd.customer_id,
        decrypt(decode(ecd.encrypted_ssn, 'hex'), encryption_key, 'aes')::text,
        decrypt(decode(ecd.encrypted_credit_card, 'hex'), encryption_key, 'aes')::text,
        ecd.name,
        ecd.email
    FROM encrypted_customer_data ecd
    WHERE ecd.customer_id = customer_id_param;
END;
$$ LANGUAGE plpgsql;

-- 浣跨敤绀轰緥
SELECT * FROM insert_encrypted_customer(1, '123-45-6789', '4111-1111-1111-1111', 'John Doe', 'john@example.com');
SELECT * FROM get_decrypted_customer(1);

-- 瀛楁绾у姞瀵嗙瓥鐣?
CREATE TABLE data_classification (
    table_name VARCHAR,
    column_name VARCHAR,
    classification VARCHAR, -- 'public', 'internal', 'confidential', 'restricted'
    encryption_required BOOLEAN DEFAULT FALSE,
    PRIMARY KEY (table_name, column_name)
);

-- 鎻掑叆鍒嗙被瑙勫垯
INSERT INTO data_classification VALUES
    ('customers', 'name', 'internal', FALSE),
    ('customers', 'email', 'internal', FALSE),
    ('customers', 'phone', 'confidential', TRUE),
    ('customers', 'ssn', 'restricted', TRUE),
    ('customers', 'credit_score', 'confidential', TRUE);

-- 鑷姩鍔犲瘑鍑芥暟
CREATE OR REPLACE FUNCTION apply_data_encryption(
    table_name_param VARCHAR,
    record_data JSON
) RETURNS JSON AS $$
DECLARE
    result JSON := record_data;
    encryption_key VARCHAR := 'column_level_encryption_key';
    field_record RECORD;
BEGIN
    FOR field_record IN
        SELECT column_name, classification, encryption_required
        FROM data_classification
        WHERE table_name = table_name_param
          AND encryption_required = TRUE
    LOOP
        -- 瀵归渶瑕佸姞瀵嗙殑瀛楁杩涜鍔犲瘑
        result := jsonb_set(
            result::jsonb,
            ARRAY[field_record.column_name],
            to_jsonb(encode(
                encrypt(
                    (result->>field_record.column_name)::bytea,
                    encryption_key,
                    'aes'
                ),
                'hex'
            )),
            true
        );
    END LOOP;

    RETURN result;
END;
$$ LANGUAGE plpgsql;`}
        {...noteProps('code3')}
      />

      <InfoBox type="warning" title="鍔犲瘑鍜岃劚鏁忓畨鍏ㄦ敞鎰忎簨椤? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>瀵嗛挜绠＄悊锛?/strong> 鍔犲瘑瀵嗛挜搴斿畨鍏ㄥ瓨鍌紝瀹氭湡杞崲锛岄伩鍏嶇‖缂栫爜</li>
          <li><strong>绠楁硶閫夋嫨锛?/strong> 浣跨敤AES-256绛夋爣鍑嗗姞瀵嗙畻娉曪紝閬垮厤杩囨椂绠楁硶</li>
          <li><strong>鎬ц兘褰卞搷锛?/strong> 鍔犲瘑/瑙ｅ瘑鎿嶄綔浼氬奖鍝嶆煡璇㈡€ц兘锛屽悎鐞嗚瘎浼?/li>
          <li><strong>鍚堣瑕佹眰锛?/strong> 浜嗚ВGDPR銆丆CPA绛夋硶瑙勫鏁版嵁淇濇姢鐨勮姹?/li>
          <li><strong>璁块棶鎺у埗锛?/strong> 鍔犲瘑鏁版嵁搴斾笌璁块棶鏉冮檺鐩哥粨鍚?/li>
          <li><strong>澶囦唤瀹夊叏锛?/strong> 鍔犲瘑鏁版嵁鐨勫浠戒篃闇€瑕佷繚鎶?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彟 閲戣瀺鏈嶅姟</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">PII鏁版嵁淇濇姢銆佷氦鏄撲俊鎭姞瀵嗐€佸悎瑙勫璁?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃彞 鍖荤枟鍋ュ悍</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鎮ｈ€呴殣绉佷繚鎶ゃ€佸尰鐤楄褰曞姞瀵嗐€丠IPAA鍚堣</p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃洅 鐢靛晢骞冲彴</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鏀粯淇℃伅鍔犲瘑銆佺敤鎴锋暟鎹劚鏁忋€佹祴璇曠幆澧冨畨鍏?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃И 杞欢娴嬭瘯</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鐢熶骇鏁版嵁鑴辨晱銆佹祴璇曟暟鎹敓鎴愩€佸畨鍏ㄦ祴璇曠幆澧?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓畬鏁寸殑鏁版嵁鑴辨晱绯荤粺锛屾敮鎸佸绉嶆暟鎹被鍨嬪拰鑴辨晱绛栫暐</p>
          <p><strong>鎸戞垬 2锛?/strong> 鏋勫缓涓€涓姞瀵嗘暟鎹鐞嗙郴缁燂紝鏀寔瀛楁绾у姞瀵嗗拰瀵嗛挜杞崲</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓櫤鑳芥祴璇曟暟鎹敓鎴愬櫒锛岃兘澶熶繚鎸佸師濮嬫暟鎹殑缁熻鐗瑰緛</p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 瀹¤鏃ュ織绔犺妭
// ============================================

export function AuditLogsSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">瀹¤鏃ュ織</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"杩借釜姣忎竴娆℃暟鎹彉鏇?</p>

      <Paragraph {...noteProps('p1')}>
        瀹¤鏃ュ織鏄暟鎹簱瀹夊叏鍜屽悎瑙勭殑鏍稿績缁勪欢銆傚畠璁板綍鎵€鏈夋暟鎹闂€佷慨鏀广€佸垹闄ょ瓑鎿嶄綔锛屾敮鎸佷簨鍚庡垎鏋愩€侀棶棰樻帓鏌ャ€佸畨鍏ㄥ璁″拰鍚堣鎶ュ憡銆傚畬鏁寸殑瀹¤鏃ュ織绯荤粺鑳藉鍥炵瓟"Who did What, When, Where, How"鐨勯棶棰樸€?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩虹瀹¤瀹炵幇</h3>

      <SQLExplainer
        sql={`-- 鍒涘缓瀹¤鏃ュ織琛?
CREATE TABLE audit_log (
    audit_id SERIAL PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    operation VARCHAR(10) NOT NULL, -- INSERT, UPDATE, DELETE
    old_values JSONB,
    new_values JSONB,
    user_name VARCHAR(100),
    session_id VARCHAR(100),
    client_ip INET,
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    transaction_id BIGINT
);

-- 閫氱敤瀹¤瑙﹀彂鍣ㄥ嚱鏁?
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
DECLARE
    old_row JSONB;
    new_row JSONB;
    operation_type VARCHAR(10);
BEGIN
    -- 纭畾鎿嶄綔绫诲瀷
    IF TG_OP = 'INSERT' THEN
        operation_type := 'INSERT';
        old_row := NULL;
        new_row := to_jsonb(NEW);
    ELSIF TG_OP = 'UPDATE' THEN
        operation_type := 'UPDATE';
        old_row := to_jsonb(OLD);
        new_row := to_jsonb(NEW);
    ELSIF TG_OP = 'DELETE' THEN
        operation_type := 'DELETE';
        old_row := to_jsonb(OLD);
        new_row := NULL;
    ELSE
        RETURN COALESCE(NEW, OLD);
    END IF;

    -- 鎻掑叆瀹¤璁板綍
    INSERT INTO audit_log (
        table_name, operation, old_values, new_values,
        user_name, session_id, transaction_id
    ) VALUES (
        TG_TABLE_NAME,
        operation_type,
        old_row,
        new_row,
        current_user,
        pg_backend_pid()::VARCHAR,
        txid_current()
    );

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- 涓鸿〃娣诲姞瀹¤瑙﹀彂鍣?
CREATE TRIGGER audit_customers_trigger
    AFTER INSERT OR UPDATE OR DELETE ON customers
    FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();`}
        explanations={[
          { code: 'CREATE TABLE audit_log', explanation: '鍒涘缓瀹¤鏃ュ織琛ㄥ瓨鍌ㄦ墍鏈夊彉鏇磋褰?, tip: '鍖呭惈鎿嶄綔绫诲瀷銆佹棫鍊兼柊鍊笺€佺敤鎴蜂俊鎭瓑' },
          { code: 'audit_trigger_function()', explanation: '閫氱敤瀹¤瑙﹀彂鍣ㄥ嚱鏁?, tip: '鍙互澶嶇敤浜庡涓〃鐨勫璁? },
          { code: 'AFTER INSERT OR UPDATE OR DELETE', explanation: '鐩戝惉鎵€鏈塂ML鎿嶄綔', tip: '纭繚璁板綍鎵€鏈夋暟鎹彉鏇? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇瀹¤鍔熻兘</h3>

      <CodeBlock
        title="鏉′欢瀹¤鍜屾€ц兘浼樺寲"
        code={`-- 鏉′欢瀹¤锛堝彧璁板綍閲嶈鍙樻洿锛?
CREATE OR REPLACE FUNCTION selective_audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    -- 鍙璁￠噸瑕佸瓧娈电殑鍙樻洿
    IF TG_OP = 'UPDATE' THEN
        -- 妫€鏌ュ叧閿瓧娈垫槸鍚﹀彉鏇?
        IF (OLD.status IS DISTINCT FROM NEW.status) OR
           (OLD.balance IS DISTINCT FROM NEW.balance) OR
           (OLD.email IS DISTINCT FROM NEW.email) THEN

            INSERT INTO audit_log (
                table_name, operation, old_values, new_values,
                user_name, operation_time
            ) VALUES (
                TG_TABLE_NAME, 'UPDATE',
                jsonb_build_object(
                    'id', OLD.id,
                    'status', OLD.status,
                    'balance', OLD.balance,
                    'email', OLD.email
                ),
                jsonb_build_object(
                    'id', NEW.id,
                    'status', NEW.status,
                    'balance', NEW.balance,
                    'email', NEW.email
                ),
                current_user,
                CURRENT_TIMESTAMP
            );
        END IF;
    ELSE
        -- INSERT 鍜?DELETE 鎬绘槸璁板綍
        INSERT INTO audit_log (
            table_name, operation,
            old_values, new_values,
            user_name, operation_time
        ) VALUES (
            TG_TABLE_NAME, TG_OP,
            CASE WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD) ELSE NULL END,
            CASE WHEN TG_OP = 'INSERT' THEN to_jsonb(NEW) ELSE NULL END,
            current_user,
            CURRENT_TIMESTAMP
        );
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- 瀹¤鏁版嵁鍘嬬缉锛堝噺灏戝瓨鍌ㄧ┖闂达級
CREATE OR REPLACE FUNCTION compress_audit_data()
RETURNS VOID AS $$
BEGIN
    -- 鍒犻櫎30澶╁墠鐨勯潪鍏抽敭瀹¤璁板綍
    DELETE FROM audit_log
    WHERE operation_time < CURRENT_TIMESTAMP - INTERVAL '30 days'
      AND operation = 'SELECT'; -- 濡傛灉璁板綍浜哠ELECT鎿嶄綔

    -- 鍘嬬缉鏃ц褰曪紙鍙繚鐣欏彉鏇存憳瑕侊級
    UPDATE audit_log
    SET old_values = jsonb_build_object('compressed', true, 'record_count', 1),
        new_values = jsonb_build_object('compressed', true, 'record_count', 1)
    WHERE operation_time < CURRENT_TIMESTAMP - INTERVAL '90 days'
      AND jsonb_typeof(old_values) = 'object'
      AND jsonb_object_keys(old_values) > 10; -- 鍙帇缂╁ぇ瀵硅薄
END;
$$ LANGUAGE plpgsql;

-- 瀹¤鏌ヨ浼樺寲
CREATE INDEX idx_audit_log_table_time ON audit_log(table_name, operation_time DESC);
CREATE INDEX idx_audit_log_user_time ON audit_log(user_name, operation_time DESC);
CREATE INDEX idx_audit_log_operation ON audit_log(operation);

-- 鍒嗗尯瀹¤琛紙鎸夋湀鍒嗗尯锛?
CREATE TABLE audit_log_y2024m01 (
    LIKE audit_log INCLUDING ALL
) PARTITION BY RANGE (operation_time);

-- 鍒涘缓鍒嗗尯
CREATE TABLE audit_log_y2024m01 PARTITION OF audit_log_y2024m01
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE audit_log_y2024m02 PARTITION OF audit_log_y2024m01
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹¤鍒嗘瀽鍜屾姤鍛?/h3>

      <CodeBlock
        title="瀹¤鏁版嵁鍒嗘瀽鏌ヨ"
        code={`-- 鐢ㄦ埛娲诲姩缁熻
SELECT
    user_name,
    COUNT(*) AS total_operations,
    COUNT(CASE WHEN operation = 'INSERT' THEN 1 END) AS inserts,
    COUNT(CASE WHEN operation = 'UPDATE' THEN 1 END) AS updates,
    COUNT(CASE WHEN operation = 'DELETE' THEN 1 END) AS deletes,
    MIN(operation_time) AS first_activity,
    MAX(operation_time) AS last_activity
FROM audit_log
WHERE operation_time >= CURRENT_TIMESTAMP - INTERVAL '30 days'
GROUP BY user_name
ORDER BY total_operations DESC;

-- 琛ㄥ彉鏇寸粺璁?
SELECT
    table_name,
    operation,
    COUNT(*) AS operation_count,
    COUNT(DISTINCT user_name) AS unique_users,
    MIN(operation_time) AS first_change,
    MAX(operation_time) AS last_change
FROM audit_log
GROUP BY table_name, operation
ORDER BY table_name, operation;

-- 寮傚父娲诲姩妫€娴?
WITH user_patterns AS (
    SELECT
        user_name,
        DATE_TRUNC('hour', operation_time) AS hour_slot,
        COUNT(*) AS operations_per_hour,
        AVG(COUNT(*)) OVER (PARTITION BY user_name) AS avg_operations_per_hour
    FROM audit_log
    WHERE operation_time >= CURRENT_TIMESTAMP - INTERVAL '7 days'
    GROUP BY user_name, DATE_TRUNC('hour', operation_time)
)
SELECT
    user_name,
    hour_slot,
    operations_per_hour,
    avg_operations_per_hour,
    CASE
        WHEN operations_per_hour > avg_operations_per_hour * 5 THEN '寮傚父楂橀'
        WHEN operations_per_hour < avg_operations_per_hour * 0.1 THEN '寮傚父浣庨'
        ELSE '姝ｅ父'
    END AS activity_status
FROM user_patterns
WHERE operations_per_hour > avg_operations_per_hour * 3
   OR operations_per_hour < avg_operations_per_hour * 0.2
ORDER BY hour_slot DESC;

-- 鏁版嵁琛€缂樿拷韪?
WITH RECURSIVE data_lineage AS (
    -- 璧峰璁板綍
    SELECT
        audit_id,
        table_name,
        operation,
        new_values->>'id' AS record_id,
        user_name,
        operation_time,
        1 AS level,
        ARRAY[audit_id] AS path
    FROM audit_log
    WHERE table_name = 'orders'
      AND operation = 'INSERT'
      AND new_values->>'customer_id' = '12345'

    UNION ALL

    -- 閫掑綊鏌ユ壘鐩稿叧璁板綍
    SELECT
        al.audit_id,
        al.table_name,
        al.operation,
        COALESCE(al.new_values->>'id', al.old_values->>'id'),
        al.user_name,
        al.operation_time,
        dl.level + 1,
        dl.path || al.audit_id
    FROM audit_log al
    JOIN data_lineage dl ON (
        al.operation_time > dl.operation_time
        AND (
            (al.table_name = 'customers' AND al.new_values->>'id' = dl.record_id) OR
            (al.table_name = 'order_items' AND al.new_values->>'order_id' = dl.record_id)
        )
    )
    WHERE dl.level < 5 -- 闄愬埗閫掑綊娣卞害
)
SELECT
    level,
    table_name,
    operation,
    record_id,
    user_name,
    operation_time
FROM data_lineage
ORDER BY level, operation_time;`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍚堣瀹¤鎶ュ憡</h3>

      <CodeBlock
        title="鐢熸垚鍚堣瀹¤鎶ュ憡"
        code={`-- SOX 鍚堣鎶ュ憡锛堣储鍔℃暟鎹彉鏇村璁★級
CREATE OR REPLACE FUNCTION generate_sox_compliance_report(
    start_date DATE,
    end_date DATE
) RETURNS TABLE (
    report_section VARCHAR,
    finding VARCHAR,
    severity VARCHAR,
    details TEXT,
    recommendation TEXT
) AS $$
BEGIN
    -- 璐㈠姟琛ㄥ彉鏇存鏌?
    RETURN QUERY
    SELECT
        '璐㈠姟鏁版嵁鍙樻洿'::VARCHAR,
        '鏈巿鏉冨彉鏇?::VARCHAR,
        'HIGH'::VARCHAR,
        format('鐢ㄦ埛 %s 鍦?%s 淇敼浜嗚储鍔¤褰?, al.user_name, al.operation_time)::TEXT,
        '瀹℃煡鍙樻洿鍚堢悊鎬у苟纭鎺堟潈'::TEXT
    FROM audit_log al
    WHERE al.table_name IN ('financial_transactions', 'accounts', 'ledger')
      AND al.operation = 'UPDATE'
      AND al.operation_time BETWEEN start_date AND end_date
      AND al.user_name NOT IN (SELECT username FROM authorized_financial_users);

    -- 鎵归噺鎿嶄綔妫€鏌?
    RETURN QUERY
    WITH batch_operations AS (
        SELECT
            user_name,
            DATE_TRUNC('minute', operation_time) AS minute_slot,
            COUNT(*) AS operations_in_minute
        FROM audit_log
        WHERE operation_time BETWEEN start_date AND end_date
        GROUP BY user_name, DATE_TRUNC('minute', operation_time)
        HAVING COUNT(*) > 100 -- 鍗曞垎閽熷唴瓒呰繃100娆℃搷浣?
    )
    SELECT
        '鎵归噺鎿嶄綔鐩戞帶'::VARCHAR,
        '寮傚父鎵归噺鎿嶄綔'::VARCHAR,
        'MEDIUM'::VARCHAR,
        format('鐢ㄦ埛 %s 鍦?%s 鎵ц浜?%s 娆℃搷浣?,
               bo.user_name, bo.minute_slot, bo.operations_in_minute)::TEXT,
        '璋冩煡鎵归噺鎿嶄綔鐨勪笟鍔″悎鐞嗘€?::TEXT
    FROM batch_operations bo;

    -- 鏁忔劅鏁版嵁璁块棶妫€鏌?
    RETURN QUERY
    SELECT
        '鏁忔劅鏁版嵁璁块棶'::VARCHAR,
        '闈炲伐浣滄椂闂磋闂?::VARCHAR,
        'LOW'::VARCHAR,
        format('鐢ㄦ埛 %s 鍦ㄩ潪宸ヤ綔鏃堕棿璁块棶浜嗚〃 %s',
               al.user_name, al.table_name)::TEXT,
        '纭璁块棶鐨勪笟鍔″繀瑕佹€?::TEXT
    FROM audit_log al
    WHERE al.table_name IN ('sensitive_customer_data', 'financial_records')
      AND al.operation_time BETWEEN start_date AND end_date
      AND EXTRACT(HOUR FROM al.operation_time) NOT BETWEEN 9 AND 17; -- 闈炲伐浣滄椂闂?

END;
$$ LANGUAGE plpgsql;

-- 鐢熸垚鏈堝害瀹¤鎶ュ憡
SELECT * FROM generate_sox_compliance_report(
    DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month'),
    DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1 day'
);

-- 瀹¤鏁版嵁瀵煎嚭锛堢敤浜庡閮ㄥ璁★級
COPY (
    SELECT
        audit_id,
        table_name,
        operation,
        old_values,
        new_values,
        user_name,
        operation_time,
        'SYSTEM_AUDIT_' || audit_id AS audit_reference
    FROM audit_log
    WHERE operation_time >= '2024-01-01'
    ORDER BY operation_time
) TO '/var/audit/2024_audit_export.csv' WITH CSV HEADER;

-- 瀹¤瀹屾暣鎬ч獙璇?
SELECT
    COUNT(*) AS total_audit_records,
    COUNT(DISTINCT table_name) AS tables_audited,
    MIN(operation_time) AS audit_period_start,
    MAX(operation_time) AS audit_period_end,
    -- 妫€鏌ユ槸鍚︽湁瀹¤璁板綍缂哄け锛堢畝鍗曟鏌ワ級
    CASE WHEN COUNT(*) > 0 THEN '瀹¤鏁版嵁瀹屾暣' ELSE '瀹¤鏁版嵁缂哄け' END AS integrity_status
FROM audit_log
WHERE operation_time >= CURRENT_TIMESTAMP - INTERVAL '24 hours';`}
        {...noteProps('code3')}
      />

      <InfoBox type="tip" title="瀹¤鏃ュ織鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>瀹屾暣鎬э細</strong> 璁板綍鎵€鏈夊叧閿暟鎹搷浣滐紝涓嶉仐婕忛噸瑕佸彉鏇?/li>
          <li><strong>鎬ц兘褰卞搷锛?/strong> 瀹¤鎿嶄綔涓嶅簲璇ユ樉钁楀奖鍝嶆甯镐笟鍔℃€ц兘</li>
          <li><strong>瀛樺偍绠＄悊锛?/strong> 瀹氭湡褰掓。鍜屾竻鐞嗘棫鐨勫璁℃暟鎹?/li>
          <li><strong>瀹夊叏淇濇姢锛?/strong> 瀹¤鏃ュ織鏈韩闇€瑕佷繚鎶わ紝闃叉琚鏀?/li>
          <li><strong>瀹炴椂鐩戞帶锛?/strong> 瀵瑰紓甯告椿鍔ㄨ繘琛屽疄鏃跺憡璀?/li>
          <li><strong>鍚堣瑕佹眰锛?/strong> 鏍规嵁琛屼笟鏍囧噯瀹氬埗瀹¤鍐呭</li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彟 閲戣瀺瀹¤</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">浜ゆ槗璁板綍杩借釜銆佸悎瑙勬姤鍛娿€佸紓甯告娴?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃彞 鍖荤枟鍚堣</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鎮ｈ€呮暟鎹闂褰曘€丠IPAA鍚堣銆侀殣绉佷繚鎶?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃攳 瀹夊叏鍙栬瘉</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鍏ヤ镜妫€娴嬨€佷簨浠跺搷搴斻€佹暟瀛楀彇璇?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃搳 鏁版嵁娌荤悊</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鏁版嵁琛€缂樿拷韪€佽川閲忕洃鎺с€佸彉鏇寸鐞?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓畬鏁寸殑瀹¤鏃ュ織绯荤粺锛屾敮鎸佸琛ㄥ璁″拰瀹炴椂鐩戞帶</p>
          <p><strong>鎸戞垬 2锛?/strong> 鏋勫缓涓€涓璁℃暟鎹垎鏋愬钩鍙帮紝鏀寔寮傚父妫€娴嬪拰鍚堣鎶ュ憡</p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓暟鎹缂樿拷韪郴缁燂紝鑳藉杩借釜鏁版嵁鐨勫畬鏁寸敓鍛藉懆鏈?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 琛岀骇瀹夊叏绔犺妭
// ============================================

export function RowLevelSecuritySection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">琛岀骇瀹夊叏</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"绮剧粏鍖栫殑鏁版嵁璁块棶鎺у埗"</p>

      <Paragraph {...noteProps('p1')}>
        琛岀骇瀹夊叏锛圧ow Level Security, RLS锛夊厑璁稿琛ㄤ腑鐨勬瘡涓€琛屾暟鎹簲鐢ㄧ粏绮掑害鐨勮闂帶鍒剁瓥鐣ャ€傜敤鎴峰彧鑳界湅鍒板拰鎿嶄綔浠栦滑琚巿鏉冭闂殑鏁版嵁琛岋紝杩欏浜庡绉熸埛搴旂敤銆侀儴闂ㄩ殧绂汇€佸湴鐞嗛檺鍒剁瓑鍦烘櫙鑷冲叧閲嶈銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩虹琛岀骇瀹夊叏</h3>

      <SQLExplainer
        sql={`-- 鍒涘缓澶氱鎴疯〃
CREATE TABLE tenant_data (
    tenant_id INTEGER NOT NULL,
    data_id SERIAL,
    sensitive_info VARCHAR,
    created_by VARCHAR,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 鍚敤琛岀骇瀹夊叏
ALTER TABLE tenant_data ENABLE ROW LEVEL SECURITY;

-- 鍒涘缓瀹夊叏绛栫暐锛氱敤鎴峰彧鑳借闂嚜宸辩鎴风殑鏁版嵁
CREATE POLICY tenant_isolation_policy ON tenant_data
    FOR ALL
    USING (tenant_id = current_setting('app.current_tenant_id')::INTEGER);

-- 璁剧疆褰撳墠绉熸埛涓婁笅鏂?
SET app.current_tenant_id = 1;

-- 鐜板湪鐢ㄦ埛鍙兘鐪嬪埌绉熸埛1鐨勬暟鎹?
SELECT * FROM tenant_data; -- 鍙繑鍥?tenant_id = 1 鐨勮

-- 鎻掑叆鏂版暟鎹椂鑷姩璁剧疆绉熸埛ID
CREATE OR REPLACE FUNCTION set_tenant_id()
RETURNS TRIGGER AS $$
BEGIN
    NEW.tenant_id := current_setting('app.current_tenant_id')::INTEGER;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_tenant_trigger
    BEFORE INSERT ON tenant_data
    FOR EACH ROW EXECUTE FUNCTION set_tenant_id();`}
        explanations={[
          { code: 'ENABLE ROW LEVEL SECURITY', explanation: '涓鸿〃鍚敤琛岀骇瀹夊叏鍔熻兘', tip: '鍚敤鍚庨渶瑕佸垱寤哄叿浣撶殑绛栫暐' },
          { code: 'CREATE POLICY ... USING', explanation: '鍒涘缓瀹夊叏绛栫暐锛屽畾涔夊摢浜涜鍙互琚闂?, tip: 'USING瀛愬彞瀹氫箟鏌ヨ鏃剁殑杩囨护鏉′欢' },
          { code: 'current_setting()', explanation: '鑾峰彇褰撳墠浼氳瘽璁剧疆', tip: '鐢ㄤ簬浼犻€掔敤鎴蜂笂涓嬫枃淇℃伅' },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">楂樼骇瀹夊叏绛栫暐</h3>

      <CodeBlock
        title="澶嶆潅鐨勮绾у畨鍏ㄧ瓥鐣?
        code={`-- 鍛樺伐鏁版嵁琛紙甯﹂儴闂ㄥ拰瑙掕壊闄愬埗锛?
CREATE TABLE employee_records (
    employee_id INTEGER PRIMARY KEY,
    department VARCHAR,
    salary DECIMAL,
    performance_reviews JSONB,
    manager_id INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE employee_records ENABLE ROW LEVEL SECURITY;

-- 绛栫暐1锛氬憳宸ュ彧鑳芥煡鐪嬭嚜宸卞拰涓嬪睘鐨勮褰?
CREATE POLICY employee_self_access ON employee_records
    FOR SELECT
    USING (
        employee_id = current_setting('app.user_id')::INTEGER
        OR manager_id = current_setting('app.user_id')::INTEGER
    );

-- 绛栫暐2锛氱粡鐞嗗彲浠ユ煡鐪嬫湰閮ㄩ棬鎵€鏈夊憳宸?
CREATE POLICY manager_department_access ON employee_records
    FOR SELECT
    USING (
        department = (
            SELECT department FROM employee_records
            WHERE employee_id = current_setting('app.user_id')::INTEGER
        )
        AND current_setting('app.user_role') = 'manager'
    );

-- 绛栫暐3锛欻R鍙互鏌ョ湅鎵€鏈夎褰?
CREATE POLICY hr_full_access ON employee_records
    FOR ALL
    USING (current_setting('app.user_role') = 'hr');

-- 绛栫暐4锛氶檺鍒舵晱鎰熶俊鎭闂?
CREATE POLICY salary_restriction ON employee_records
    FOR SELECT
    USING (
        current_setting('app.user_role') IN ('hr', 'manager', 'employee')
        AND (
            employee_id = current_setting('app.user_id')::INTEGER
            OR current_setting('app.user_role') IN ('hr', 'manager')
        )
    )
    WITH CHECK (
        -- 鍛樺伐涓嶈兘淇敼钖祫
        current_setting('app.user_role') != 'employee'
        OR OLD.salary = NEW.salary
    );

-- 鏌ョ湅鎵€鏈夌瓥鐣?
SELECT * FROM pg_policies WHERE tablename = 'employee_records';`}
        {...noteProps('code1')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍔ㄦ€佸畨鍏ㄤ笂涓嬫枃</h3>

      <CodeBlock
        title="鍩轰簬瑙掕壊鐨勫姩鎬佹潈闄愭帶鍒?
        code={`-- 鐢ㄦ埛瑙掕壊鍜屾潈闄愰厤缃〃
CREATE TABLE user_permissions (
    user_id INTEGER,
    resource_type VARCHAR, -- 'department', 'project', 'region'
    resource_id VARCHAR,
    permission_level VARCHAR, -- 'read', 'write', 'admin'
    valid_from TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    valid_until TIMESTAMP DEFAULT 'infinity'
);

-- 鍔ㄦ€佹潈闄愭鏌ュ嚱鏁?
CREATE OR REPLACE FUNCTION check_user_permission(
    p_user_id INTEGER,
    p_resource_type VARCHAR,
    p_resource_id VARCHAR,
    p_required_level VARCHAR
) RETURNS BOOLEAN AS $$
DECLARE
    user_level VARCHAR;
    level_hierarchy INTEGER;
    required_hierarchy INTEGER;
BEGIN
    -- 鑾峰彇鐢ㄦ埛瀵硅璧勬簮鐨勬潈闄愮骇鍒?
    SELECT permission_level INTO user_level
    FROM user_permissions
    WHERE user_id = p_user_id
      AND resource_type = p_resource_type
      AND resource_id = p_resource_id
      AND CURRENT_TIMESTAMP BETWEEN valid_from AND valid_until;

    IF user_level IS NULL THEN
        RETURN FALSE;
    END IF;

    -- 瀹氫箟鏉冮檺灞傜骇
    level_hierarchy := CASE user_level
        WHEN 'read' THEN 1
        WHEN 'write' THEN 2
        WHEN 'admin' THEN 3
        ELSE 0
    END;

    required_hierarchy := CASE p_required_level
        WHEN 'read' THEN 1
        WHEN 'write' THEN 2
        WHEN 'admin' THEN 3
        ELSE 999
    END;

    RETURN level_hierarchy >= required_hierarchy;
END;
$$ LANGUAGE plpgsql;

-- 搴旂敤鍔ㄦ€佹潈闄愮殑琛岀骇瀹夊叏绛栫暐
CREATE POLICY dynamic_resource_access ON company_resources
    FOR ALL
    USING (
        check_user_permission(
            current_setting('app.user_id')::INTEGER,
            'resource',
            resource_id::VARCHAR,
            CASE
                WHEN current_query_contains('SELECT') THEN 'read'
                WHEN current_query_contains('INSERT', 'UPDATE') THEN 'write'
                ELSE 'admin'
            END
        )
    );

-- 鏃堕棿-based 鏉冮檺锛堜复鏃惰闂級
CREATE POLICY temporary_access ON sensitive_documents
    FOR SELECT
    USING (
        CURRENT_TIMESTAMP BETWEEN (
            SELECT valid_from FROM user_permissions
            WHERE user_id = current_setting('app.user_id')::INTEGER
              AND resource_type = 'document'
              AND resource_id = sensitive_documents.document_id::VARCHAR
        ) AND (
            SELECT valid_until FROM user_permissions
            WHERE user_id = current_setting('app.user_id')::INTEGER
              AND resource_type = 'document'
              AND resource_id = sensitive_documents.document_id::VARCHAR
        )
    );

-- 鍦扮悊浣嶇疆-based 鏉冮檺
CREATE POLICY geo_based_access ON regional_data
    FOR ALL
    USING (
        ST_Contains(
            (SELECT geom FROM user_regions
             WHERE user_id = current_setting('app.user_id')::INTEGER),
            regional_data.location_geom
        )
    );`}
        {...noteProps('code2')}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鎬ц兘浼樺寲鍜岀洃鎺?/h3>

      <CodeBlock
        title="琛岀骇瀹夊叏鐨勬€ц兘璋冧紭"
        code={`-- 鍒涘缓閮ㄥ垎绱㈠紩浠ヤ紭鍖朢LS鏌ヨ
CREATE INDEX idx_employee_dept ON employee_records(department)
WHERE department IN (
    SELECT department FROM employee_records
    WHERE employee_id = current_setting('app.user_id')::INTEGER
);

-- 涓烘潈闄愭鏌ュ嚱鏁板垱寤虹储寮?
CREATE INDEX idx_user_permissions_lookup
ON user_permissions(user_id, resource_type, resource_id)
WHERE CURRENT_TIMESTAMP BETWEEN valid_from AND valid_until;

-- 棰勮绠楃敤鎴锋潈闄愶紙鐗╁寲瑙嗗浘锛?
CREATE MATERIALIZED VIEW user_effective_permissions AS
SELECT
    up.user_id,
    up.resource_type,
    up.resource_id,
    up.permission_level,
    CASE
        WHEN up.permission_level = 'admin' THEN 3
        WHEN up.permission_level = 'write' THEN 2
        WHEN up.permission_level = 'read' THEN 1
        ELSE 0
    END AS permission_rank
FROM user_permissions up
WHERE CURRENT_TIMESTAMP BETWEEN up.valid_from AND up.valid_until;

-- 瀹氭湡鍒锋柊鏉冮檺瑙嗗浘
CREATE OR REPLACE FUNCTION refresh_user_permissions()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW user_effective_permissions;

    -- 娓呯悊杩囨湡鐨勬潈闄愯褰?
    DELETE FROM user_permissions
    WHERE valid_until < CURRENT_TIMESTAMP - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- 鐩戞帶RLS鎬ц兘
CREATE VIEW rls_performance_monitor AS
SELECT
    schemaname,
    tablename,
    rowsecurity,  -- 鏄惁鍚敤浜哛LS
    policies,     -- 鍏宠仈鐨勭瓥鐣ユ暟閲?
    seq_scan,     -- 椤哄簭鎵弿娆℃暟
    seq_tup_read, -- 椤哄簭鎵弿璇诲彇鐨勮鏁?
    idx_scan,     -- 绱㈠紩鎵弿娆℃暟
    idx_tup_fetch,-- 绱㈠紩鎵弿鑾峰彇鐨勮鏁?
    n_tup_ins,    -- 鎻掑叆琛屾暟
    n_tup_upd,    -- 鏇存柊琛屾暟
    n_tup_del     -- 鍒犻櫎琛屾暟
FROM pg_stat_user_tables
WHERE rowsecurity = true;

-- 鍒嗘瀽绛栫暐鎵ц鏁堢巼
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM employee_records
WHERE department = 'Engineering';

-- RLS绛栫暐鎵ц缁熻
SELECT
    schemaname,
    tablename,
    policyname,
    permissive,  -- 鏄惁涓鸿鍙瓥鐣?
    roles,       -- 閫傜敤鐨勮鑹?
    cmd,         -- 閫傜敤鐨勫懡浠?
    qual,        -- 绛栫暐鏉′欢
    with_check   -- 鎻掑叆/鏇存柊妫€鏌ユ潯浠?
FROM pg_policies
WHERE schemaname = 'public';`}
        {...noteProps('code3')}
      />

      <InfoBox type="tip" title="琛岀骇瀹夊叏鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>绛栫暐璁捐锛?/strong> 瀹夊叏绛栫暐搴旇閬靛惊鏈€灏忔潈闄愬師鍒?/li>
          <li><strong>鎬ц兘鑰冭檻锛?/strong> RLS鍙兘浼氬奖鍝嶆煡璇㈡€ц兘锛岄渶瑕侀€傚綋浼樺寲</li>
          <li><strong>娴嬭瘯楠岃瘉锛?/strong> 纭繚绛栫暐鍦ㄥ悇绉嶅満鏅笅閮借兘姝ｇ‘宸ヤ綔</li>
          <li><strong>瀹¤鏃ュ織锛?/strong> 璁板綍RLS鐩稿叧鐨勮闂拰鎷掔粷鎿嶄綔</li>
          <li><strong>涓婁笅鏂囩鐞嗭細</strong> 瀹夊叏鍦扮鐞嗙敤鎴蜂笂涓嬫枃淇℃伅</li>
          <li><strong>绛栫暐缁勫悎锛?/strong> 澶氫釜绛栫暐鍙互缁勫悎浣跨敤锛屾彁渚涙洿绮剧粏鐨勬帶鍒?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彚 SaaS骞冲彴</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">澶氱鎴锋暟鎹殧绂汇€佺敤鎴锋潈闄愮鐞嗐€佹暟鎹畨鍏?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃彞 鍖荤枟绯荤粺</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鎮ｈ€呮暟鎹殧绂汇€佸尰鐢熸潈闄愬垎绾с€侀殣绉佷繚鎶?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃彟 閲戣瀺鏈嶅姟</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">璐︽埛鏁版嵁闅旂銆佷氦鏄撴潈闄愭帶鍒躲€佸悎瑙勮姹?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃搳 浼佷笟BI</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">閮ㄩ棬鏁版嵁闅旂銆佽鑹?based璁块棶銆佹晱鎰熸暟鎹繚鎶?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓畬鏁寸殑澶氱鎴风郴缁燂紝浣跨敤RLS纭繚鏁版嵁闅旂</p>
          <p><strong>鎸戞垬 2锛?/strong> 鏋勫缓涓€涓熀浜庤鑹茬殑鏉冮檺绠＄悊绯荤粺锛屾敮鎸佸姩鎬佹潈闄愰厤缃?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓紒涓氱骇鏁版嵁瀹夊叏骞冲彴锛岀粨鍚圧LS鍜屽叾浠栧畨鍏ㄦ帾鏂?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鍒楃骇瀹夊叏绔犺妭
// ============================================

export function ColumnLevelSecuritySection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鍒楃骇瀹夊叏</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"淇濇姢鏁忔劅瀛楁鐨勭簿纭帶鍒?</p>

      <Paragraph {...noteProps('p1')}>
        鍒楃骇瀹夊叏鍏佽瀵硅〃涓殑鐗瑰畾鍒楀簲鐢ㄨ闂帶鍒剁瓥鐣ャ€傜敤鎴峰彲鑳借兘澶熻闂煇浜涜锛屼絾鍙兘鐪嬪埌鎴栦慨鏀逛粬浠鎺堟潈鐨勫垪銆傝繖瀵逛簬淇濇姢鏁忔劅淇℃伅锛堝钖祫銆佷釜浜鸿韩浠戒俊鎭瓑锛夌壒鍒湁鐢紝鍚屾椂鍏佽瀵归潪鏁忔劅鏁版嵁杩涜姝ｅ父璁块棶銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍩虹鍒楃骇瀹夊叏</h3>

      <SQLExplainer
        sql={`-- 鍒涘缓鍛樺伐淇℃伅琛?
CREATE TABLE employee_info (
    employee_id INTEGER PRIMARY KEY,
    name VARCHAR NOT NULL,
    department VARCHAR,
    base_salary DECIMAL,
    bonus DECIMAL,
    ssn VARCHAR,        -- 绀句細淇濋櫓鍙凤紝楂樺害鏁忔劅
    medical_records JSONB, -- 鍖荤枟璁板綍锛岄珮搴︽晱鎰?
    performance_rating INTEGER,
    hire_date DATE
);

-- 鍒涘缓瑙嗗浘瀹炵幇鍒楃骇瀹夊叏
CREATE VIEW employee_public AS
SELECT
    employee_id,
    name,
    department,
    performance_rating,
    hire_date
FROM employee_info;

-- 缁忕悊瑙嗗浘锛堝彲鏌ョ湅钖祫浣嗕笉鑳芥煡鐪嬫晱鎰熶俊鎭級
CREATE VIEW employee_manager AS
SELECT
    employee_id,
    name,
    department,
    base_salary,
    bonus,
    performance_rating,
    hire_date
FROM employee_info;

-- HR瑙嗗浘锛堝彲鏌ョ湅鎵€鏈変俊鎭級
CREATE VIEW employee_hr AS
SELECT * FROM employee_info;

-- 鏍规嵁鐢ㄦ埛瑙掕壊杩斿洖鐩稿簲瑙嗗浘
CREATE OR REPLACE FUNCTION get_employee_data(user_role VARCHAR)
RETURNS TABLE (
    employee_id INTEGER,
    name VARCHAR,
    department VARCHAR,
    base_salary DECIMAL,
    bonus DECIMAL,
    ssn VARCHAR,
    medical_records JSONB,
    performance_rating INTEGER,
    hire_date DATE
) AS $$
BEGIN
    CASE user_role
        WHEN 'hr' THEN
            RETURN QUERY SELECT * FROM employee_hr;
        WHEN 'manager' THEN
            RETURN QUERY SELECT
                employee_id, name, department, base_salary, bonus,
                NULL::VARCHAR, NULL::JSONB, performance_rating, hire_date
            FROM employee_manager;
        ELSE
            RETURN QUERY SELECT
                employee_id, name, department, NULL::DECIMAL, NULL::DECIMAL,
                NULL::VARCHAR, NULL::JSONB, performance_rating, hire_date
            FROM employee_public;
    END CASE;
END;
$$ LANGUAGE plpgsql;

-- 浣跨敤绀轰緥
SELECT * FROM get_employee_data('employee');  -- 鍙湅鍒板叕鍏变俊鎭?
SELECT * FROM get_employee_data('manager');   -- 鍙湅鍒拌柂璧勪俊鎭?
SELECT * FROM get_employee_data('hr');        -- 鍙湅鍒版墍鏈変俊鎭痐}
        explanations={[
          { code: 'CREATE VIEW employee_public AS', explanation: '鍒涘缓鍏紑瑙嗗浘锛屽彧鍖呭惈闈炴晱鎰熷垪', tip: '鍩虹鐨勫垪绾у畨鍏ㄥ疄鐜版柟寮? },
          { code: 'CREATE VIEW employee_manager AS', explanation: '缁忕悊瑙嗗浘锛屽寘鍚柂璧勪絾鎺掗櫎鏁忔劅淇℃伅', tip: '涓嶅悓瑙掕壊鐪嬪埌涓嶅悓鍒? },
          { code: 'get_employee_data(user_role)', explanation: '鏍规嵁鐢ㄦ埛瑙掕壊鍔ㄦ€佽繑鍥炵浉搴旀暟鎹?, tip: '杩愯鏃剁‘瀹氬垪绾ф潈闄? },
        ]}
      />

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鍔ㄦ€佸垪 masking</h3>

      <CodeBlock>
        <title>楂樼骇鍒楃骇鏁版嵁鑴辨晱</title>
        <code>{`-- 鍒楁潈闄愰厤缃〃
CREATE TABLE column_permissions (
    role_name VARCHAR,
    table_name VARCHAR,
    column_name VARCHAR,
    permission_type VARCHAR, -- 'allow', 'mask', 'deny'
    mask_function VARCHAR,   -- 鑴辨晱鍑芥暟鍚?
    PRIMARY KEY (role_name, table_name, column_name)
);

-- 鎻掑叆鏉冮檺閰嶇疆
INSERT INTO column_permissions VALUES
    ('employee', 'employee_info', 'base_salary', 'deny', NULL),
    ('employee', 'employee_info', 'bonus', 'deny', NULL),
    ('employee', 'employee_info', 'ssn', 'mask', 'mask_ssn'),
    ('manager', 'employee_info', 'ssn', 'deny', NULL),
    ('manager', 'employee_info', 'medical_records', 'deny', NULL),
    ('hr', 'employee_info', 'ssn', 'allow', NULL),
    ('hr', 'employee_info', 'medical_records', 'allow', NULL);

-- 鑴辨晱鍑芥暟
CREATE OR REPLACE FUNCTION mask_ssn(ssn_value VARCHAR)
RETURNS VARCHAR AS $$
BEGIN
    IF ssn_value IS NULL THEN
        RETURN NULL;
    END IF;
    -- 淇濈暀鏈€鍚?浣嶏紝鍓嶉潰鐨勭敤*鏇挎崲
    RETURN '***-**-' || RIGHT(ssn_value, 4);
END;
$$ LANGUAGE plpgsql;

-- 鍔ㄦ€佹煡璇㈡瀯寤哄嚱鏁?
CREATE OR REPLACE FUNCTION build_secure_query(
    base_table VARCHAR,
    user_role VARCHAR
) RETURNS TEXT AS $$
DECLARE
    select_clause TEXT := '';
    column_record RECORD;
BEGIN
    -- 鏋勫缓SELECT瀛愬彞
    FOR column_record IN
        SELECT
            c.column_name,
            COALESCE(cp.permission_type, 'allow') AS permission_type,
            cp.mask_function
        FROM information_schema.columns c
        LEFT JOIN column_permissions cp ON
            cp.table_name = c.table_name
            AND cp.column_name = c.column_name
            AND cp.role_name = user_role
        WHERE c.table_name = base_table
        ORDER BY c.ordinal_position
    LOOP
        IF column_record.permission_type = 'deny' THEN
            -- 瀹屽叏鎷掔粷璁块棶璇ュ垪
            select_clause := select_clause || 'NULL AS ' || column_record.column_name || ', ';
        ELSIF column_record.permission_type = 'mask' AND column_record.mask_function IS NOT NULL THEN
            -- 搴旂敤鑴辨晱鍑芥暟
            select_clause := select_clause || column_record.mask_function || '(' || column_record.column_name || ') AS ' || column_record.column_name || ', ';
        ELSE
            -- 鍏佽璁块棶
            select_clause := select_clause || column_record.column_name || ', ';
        END IF;
    END LOOP;

    -- 绉婚櫎鏈€鍚庣殑閫楀彿鍜岀┖鏍?
    select_clause := rtrim(select_clause, ', ');

    RETURN 'SELECT ' || select_clause || ' FROM ' || base_table;
END;
$$ LANGUAGE plpgsql;

-- 鐢熸垚骞舵墽琛屽畨鍏ㄦ煡璇?
SELECT build_secure_query('employee_info', 'employee');
-- 缁撴灉锛歋ELECT NULL AS base_salary, NULL AS bonus, mask_ssn(ssn) AS ssn, ... FROM employee_info

-- 鎵ц鍔ㄦ€佺敓鎴愮殑鏌ヨ
EXECUTE build_secure_query('employee_info', 'manager');`}</code>
      </CodeBlock>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹夊叏绛栫暐涓庡璁?/h3>

      <CodeBlock>
        <title>鍒楃骇瀹夊叏绛栫暐鍜岀洃鎺?/title>
        <code>{`-- 鏁忔劅鏁版嵁鍒嗙被琛?
CREATE TABLE data_classification (
    table_name VARCHAR,
    column_name VARCHAR,
    sensitivity_level VARCHAR, -- 'public', 'internal', 'confidential', 'restricted'
    data_category VARCHAR,     -- 'pii', 'financial', 'medical', 'proprietary'
    retention_policy VARCHAR,  -- 鏁版嵁淇濈暀绛栫暐
    PRIMARY KEY (table_name, column_name)
);

-- 鍩轰簬鏁忔劅搴︾殑璁块棶鎺у埗绛栫暐
CREATE OR REPLACE FUNCTION check_column_access(
    p_user_role VARCHAR,
    p_table_name VARCHAR,
    p_column_name VARCHAR,
    p_access_type VARCHAR DEFAULT 'read'
) RETURNS BOOLEAN AS $$
DECLARE
    sensitivity_level VARCHAR;
    allowed_roles TEXT[];
BEGIN
    -- 鑾峰彇鍒楃殑鏁忔劅搴︾骇鍒?
    SELECT dc.sensitivity_level INTO sensitivity_level
    FROM data_classification dc
    WHERE dc.table_name = p_table_name
      AND dc.column_name = p_column_name;

    IF sensitivity_level IS NULL THEN
        sensitivity_level := 'public'; -- 榛樿鍏紑
    END IF;

    -- 鏍规嵁鏁忔劅搴﹀畾涔夊厑璁哥殑瑙掕壊
    allowed_roles := CASE sensitivity_level
        WHEN 'public' THEN ARRAY['employee', 'manager', 'hr', 'admin']
        WHEN 'internal' THEN ARRAY['manager', 'hr', 'admin']
        WHEN 'confidential' THEN ARRAY['hr', 'admin']
        WHEN 'restricted' THEN ARRAY['admin']
        ELSE ARRAY[]::TEXT[]
    END;

    -- 妫€鏌ョ敤鎴疯鑹叉槸鍚﹁鍏佽
    RETURN p_user_role = ANY(allowed_roles);
END;
$$ LANGUAGE plpgsql;

-- 瀹¤鏁忔劅鏁版嵁璁块棶
CREATE TABLE column_access_audit (
    audit_id SERIAL PRIMARY KEY,
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_role VARCHAR,
    user_id INTEGER,
    table_name VARCHAR,
    column_name VARCHAR,
    access_type VARCHAR, -- 'read', 'write', 'mask'
    record_count INTEGER,
    client_ip VARCHAR,
    query_text TEXT
);

-- 璁板綍鍒楄闂殑瑙﹀彂鍣ㄥ嚱鏁?
CREATE OR REPLACE FUNCTION audit_column_access()
RETURNS TRIGGER AS $$
BEGIN
    -- 妫€鏌ユ槸鍚︽湁鏁忔劅鍒楄璁块棶
    IF EXISTS (
        SELECT 1 FROM data_classification dc
        WHERE dc.table_name = TG_TABLE_NAME
          AND dc.sensitivity_level IN ('confidential', 'restricted')
          AND dc.column_name IN (
              SELECT column_name FROM information_schema.columns
              WHERE table_name = TG_TABLE_NAME
          )
    ) THEN
        INSERT INTO column_access_audit (
            user_role, user_id, table_name, access_type,
            record_count, query_text
        ) VALUES (
            current_setting('app.user_role', true),
            current_setting('app.user_id', true)::INTEGER,
            TG_TABLE_NAME,
            TG_OP,
            CASE WHEN TG_OP = 'DELETE' THEN 1 ELSE 0 END,
            current_query()
        );
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- 涓烘晱鎰熻〃娣诲姞瀹¤瑙﹀彂鍣?
CREATE TRIGGER audit_sensitive_access
    AFTER SELECT OR INSERT OR UPDATE OR DELETE ON employee_info
    FOR EACH STATEMENT EXECUTE FUNCTION audit_column_access();

-- 鍚堣鎶ュ憡锛氭晱鎰熸暟鎹闂粺璁?
SELECT
    user_role,
    table_name,
    column_name,
    access_type,
    COUNT(*) AS access_count,
    MIN(access_time) AS first_access,
    MAX(access_time) AS last_access
FROM column_access_audit ca
JOIN data_classification dc ON
    ca.table_name = dc.table_name
WHERE dc.sensitivity_level IN ('confidential', 'restricted')
  AND ca.access_time >= CURRENT_TIMESTAMP - INTERVAL '30 days'
GROUP BY user_role, table_name, column_name, access_type
ORDER BY access_count DESC;

-- 寮傚父妫€娴嬶細涓嶅甯哥殑璁块棶妯″紡
WITH user_access_patterns AS (
    SELECT
        user_id,
        DATE_TRUNC('hour', access_time) AS hour_slot,
        COUNT(*) AS accesses_per_hour
    FROM column_access_audit
    WHERE access_time >= CURRENT_TIMESTAMP - INTERVAL '7 days'
      AND table_name IN (SELECT table_name FROM data_classification WHERE sensitivity_level = 'restricted')
    GROUP BY user_id, DATE_TRUNC('hour', access_time)
)
SELECT
    user_id,
    hour_slot,
    accesses_per_hour,
    AVG(accesses_per_hour) OVER (PARTITION BY user_id) AS avg_accesses,
    CASE
        WHEN accesses_per_hour > AVG(accesses_per_hour) OVER (PARTITION BY user_id) * 3 THEN '寮傚父楂橀'
        WHEN accesses_per_hour < AVG(accesses_per_hour) OVER (PARTITION BY user_id) * 0.1 THEN '寮傚父浣庨'
        ELSE '姝ｅ父'
    END AS access_pattern
FROM user_access_patterns
WHERE accesses_per_hour != AVG(accesses_per_hour) OVER (PARTITION BY user_id)
ORDER BY hour_slot DESC;`}</code>
      </CodeBlock>

      <InfoBox type="tip" title="鍒楃骇瀹夊叏鏈€浣冲疄璺? {...noteProps('box1')}>
        <ul className="list-disc ml-4 space-y-1">
          <li><strong>鏁版嵁鍒嗙被锛?/strong> 鏄庣‘瀹氫箟鏁版嵁鐨勬晱鎰熷害绾у埆鍜屽垎绫?/li>
          <li><strong>鏈€灏忔潈闄愶細</strong> 鐢ㄦ埛鍙兘璁块棶瀹屾垚宸ヤ綔鎵€闇€鐨勫垪</li>
          <li><strong>鑴辨晱绛栫暐锛?/strong> 瀵归儴鍒嗚闂殑鏁忔劅鏁版嵁杩涜閫傚綋鑴辨晱</li>
          <li><strong>瀹¤鐩戞帶锛?/strong> 璁板綍鎵€鏈夊鏁忔劅鍒楃殑璁块棶鎿嶄綔</li>
          <li><strong>鎬ц兘浼樺寲锛?/strong> 閬垮厤鍦ㄦ煡璇㈡椂杩涜澶嶆潅鐨勬暟鎹浆鎹?/li>
          <li><strong>绛栫暐缁存姢锛?/strong> 瀹氭湡瀹℃煡鍜屾洿鏂板畨鍏ㄧ瓥鐣?/li>
        </ul>
      </InfoBox>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">瀹為檯搴旂敤鍦烘櫙</h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
        <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <h4 className="font-bold text-blue-700 dark:text-blue-300 mb-2">馃彟 閲戣瀺鏁版嵁</h4>
          <p className="text-sm text-blue-600 dark:text-blue-400">钖祫淇℃伅淇濇姢銆佷氦鏄撴槑缁嗛殧绂汇€佽处鎴蜂綑棰濆畨鍏?/p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <h4 className="font-bold text-green-700 dark:text-green-300 mb-2">馃彞 鍖荤枟璁板綍</h4>
          <p className="text-sm text-green-600 dark:text-green-400">鎮ｈ€呴殣绉佷繚鎶ゃ€佸尰鐤楀巻鍙查殧绂汇€佽瘖鏂俊鎭畨鍏?/p>
        </div>
        <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <h4 className="font-bold text-purple-700 dark:text-purple-300 mb-2">馃搳 鍟嗕笟鏅鸿兘</h4>
          <p className="text-sm text-purple-600 dark:text-purple-400">鏁忔劅鎸囨爣淇濇姢銆佺珵浜夋儏鎶ラ殧绂汇€佹垬鐣ユ暟鎹畨鍏?/p>
        </div>
        <div className="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-700">
          <h4 className="font-bold text-amber-700 dark:text-amber-300 mb-2">馃攼 鏀垮簻鏁版嵁</h4>
          <p className="text-sm text-amber-600 dark:text-amber-400">鍏皯淇℃伅淇濇姢銆佸浗瀹跺畨鍏ㄦ暟鎹€佹満瀵嗘枃浠堕殧绂?/p>
        </div>
      </div>

      <InfoBox type="experiment" title="鍔ㄦ墜缁冧範" {...noteProps('box2')}>
        <div className="space-y-2">
          <p><strong>鎸戞垬 1锛?/strong> 瀹炵幇涓€涓畬鏁寸殑鍒楃骇瀹夊叏绯荤粺锛屾敮鎸佸绉嶈劚鏁忕瓥鐣?/p>
          <p><strong>鎸戞垬 2锛?/strong> 鏋勫缓涓€涓暟鎹垎绫诲拰璁块棶鎺у埗骞冲彴锛屾敮鎸佸姩鎬佹潈闄愰厤缃?/p>
          <p><strong>鎸戞垬 3锛?/strong> 鍒涘缓涓€涓晱鎰熸暟鎹洃鎺у拰瀹¤绯荤粺锛屾敮鎸佸悎瑙勬姤鍛婄敓鎴?/p>
        </div>
      </InfoBox>
    </div>
  );
}

// ============================================
// 鏌ヨ璁″垝绔犺妭
// ============================================

export function QueryPlansSection({ sectionId, addNote, updateNote, deleteNote, getNotesForBlock }: SectionProps) {
  const noteProps = (blockId: string) => ({
    sectionId,
    blockId,
    notes: getNotesForBlock(sectionId, blockId),
    onAddNote: (content: string) => addNote(sectionId, blockId, content),
    onUpdateNote: updateNote,
    onDeleteNote: deleteNote,
  });

  return (
    <div>
      <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">鏌ヨ璁″垝</h2>
      <p className="text-lg text-slate-500 dark:text-slate-400 mb-8 italic">"SQL 鎵ц鐨勮矾绾垮浘"</p>

      <Paragraph {...noteProps('p1')}>
        鏌ヨ璁″垝鏄暟鎹簱鎵цSQL鏌ヨ鏃剁殑璇︾粏鎵ц鏂规銆傚畠鎻忚堪浜嗘暟鎹簱濡備綍璁块棶鏁版嵁銆佷娇鐢ㄥ摢浜涚储寮曘€佸浣曡繛鎺ヨ〃銆佷娇鐢ㄤ粈涔堢畻娉曠瓑銆傜悊瑙ｆ煡璇㈣鍒掓槸浼樺寲鏌ヨ鎬ц兘鐨勫叧閿紝鑳藉甯姪璇嗗埆鎬ц兘鐡堕骞堕€夋嫨鏈€浣崇殑鎵ц绛栫暐銆?
      </Paragraph>

      <h3 className="text-xl font-semibold text-slate-700 dark:text-slate-200 mt-8 mb-4">鏌ョ湅鏌ヨ璁″垝</h3>

      <SQLExplainer
        sql={`-- 鍩烘湰鏌ヨ璁″垝鏌ョ湅
EXPLAIN SELECT * FROM users WHERE age > 25;

-- 璇︾粏鎵ц璁″垝锛堝寘鎷疄闄呮墽琛岀粺璁★級
EXPLAIN ANALYZE SELECT * FROM users WHERE age > 25;

-- 甯︾紦鍐插尯淇℃伅鐨勮缁嗗垎鏋?
EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM users WHERE age > 25;`}

